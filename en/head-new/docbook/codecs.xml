<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<chapter id="codecs" lang="en" revision="$Revision: 1381 $">
  <!--% Copyright (c) 2007 - Stefan Wintermeyer <sw@amooma.de>
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
-->

  <!--% translated from the German by Stephen Bosch <sbosch@vodacomm.ca>-->

  <!--% Asterisk training and consulting is offered at http://www.amooma.de-->

  <title>Codecs</title>

  <indexterm>
    <primary>Codecs</primary>
  </indexterm>

  <section id="codecs-einleitung">
    <title>Introduction</title>

    <para>A discussion of codecs, as they are used in telephony, will put
    someone on one of two sides of a large mountain. On one side of of the
    mountain, we have the situation in North America, which has very little
    ISDN penetration, at least at the retail level. The average North American
    telephone customer has only ever used analog telephones, and so the stack
    of digital codecs is seen from the base of a mountain yet to be scaled: at
    the summit are an appealing array of digital codecs which offer
    exceptional sound quality, but represent the unknown.</para>

    <para>On the other side of the mountain, we have the situation in Europe,
    where ISDN has been ubiquitous for so long that analog seems like the dark
    ages and nobody thinks twice about codecs or call quality. The average
    European telephone customer under the age of 35 has only ever used digital
    telephones, and so the stack of digital codecs is seen from a mountain she
    has already been to: the summit was nice, we took some pictures, now let's
    make phone calls.</para>

    <para>In either case, the codecs are far from the surface of anyone's
    consciousness. Nevertheless, choice of codecs has implications for
    Asterisk implementation. Whether you are in North America, Europe, or
    elsewhere in the world, you will still be faced with this choice.</para>

    <para>As a general guideline, the most common digital codec used in
    telephony is the ISDN codec G.711 (alaw or ulaw companding, ulaw<footnote>
        <simpara>actually, this is µ-law (the Greek letter my, used in physics
        as a prefix representing "micro")</simpara>
      </footnote> is used in the United States and Japan, while alaw is the
    standard in Europe).</para>

    <para>A final note to the differences: the limited use of digital
    telephony in the United States is at least part of the reason why VoIP has
    caught on much more there. The sound quality offered by a clean, IP-based
    connection is often vastly superior to that of the aging analog
    infrastructure.</para>
  </section>

  <section id="codecs-beschreibung">
    <title>What does a codec do?</title>

    <para>Simply put, a codec takes an analog audio signal and converts it
    into a digital bitstream. This consists of a series of steps which begin
    with digitizing the signal into a time-coded bitstream, then taking this
    bitstream and compressing it using a compression algorithm, so that it
    uses less bandwidth when transmitted. This compression can be nearly
    <emphasis>lossless</emphasis> (<emphasis>e.g.</emphasis> G.711)<footnote>
        <simpara>even "nearly lossless" is a relative distinction,
        however.</simpara>
      </footnote> or <emphasis>lossy</emphasis> (<emphasis>e.g.</emphasis>
    GSM). Without a codec, no audio can be transmitted. Which codec one ought
    to choose depends on the bandwidth available, as well as the available
    processing capacity. Use of any codec is always a compromise between these
    two considerations.</para>

    <para>This chapter will not cover the function of codecs in too much
    detail. The interested reader is directed to look at the Wikipedia
    articles covering the various codecs, as well as the articles on
    companding, alaw, and ulaw. For our purposes, an overview should
    suffice.</para>
  </section>

  <section id="codecs-performance">
    <title>Performance</title>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Performance</secondary>
    </indexterm>

    <para>The biggest problem with high-compression codecs is the processing
    they require. Using the Asterisk console, enter the command <command>core
    show translation</command> to see a table of the actual transcoding times
    required for the various codecs:<screen>debian*CLI&gt; core show translation
         Translation times between formats (in milliseconds) for one second of data
          Source Format (Rows) Destination Format (Columns)

          g723 gsm ulaw alaw g726aal2 adpcm slin lpc10 g729 speex ilbc g726 g722
     g723    -   -    -    -        -     -    -     -    -     -    -    -    -
      gsm    -   -    2    2        3     2    1     9    -    34   26    3    -
     ulaw    -   6    -    1        3     2    1     9    -    34   26    3    -
     alaw    -   6    1    -        3     2    1     9    -    34   26    3    -
 g726aal2    -   7    3    3        -     3    2    10    -    35   27    1    -
    adpcm    -   6    2    2        3     -    1     9    -    34   26    3    -
     slin    -   5    1    1        2     1    -     8    -    33   25    2    -
    lpc10    -   9    5    5        6     5    4     -    -    37   29    6    -
     g729    -   -    -    -        -     -    -     -    -     -    -    -    -
    speex    -  13    9    9       10     9    8    16    -     -   33   10    -
     ilbc    -   9    5    5        6     5    4    12    -    37    -    6    -
     g726    -   7    3    3        1     3    2    10    -    35   27    -    -
     g722    -   -    -    -        -     -    -     -    -     -    -    -    -
debian*CLI&gt;</screen></para>

    <para>Codecs not available on your system are marked with a dash ("-"). It
    is easy to see which codec demands the most processing resources: it is
    <code>speex</code>.</para>

    <para>To minimize load, you should use the minimum possible number of
    codecs. If set A and set B both use the same codec in a call to each
    other, Asterisk need only pass through the packets. If set A and set B use
    different codecs, Asterisk has to transcode each packet, which involves
    decoding the incoming packet, then encoding it using the other codec
    before sending it out to the destination set, and it has to do this in
    <emphasis>each direction</emphasis>. You can see how this becomes onerous
    quickly.</para>
  </section>

  <section id="codecs-konfiguration">
    <title>Configuring codecs</title>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Konfiguration</secondary>
    </indexterm>

    <para>How codecs are configured depends on the technology. IAX sets are
    configured in <filename>iax.conf</filename> and SIP sets are configured in
    <filename>sip.conf</filename>. If you want to set all SIP sets to use
    G.711, then you would write the following in
    <filename>sip.conf</filename>:<programlisting>[general]
disallow=all
allow=alaw
allow=ulaw</programlisting></para>

    <para>If you have a specific telephone (call it 2000) that should only use
    GSM, you can set this like so :<programlisting>[general]
disallow=all
allow=alaw
allow=ulaw

[2000]
disallow=all
allow=gsm</programlisting></para>
  </section>

  <section id="die-wichtigsten-codecs">
    <title>The important codecs</title>

    <para>The CLI command <command>core show translation</command>, which
    displays the table seen above, will show you which codecs are available on
    your system: namely, all those with numbers in their respective columns.
    This list will briefly examine the most commonly used codecs in
    Asterisk:</para>

    <itemizedlist>
      <listitem>
        <para>GSM<indexterm>
            <primary>Codecs</primary>

            <secondary>GSM</secondary>
          </indexterm></para>

        <para>An Asterisk "classic", and familiar to anyone with GSM mobile
        phone service. The bandwidth is 13.3 kbps and the quality is
        acceptable, if not exactly overwhelming.</para>
      </listitem>

      <listitem>
        <para>iLBC<indexterm>
            <primary>Codecs</primary>

            <secondary>iLBC</secondary>
          </indexterm></para>

        <para>iLBC is a sort of "secret weapon" for use in low-bandwidth
        situations. The sound quality is excellent and the bandwidth is
        limited to between 13.3 and 15 kbps (depending on frame size). Skype
        uses a variant of this codec. The problem with iLBC is that is
        processor-intensive; that is also why it is not implemented in very
        many hardphones.</para>
      </listitem>

      <listitem>
        <para>G.711<indexterm>
            <primary>Codecs</primary>

            <secondary>G.711</secondary>
          </indexterm></para>

        <para>Another classic, from the suite of ISDN codecs. This codec
        offers superb sound quality and requires 64 kbps of bandwidth. This is
        standard for most calls travelling in corporate intranets and is also
        widely used for calls over the public Internet.</para>
      </listitem>

      <listitem>
        <para>G.722<indexterm>
            <primary>Codecs</primary>

            <secondary>G.722</secondary>
          </indexterm></para>

        <para>The chances are good that G.722 will eventually replace G.711;
        at the highest resolution, it offers a much better sound quality than
        G.711, but while requiring the same bandwidth (only 64 kbps).
        Unfortunately, it not, as yet, supported by many telephones.</para>
      </listitem>

      <listitem>
        <para>G.726<indexterm>
            <primary>Codecs</primary>

            <secondary>G.726</secondary>
          </indexterm></para>

        <para>Offers the same sound quality as G.711 while needing only half
        the bandwidth (32 kbps). In contrast to G.711, only the data that has
        changed relative to the previous voice packet is transmitted (this is
        similar to the way MPEG video works). The result is the same
        information transmitted with half the bandwidth. G.726 is not too
        burdensome, but still requires more processing than G.711.</para>
      </listitem>

      <listitem>
        <para>G.729a<indexterm>
            <primary>Codecs</primary>

            <secondary>G.729a</secondary>
          </indexterm></para>

        <para>G.729a is a patented codec which needs only 8 Kbps and offers
        sound quality comparable to GSM. Licenses for Asterisk can be
        purchased from <ulink
        url="http://www.digium.com"><citetitle>Digium</citetitle></ulink>. It
        is not exceptional either in voice quality or performance, but offers
        a fair balance and is implemented in many VoIP telephones. As such it
        is a good option when you need to conserve bandwidth.</para>
      </listitem>

      <listitem>
        <para>G.729.1<indexterm>
            <primary>Codecs</primary>

            <secondary>G.729.1</secondary>
          </indexterm></para>

        <para>G.729.1 is an extension offering bitstream interoperability with
        existing G.729 codecs, as well as a high level of configurability (it
        supports 8 to 32 kbps streams). Of particular interest are the
        wideband extensions, which can offer very close to CD quality sound;
        as yet, only a few phones support them. In order to use the wideband
        extensions, all the devices in the media path must support
        them.</para>
      </listitem>
    </itemizedlist>
  </section>

  <section id="codecs-trunking">
    <title>Bandwidth and trunking</title>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Bandwidth</secondary>
    </indexterm>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Trunking</secondary>
    </indexterm>

    <para>Anyone wishing to pass multiple simultaneous calls over a network
    connection (e.g. when two Asterisk systems are connected to each other)
    will soon have a bandwidth problem. Depending on the constellation of
    codec and frame size, it is easily possible for the IP overhead to exceed
    the payload. For example, using SIP and GSM on a 2 Mbps data connection,
    you can support a maximum of 35 simultaneous calls, which isn't exactly a
    lot. In such a case, you would be better served by an ISDN PRI, where the
    sound quality will be significantly better.</para>

    <para>Trunking is great because it lets you wrap multiple voice chunks in
    a single connection, so that you are not incurring an overhead penalty for
    each call. In our example above using the same 2 Mbps connection, we can
    support 77 simultaneous GSM calls. If we wanted to improve the sound
    quality, we could do this and still 44 G.726 calls.</para>

    <para>Trunking is only supported in IAX2 (see <xref linkend="iax" />) and
    should only be used with at least two simultaneous calls, since the
    overhead for a single call would be measurably higher than without
    trunking.</para>

    <para>If you want to assess your bandwidth requirements more closely, see
    the bandwidth calculator at <ulink
    url="http://www.asteriskguru.com/tools/bandwidth_calculator.php"><citetitle>http://www.asteriskguru.com/tools/bandwidth_calculator.php</citetitle></ulink>
    and try out various scenarios.</para>
  </section>
</chapter>
