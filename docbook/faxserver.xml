<?xml version="1.0" encoding="ISO-8859-1"?>
<chapter id="faxserver" lang="de" revision="$Revision: 1.9 $">
  <!--% Copyright (c) 2006
% - Stefan Wintermeyer <sw@amooma.de>
% - Mathias Päzolt <mathias@paezolt.de>
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
% Asterisk training and consulting is offered at http://www.amooma.de -->

  <title>Asterisk als Faxserver</title>

  <para>Es gibt eine Reihe von Ansätzen und Projekten, mit Asterisk einen
  Faxserver zu implementieren. Lange Zeit war app_rxfax von <ulink
  url="http://www.soft-switch.org/"><citetitle>http://www.soft-switch.org/</citetitle></ulink>
  die von vielen angepriesene Lösung. Allerdings gilt diese Variante als
  fehleranfällig. Faxe werden regelmäßig unvollständig übertragen.</para>

  <para>Deshalb beschreiben wir hier das Projekt iaxmodem (siehe <ulink
  url="http://iaxmodem.sourceforge.net/"><citetitle>http://iaxmodem.sourceforge.net/</citetitle></ulink>).
  Das iaxmodem ist ein virtuelles Modem, das von einer beliebigen Faxsoftware
  angesteuert werden kann. Für die Faxserversoftware nehmen wir das populäre
  <ulink
  url="http://www.hylafax.org/"><citetitle>Hylafax</citetitle></ulink>.</para>

  <section id="installation-iaxmodem">
    <title>Installation iaxmodem</title>

    <para>IAXmodem ist eine Software, die ein Modem simuliert, und dieses
    Asterisk mit dem IAX2-Protokoll zur Verfügung stellt. Alle Schritte in
    diesem Kapitel werden als User root ausgeführt.</para>

    <para>Um IAXmodem installieren zu können, benötigen wir noch einige
    Debian-Packete die mit <command>apt-get -y install g++ libtiff-tools
    libtiff4 libtiff4-dev</command> installiert werden.</para>

    <screen>debian:~# apt-get -y install g++ libtiff-tools libtiff4 libtiff4-devyyy123yyysw
Paketlisten werden gelesen... Fertigyyy123yyysw
Abhängigkeitsbaum wird aufgebaut... Fertigyyy123yyysw
Die folgenden zusätzlichen Pakete werden installiert:yyy123yyysw
  g++ libjpeg62 libjpeg62-dev libtiffxx0 zlib1g-devyyy123yyysw
yyy123yyysw
[...]yyy123yyysw
yyy123yyysw
Richte zlib1g-dev ein (1.2.2-4.sarge.2) ...yyy123yyysw
Richte libtiff4-dev ein (3.7.2-7) ...yyy123yyysw
yyy123yyysw
debian:~# yyy123yyysw
</screen>

    <para>Die Sourcen zu IAXmodem können auf der Webseite <citetitle><ulink
    url="http://iaxmodem.sourceforge.net">http://iaxmodem.sourceforge.net</ulink></citetitle>
    runtergeladen werden (in diesem Beispiel ist es die Version 0.1.16). Nach
    dem Download muss der TarBall mit <command>tar -xzf
    iaxmodem-0.1.16.tar.gz</command> enpackt werden. Das Kompilieren geschieht
    danach mit mit den Befehlen <command>./configure</command> und
    <command>make</command>. Das dabei entstehende Binary iaxmodem kopieren
    wir zum Schluss mit <command>cp iaxmodem /usr/bin</command> nach
    <filename><filename>/usr/bin</filename></filename></para>

    <para><screen>debian:~# tar xfz iaxmodem-0.1.16.tar.gzyyy123yyysw
debian:~# cd iaxmodem-0.1.16yyy123yyysw
debian:~# ./configureyyy123yyysw
debian:~# makeyyy123yyysw
debian:~# cp iaxmodem /usr/binyyy123yyysw
</screen></para>

    <para>Jetzt kommen wir zur Konfiguration des Modems. IAXmodem sucht seine
    Konfiguration im Verzeichnis <filename>/etc/iaxmodem</filename>. Dieses
    müssen wir jetzt anlegen und in ihm eine Datei erzeugen, in der die
    Konfiguration steht. In dieser Datei müssen folgende Parameter angegeben
    werden:</para>

    <para><variablelist termlength="9">
        <varlistentry>
          <term><code>device</code></term>

          <listitem>
            <simpara>Das ist das Device, das im <filename>/dev</filename>
            Verzeichnis angelegt wird. Über dieses Device kann später HylaFax
            auf das Modem zugreifen. Der Name des Devices ist frei wählbar,
            wir halten uns aber an die allgemeinen Konventionen und nennen es
            äquivalent zum Device für die serielle Schnittstelle
            ttyIAX0.</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>owner</code></term>

          <listitem>
            <simpara>Das ist der Eigentümer des Devices in der Form
            <code><replaceable>user</replaceable>:<replaceable>group</replaceable></code>.
            Es sollte der selbe User und die selbe Gruppe sein, unter der
            HylaFax laufen soll.</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>port</code></term>

          <listitem>
            <simpara>Der Port, auf dem das iaxmodem lauscht. Da Asterisk auf
            Port 4569 auf IAX2-Verbindungen hört, sollte man hier einen
            anderen Port verwenden, z.B. 4570.</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>refresh</code></term>

          <listitem>
            <simpara>Das Intervall, nach dem sich das Modem erneut bei
            Asterisk registriert. Wenn dieses auf 0 steht, registriert sich
            das Modem nicht bei Asterisk.</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>server</code></term>

          <listitem>
            <simpara>Der Server, auf dem der Asterisk läuft. Wenn der Server
            der selbe ist, auf dem auch das iaxmodem läuft, steht hier die
            lokale Adresse 127.0.0.1</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>peername</code></term>

          <listitem>
            <simpara>Der Name, unter dem sich das IAXmodem bei Asterisk
            registriert.</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>secret</code></term>

          <listitem>
            <simpara>Das Passwort zur Registrierung am Asterisk.</simpara>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><code>codec</code></term>

          <listitem>
            <simpara>Der Codec, der vom iaxmodem verwendet wird. Erlaubt sind
            hier <code>alaw</code>, <code>ulaw</code> und
            <code>slinear</code>. Andere machen hier auch wenig Sinn, da diese
            komprimieren und die Übertragung dadurch nicht verlustfrei ist.
            Bei reiner Sprachübertragung wirkt sich das für einen Menschen
            nicht negativ aus, bei Faxübertragungen aber hätte es störende
            Fehler zur Folge.</simpara>
          </listitem>
        </varlistentry>
      </variablelist></para>

    <para>Die Konfigurationsdatei für ttyIAX0 heißt
    <filename>/etc/iaxmodem/ttyIAX0</filename> und hat folgenden
    Inhalt:<screen>device          /dev/ttyIAX0yyy123yyysw
owner           uucp:uucpyyy123yyysw
mode            660yyy123yyysw
port            4570yyy123yyysw
refresh         300yyy123yyysw
server          127.0.0.1yyy123yyysw
peername        iaxmodemyyy123yyysw
secret          passwordyyy123yyysw
codec           alawyyy123yyysw
</screen></para>

    <para>Nachdem das IAXmodem nun fertig konfiguriert ist, muss es gestartet
    werden. Der Start geschieht am besten über den init-Prozess. Also fügen
    wir folgenden Eintrag der Datei <filename>/etc/inittab</filename>
    hinzu:<screen>IA00:23:respawn:/usr/bin/iaxmodem ttyIAX0yyy123yyysw</screen></para>

    <para>Wobei <parameter>ttyIAX0</parameter> der Name der
    Konfigurationsdatei unter <filename>/etc/iaxmodem</filename> ist. Mit dem
    Kommando <command>init q</command> aktivieren wir das neue Device.</para>
  </section>

  <section id="installation-hylafax">
    <title>Installation HylaFax</title>

    <para>Bevor die Faxserversoftware gebaut werden kann, müssen mit
    <command>apt-get -y install libtiff-tools libtiff4 libtiff4-dev
    gs</command> noch ein paar Debian-Pakete installiert werden:<screen>debian:~# apt-get -y install libtiff-tools libtiff4 libtiff4-dev gsyyy123yyysw
Paketlisten werden gelesen... Fertigyyy123yyysw
Abhängigkeitsbaum wird aufgebaut... Fertigyyy123yyysw
yyy123yyysw
[...]yyy123yyysw
yyy123yyysw
Updating category gsfontderivative..yyy123yyysw
Updating category truetype..yyy123yyysw
Updating category cid..yyy123yyysw
Updating category cmap..yyy123yyysw
Updating category psprint..yyy123yyysw
yyy123yyysw
debian:~#yyy123yyysw</screen></para>

    <para>Über den auf der Hylafax Homepage <ulink
    url="http://www.hylafax.org"><citetitle>http://www.hylafax.org</citetitle></ulink>
    vorhandenen Download-Link die aktuellen Sourcen runterladen. Natürlich
    geht dies auch mit dem Command-Line-Befehl <command>wget
    ftp://ftp.hylafax.org/source/hylafax-4.3.1.tar.gz</command><screen>debian:~# cd /usr/src/yyy123yyysw
debian:/usr/src# wget ftp://ftp.hylafax.org/source/hylafax-4.3.1.tar.gzyyy123yyysw
--12:35:25--  ftp://ftp.hylafax.org/source/hylafax-4.3.1.tar.gzyyy123yyysw
           =&gt; `hylafax-4.3.1.tar.gz'yyy123yyysw
Auflösen des Hostnamen »ftp.hylafax.org«.... 66.179.245.142yyy123yyysw
Verbindungsaufbau zu ftp.hylafax.org[66.179.245.142]:21... verbunden.yyy123yyysw
Anmelden als anonymous ... Angemeldet!yyy123yyysw
==&gt; SYST ... fertig.    ==&gt; PWD ... fertig.yyy123yyysw
==&gt; TYPE I ... fertig.  ==&gt; CWD /source ... fertig.yyy123yyysw
==&gt; PASV ... fertig.    ==&gt; RETR hylafax-4.3.1.tar.gz ... fertig.yyy123yyysw
Länge: 1,498,444 (unmaßgeblich)yyy123yyysw
yyy123yyysw
100%[====================================&gt;] 1,498,444    229.94K/s    ETA 00:00yyy123yyysw
yyy123yyysw
12:35:33 (217.14 KB/s) - »hylafax-4.3.1.tar.gz« gespeichert [1498444]yyy123yyysw
yyy123yyysw
debian:/usr/src#yyy123yyysw</screen>Danach mit <command>tar -xzf
    hylafax-4.3.1.tar.gz</command> entpacken und
    <command>./configure</command> aufrufen.</para>

    <para><screen>debian:/usr/src# tar xfz hylafax-4.3.1.tar.gz yyy123yyysw
debian:/usr/src# cd hylafax-4.3.1yyy123yyysw
debian:/usr/src/hylafax-4.3.1# ./configureyyy123yyysw
yyy123yyysw
Configuring HylaFAX (tm) (aka FlexFAX) 4.3.1.yyy123yyysw
yyy123yyysw
If configure does the wrong thing, check the file config.log foryyy123yyysw
information that may help you understand what went wrong.yyy123yyysw
yyy123yyysw
Reading site-wide parameters from ./config.site.yyy123yyysw
Gosh, aren't you lucky to have a i686-pc-linux-gnu system!yyy123yyysw
Using /usr/bin/gcc for a C compiler (set CC to override).yyy123yyysw
Looks like /usr/bin/gcc supports the -g option.yyy123yyysw
Using " -g" for C compiler options.yyy123yyysw
yyy123yyysw
[...]yyy123yyysw</screen></para>

    <para>Mit <command>./configure</command> werden die Sourcen für das
    Übersetzen vorbereitet, das heißt es wird überprüft, ob alle
    Voraussetzungen erfüllt sind. Wenn dies der Fall ist, fragt das Programm
    diverse Parameter an.<screen>HylaFAX configuration parameters (part 1 of 2) are:yyy123yyysw
yyy123yyysw
[ 1] Directory for applications:        /usr/local/binyyy123yyysw
[ 2] Directory for lib data files:      /usr/local/lib/faxyyy123yyysw
[ 3] Directory for lib executables:     /usr/local/sbinyyy123yyysw
[ 4] Directory for system apps:         /usr/local/sbinyyy123yyysw
[ 5] Directory for manual pages:        /usr/local/manyyy123yyysw
[ 6] Directory for HTML documentation:  /var/httpd/htdocs/hylafaxyyy123yyysw
[ 7] Directory for spooling:            /var/spool/hylafaxyyy123yyysw
[ 8] Directory for uucp lock files:     /var/lockyyy123yyysw
[ 9] Uucp lock file scheme:             asciiyyy123yyysw
[10] PostScript imager package:         gsyyy123yyysw
[11] PostScript imager program:         /usr/bin/gsyyy123yyysw
[12] Manual page installation scheme:   bsd-source-catyyy123yyysw
[13] Default page size:                 North American Letteryyy123yyysw
[14] Default vertical res (lpi):        98yyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
</screen></para>

    <para>Hier müssen für den Betrieb in Deutschland die Werte für das
    Papierformat auf <parameter>A4</parameter> gesetzt werden:</para>

    <screen>Are these ok [yes]?13yyy123yyysw
Default page size [North American Letter]? A4yyy123yyysw
yyy123yyysw
HylaFAX configuration parameters (part 1 of 2) are:yyy123yyysw
yyy123yyysw
[ 1] Directory for applications:        /usr/local/binyyy123yyysw
[ 2] Directory for lib data files:      /usr/local/lib/faxyyy123yyysw
[ 3] Directory for lib executables:     /usr/local/sbinyyy123yyysw
[ 4] Directory for system apps:         /usr/local/sbinyyy123yyysw
[ 5] Directory for manual pages:        /usr/local/manyyy123yyysw
[ 6] Directory for HTML documentation:  /var/httpd/htdocs/hylafaxyyy123yyysw
[ 7] Directory for spooling:            /var/spool/hylafaxyyy123yyysw
[ 8] Directory for uucp lock files:     /var/lockyyy123yyysw
[ 9] Uucp lock file scheme:             asciiyyy123yyysw
[10] PostScript imager package:         gsyyy123yyysw
[11] PostScript imager program:         /usr/bin/gsyyy123yyysw
[12] Manual page installation scheme:   bsd-source-catyyy123yyysw
[13] Default page size:                 ISO A4yyy123yyysw
[14] Default vertical res (lpi):        98yyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
yyy123yyysw
</screen>

    <tip>
      <para>Wer will kann hier auch die Auflösung ändern. Da im
      Geschäftsumfeld über einen solchen solchen Faxserver wahrscheinlich auch
      Briefe und Verträge verschickt werden, können Sie die Auflösung bei
      entsprechendem Bedarf auf 196 lpi einstellen (feine Auflösung).<footnote>
          <para>Damit ist sichergestellt, das auch das Kleingedruckte noch gut
          zu lesen ist. ;-)</para>
        </footnote></para>

      <screen>Are these ok [yes]? 14yyy123yyysw
Default vertical res (lpi) [98]? 196yyy123yyysw
yyy123yyysw
HylaFAX configuration parameters (part 1 of 2) are:yyy123yyysw
yyy123yyysw
[ 1] Directory for applications:        /usr/local/binyyy123yyysw
[ 2] Directory for lib data files:      /usr/local/lib/faxyyy123yyysw
[ 3] Directory for lib executables:     /usr/local/sbinyyy123yyysw
[ 4] Directory for system apps:         /usr/local/sbinyyy123yyysw
[ 5] Directory for manual pages:        /usr/local/manyyy123yyysw
[ 6] Directory for HTML documentation:  /var/httpd/htdocs/hylafaxyyy123yyysw
[ 7] Directory for spooling:            /var/spool/hylafaxyyy123yyysw
[ 8] Directory for uucp lock files:     /var/lockyyy123yyysw
[ 9] Uucp lock file scheme:             asciiyyy123yyysw
[10] PostScript imager package:         gsyyy123yyysw
[11] PostScript imager program:         /usr/bin/gsyyy123yyysw
[12] Manual page installation scheme:   bsd-source-catyyy123yyysw
[13] Default page size:                 ISO A4yyy123yyysw
[14] Default vertical res (lpi):        196yyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
yyy123yyysw
</screen>
    </tip>

    <para>Alle anderen Werte auf dieser Seite können so bleiben, wir
    bestätigen also mit <userinput>yes</userinput>.<screen>Are these ok [yes]? yesyyy123yyysw
yyy123yyysw
HylaFAX configuration parameters (part 2 of 2) are:yyy123yyysw
yyy123yyysw
[15] Location of getty program:         /sbin/agettyyyy123yyysw
[16] Location of voice getty program:   /bin/vgettyyyy123yyysw
[17] Location of sendmail program:      /usr/sbin/sendmailyyy123yyysw
[18] Location of TIFF tools:            /usr/binyyy123yyysw
[19] Location of SysV init scripts:     /etc/init.dyyy123yyysw
[20] Location of SysV start scripts:    ../rc2.d ../rc3.d ../rc4.d ../rc5.dyyy123yyysw
[21] Location of SysV stop scripts:     ../rc0.d ../rc1.d ../rc6.dyyy123yyysw
[22] Name of SysV start script:         S97hylafaxyyy123yyysw
[23] Name of SysV stop script:          K05hylafaxyyy123yyysw
[24] Init script starts faxq:           yesyyy123yyysw
[25] Init script starts hfaxd           yesyyy123yyysw
[26] Start old protocol:                noyyy123yyysw
[27] Start paging protocol:             noyyy123yyysw
Are these ok [yes]?yyy123yyysw
</screen></para>

    <para>Auch hier muss nichts verändern werden (also einfach mit
    <userinput>yes</userinput> übernehmen). Danach werden automatisch alle zum
    Kompilieren benötigten Makefiles angelegt. Das Kompilieren starten wir mit
    <command>make</command> und danach können wir mit einem <command>make
    install</command> die Software installieren.</para>

    <screen>debian:/usr/src/hylafax-4.3.1# makeyyy123yyysw
make[1]: Entering directory `/usr/src/hylafax-4.3.1'yyy123yyysw
= regexyyy123yyysw
make[2]: Entering directory `/usr/src/hylafax-4.3.1/regex'yyy123yyysw
make[3]: Entering directory `/usr/src/hylafax-4.3.1/regex'yyy123yyysw
make[4]: Entering directory `/usr/src/hylafax-4.3.1/regex'yyy123yyysw
/bin/bash ../port/mkdepend   -e 's@ /usr/include/@ /@' -c /usr/bin/gcc -D__ANSI_CPP__ -I. -I.. -I.././regex -I.././regex -I.././util -I/usr/local/include -g -fpic -O -c -M  -i Makedepend regexec.c regcomp.c regfree.c regerror.cyyy123yyysw
make[4]: Leaving directory `/usr/src/hylafax-4.3.1/regex'yyy123yyysw
yyy123yyysw
[...]yyy123yyysw
yyy123yyysw
for i in README depend make.links preremove proto.local ; do    \yyy123yyysw
        [ -f $i ]  ||  cp .././pkg/$i . ;                       \yyy123yyysw
done yyy123yyysw
make[2]: Leaving directory `/usr/src/hylafax-4.3.1/pkg'yyy123yyysw
make[1]: Leaving directory `/usr/src/hylafax-4.3.1'yyy123yyysw
debian:/usr/src/hylafax-4.3.1# make installyyy123yyysw
yyy123yyysw
[...]yyy123yyysw
yyy123yyysw
if test -d /etc/config; then \yyy123yyysw
    /bin/bash ../port/install.sh  -idb hylafax.sw.server -F /etc/config -m 644 -src config.fax -O fax; \yyy123yyysw
fiyyy123yyysw
make[1]: Leaving directory `/usr/src/hylafax-4.3.1/etc'yyy123yyysw
debian:/usr/src/hylafax-4.3.1#yyy123yyysw</screen>

    <para>Der nächste Schritt ist das Setup des Faxservers. Hierzu rufen wir
    das Programm <command>faxsetup</command> auf:<screen>debian:/usr/src/hylafax-4.3.1# faxsetupyyy123yyysw
yyy123yyysw
[...]yyy123yyysw
yyy123yyysw
There does not appear to be an entry for the FaxMaster either inyyy123yyysw
the YP/NIS database or in the /etc/aliases file.  Theyyy123yyysw
FaxMaster is the primary point of contact for HylaFAX problems. yyy123yyysw
The HylaFAX client-server protocol server identifies this alias asyyy123yyysw
the place to register complaints and HylaFAX directs automatic mailyyy123yyysw
messages to this user when problems are identified on a serveryyy123yyysw
machine or when the routine server maintainence scripts are runyyy123yyysw
(e.g. faxcron).yyy123yyysw
yyy123yyysw
Should an entry be added for the FaxMaster to /etc/aliases [yes]?yyy123yyysw</screen>Bei
    den folgenden 2-3 Fragen einfach immer Enter drücken.<screen> HylaFAX configuration parameters are:yyy123yyysw
yyy123yyysw
        [1] Init script starts faxq:            yesyyy123yyysw
        [2] Init script starts hfaxd            yesyyy123yyysw
        [3] Start old protocol:                 noyyy123yyysw
        [4] Start paging protocol:              noyyy123yyysw
Are these ok [yes]?yyy123yyysw
</screen></para>

    <para>Bei den folgenden Einstellungen müssen Sie die für Ihre Installation
    geeigneten Werte eingeben:</para>

    <screen>No scheduler config file exists, creating one from scratch.yyy123yyysw
Country code [1]? 49yyy123yyysw
Area code []? 69yyy123yyysw
Long distance dialing prefix [1]? 0yyy123yyysw
International dialing prefix [011]? 00yyy123yyysw
Dial string rules file (relative to /var/spool/hylafax) ["etc/dialrules"]?yyy123yyysw
Tracing during normal server operation [1]?yyy123yyysw
Default tracing during send and receive sessions [0xffffffff]?yyy123yyysw
Continuation cover page (relative to /var/spool/hylafax) []?yyy123yyysw
Timeout when converting PostScript documents (secs) [180]?yyy123yyysw
Maximum number of concurrent jobs to a destination [1]?yyy123yyysw
Define a group of modems []?yyy123yyysw
Time of day restrictions for outbound jobs ["Any"]?yyy123yyysw
Pathname of destination controls file (relative to /var/spool/hylafax) []?yyy123yyysw
Timeout before purging a stale UUCP lock file (secs) [30]?yyy123yyysw
Max number of pages to permit in an outbound job [0xffffffff]?yyy123yyysw
Syslog facility name for ServerTracing messages [daemon]?yyy123yyysw
yyy123yyysw
The non-default scheduler parameters are:yyy123yyysw
yyy123yyysw
CountryCode:            49yyy123yyysw
AreaCode:               69yyy123yyysw
LongDistancePrefix:     0yyy123yyysw
InternationalPrefix:    00yyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
</screen>

    <para>Dabei sind an sich nur die ersten vier Fragen wichtig. Das erste ist
    die Landesvorwahl als zweistellige Zahl, für Deutschland also die
    <code>49</code>. Dann folgt die Ortsnetznummer ohne führende Null, in
    diesem Beispiel die <code>69</code> für Frankfurt am Main. Dann eine Null
    für Ferngespräche und zwei Nullen für internationale Gespräche. Dann mit
    <userinput>yes</userinput> bestätigen.</para>

    <screen>Restarting HylaFAX server processes.yyy123yyysw
Should I restart the HylaFAX server processes [yes]?yyy123yyysw
yyy123yyysw
/etc/init.d/hylafax startyyy123yyysw
HylaFAX: faxq hfaxd (without old protocol &amp; without SNPP support).yyy123yyysw
yyy123yyysw
You do not appear to have any modems configured for use.  Modems areyyy123yyysw
configured for use with HylaFAX with the faxaddmodem(8C) command.yyy123yyysw
Do you want to run faxaddmodem to configure a modem [yes]?yyy123yyysw
</screen>

    <para>Jetzt bestätigen wir den Restart des Serverprozesses mit
    <userinput>yes</userinput> und werden gefragt, ob wir in Modem
    installieren wollen. Da unser iaxmodem bereits eingerichtet ist, können
    wir hier direkt weitermachen und bestätigen mit
    <userinput>yes</userinput>.</para>

    <screen>Serial port that modem is connected to []? ttyIAX0yyy123yyysw
yyy123yyysw
Ok, time to setup a configuration file for the modem.  The manualyyy123yyysw
page config(5F) may be useful during this process.  Also be awareyyy123yyysw
that at any time you can safely interrupt this procedure.yyy123yyysw
yyy123yyysw
Reading scheduler config file /var/spool/hylafax/etc/config.yyy123yyysw
yyy123yyysw
No existing configuration, let's do this from scratch.yyy123yyysw
yyy123yyysw
Country code [1]? 49yyy123yyysw
Area code [415]? 69yyy123yyysw
Phone number of fax modem [+1.999.555.1212]? +49 69 12345678yyy123yyysw
Local identification string (for TSI/CIG) ["NothingSetup"]? Apfelmus GmbHyyy123yyysw
Long distance dialing prefix [1]? 0yyy123yyysw
International dialing prefix [011]? 00yyy123yyysw
Dial string rules file (relative to /var/spool/hylafax) [etc/dialrules]?yyy123yyysw
Tracing during normal server operation [1]?yyy123yyysw
Tracing during send and receive sessions [11]?yyy123yyysw
Protection mode for received facsimile [0600]?yyy123yyysw
Protection mode for session logs [0600]?yyy123yyysw
Protection mode for ttyIAX0 [0600]?yyy123yyysw
Rings to wait before answering [1]?yyy123yyysw
Modem speaker volume [off]?yyy123yyysw
Command line arguments to getty program ["-h %l dx_%s"]?yyy123yyysw
Pathname of TSI access control list file (relative to /var/spool/hylafax) [""]?yyy123yyysw
Pathname of Caller-ID access control list file (relative to /var/spool/hylafax) [""]?yyy123yyysw
Tag line font file (relative to /var/spool/hylafax) [etc/lutRS18.pcf]?yyy123yyysw
Tag line format string ["From %%l|%c|Page %%P of %%T"]?yyy123yyysw
Time before purging a stale UUCP lock file (secs) [30]?yyy123yyysw
Hold UUCP lockfile during inbound data calls [Yes]?yyy123yyysw
Hold UUCP lockfile during inbound voice calls [Yes]?yyy123yyysw
Percent good lines to accept during copy quality checking [95]?yyy123yyysw
Max consecutive bad lines to accept during copy quality checking [5]?yyy123yyysw
Max number of pages to accept in a received facsimile [25]?yyy123yyysw
Syslog facility name for ServerTracing messages [daemon]?yyy123yyysw
Set UID to 0 to manipulate CLOCAL [""]?yyy123yyysw
Use available priority job scheduling mechanism [""]?yyy123yyysw
yyy123yyysw
The non-default server configuration parameters are:yyy123yyysw
yyy123yyysw
CountryCode:            49yyy123yyysw
AreaCode:               69yyy123yyysw
FAXNumber:              +49 69 12345678yyy123yyysw
LongDistancePrefix:     0yyy123yyysw
InternationalPrefix:    00yyy123yyysw
DialStringRules:        etc/dialrulesyyy123yyysw
SessionTracing:         11yyy123yyysw
RingsBeforeAnswer:      1yyy123yyysw
SpeakerVolume:          offyyy123yyysw
GettyArgs:              "-h %l dx_%s"yyy123yyysw
LocalIdentifier:        Apfelmus GmbHyyy123yyysw
TagLineFont:            etc/lutRS18.pcfyyy123yyysw
TagLineFormat:          "From %%l|%c|Page %%P of %%T"yyy123yyysw
MaxRecvPages:           25yyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
yyy123yyysw
</screen>

    <para>Fragen über Fragen, aber nur die wenigsten sind wirklich
    wichtig.<footnote>
        <para>Mögen die Leute verzeihen, die schon einmal ein HylaFax getunt
        haben, aber für den Anfang reichen die defaults.</para>
      </footnote> Wichtig sind natürlich die Faxnummer und der sogenannte
    LocalIdentifier. Das ist der Text, der auf jedem gesendeten Fax in der
    obersten Zeile steht.</para>

    <para>Yes bringt uns weiter zur Modemerkennung.</para>

    <screen>Now we are going to probe the tty port to figure out the typeyyy123yyysw
of modem that is attached.  This takes a few seconds, so be patient.yyy123yyysw
Note that if you do not have the modem cabled to the port, or theyyy123yyysw
modem is turned off, this may hang (just go and cable up the modemyyy123yyysw
or turn it on, or whatever).yyy123yyysw
yyy123yyysw
Probing for best speed to talk to modem: 38400 OK.yyy123yyysw
yyy123yyysw
About fax classes:yyy123yyysw
yyy123yyysw
The difference between fax classes has to do with how HylaFAX interactsyyy123yyysw
with the modem and the fax protocol features that are used when sendingyyy123yyysw
or receiving faxes.  One class isn't inherently better than another;yyy123yyysw
however, one probably will suit a user's needs better than others.yyy123yyysw
yyy123yyysw
Class 1 relies on HylaFAX to perform the bulk of the fax protocol.yyy123yyysw
Class 2 relies on the modem to perform the bulk of the fax protocol.yyy123yyysw
Class 2.0 is similar to Class 2 but may include more features.yyy123yyysw
Class 1.0 is similar to Class 1 but may add V.34-fax capability.yyy123yyysw
Class 2.1 is similar to Class 2.0 but adds V.34-fax capability.yyy123yyysw
yyy123yyysw
HylaFAX generally will have more features when using Class 1/1.0 thanyyy123yyysw
when using most modems' Class 2 or Class 2.0 implementations.  Generallyyyy123yyysw
any problems encountered in Class 1/1.0 can be resolved by modificationsyyy123yyysw
to HylaFAX, but usually any problems encountered in Class 2/2.0/2.1 willyyy123yyysw
require the modem manufacturer to resolve it.yyy123yyysw
yyy123yyysw
If you're unsure and your modem supports it, use Class 1.yyy123yyysw
yyy123yyysw
This modem looks to have support for Class 1 and 1.0.yyy123yyysw
How should it be configured [1]?1yyy123yyysw
Hmm, this looks like a Class 1 modem.yyy123yyysw
Product code (ATI0) is "spandsp".yyy123yyysw
Other information (ATI3) is "www.soft-switch.org".yyy123yyysw
DTE-DCE flow control scheme [default]?yyy123yyysw
Modem manufacturer is "spandsp".yyy123yyysw
Modem model is "IAXmodem".yyy123yyysw
yyy123yyysw
Using prototype configuration file iaxmodem...yyy123yyysw
yyy123yyysw
The modem configuration parameters are:yyy123yyysw
yyy123yyysw
ModemResetCmds:         "ATH1\nAT+VCID=1"yyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
yyy123yyysw
Creating new configuration file /var/spool/hylafax/etc/config.ttyIAX0...yyy123yyysw
Creating fifo /var/spool/hylafax/FIFO.ttyIAX0 for faxgetty... done.yyy123yyysw
Done setting up the modem configuration.yyy123yyysw
yyy123yyysw
Checking /var/spool/hylafax/etc/config for consistency...yyy123yyysw
...some parameters are different.yyy123yyysw
yyy123yyysw
The non-default scheduler parameters are:yyy123yyysw
yyy123yyysw
CountryCode:            49yyy123yyysw
AreaCode:               69yyy123yyysw
LongDistancePrefix:     0yyy123yyysw
InternationalPrefix:    00yyy123yyysw
DialStringRules:        etc/dialrulesyyy123yyysw
yyy123yyysw
Are these ok [yes]?yyy123yyysw
</screen>

    <para>Das Modem wurde erkannt und wir werden gefragt, ob es ein Class 1
    Modem ist. Da das genau das ist, was wir wollen, bestätigen wir. Auch das
    Reset-Kommando für das Modem können wir so übernehmen. Wenn alles in
    Ordnung ist, bestätigen wir mit <userinput>yes</userinput>.</para>

    <screen>Creating new configuration file /var/spool/hylafax/etc/config...yyy123yyysw
...saving current file as /var/spool/hylafax/etc/config.sav.yyy123yyysw
yyy123yyysw
Don't forget to run faxmodem(8C) (if you have a send-only environment)yyy123yyysw
or configure init to run faxgetty on ttyIAX0.yyy123yyysw
Do you want to run faxaddmodem to configure another modem [yes]? noyyy123yyysw
yyy123yyysw
You do not appear to be using faxgetty to notify the HylaFAX scheduleryyy123yyysw
about new modems and/or their status.  This means that you must use theyyy123yyysw
faxmodem program to inform the new faxq process about the modems youyyy123yyysw
want to have scheduled by HylaFAX.  Beware that if you have modems thatyyy123yyysw
require non-default capabilities specified to faxmodem then you shouldyyy123yyysw
read faxmodem(8C) manual page and do this work yourself (since thisyyy123yyysw
script is not intelligent enough to automatically figure out the modemyyy123yyysw
capabilities and supply the appropriate arguments).yyy123yyysw
yyy123yyysw
Should I run faxmodem for each configured modem [yes]?yyy123yyysw
/usr/local/sbin/faxmodem ttyIAX0yyy123yyysw
yyy123yyysw
Done verifying system setup.yyy123yyysw
</screen>

    <para>Ein zweites Modem haben wir nicht, also beantworten wir die Frage
    mit <userinput>no</userinput>. Das Ausführen von faxmodem macht durchaus
    Sinn, denn dadurch sind die Modems an Hylafax angebunden.</para>

    <para>Jetzt ist das Hylafax zum Senden von Faxen eingerichtet. Aber
    vielleicht möchten Sie ja auch welche empfangen. Dazu brauchen wir einen
    getty, der am iaxmodem auf Verbindungen lauscht. Das erreicht man ganz
    einfach durch einen weiteren Eintrag in der Datei
    <filename>/etc/inittab</filename>.</para>

    <screen>mo00:23:respawn:/usr/local/sbin/faxgetty ttyIAX0yyy123yyysw</screen>

    <section id="faxe-empfangen">
      <title>Faxe empfangen</title>

      <para>Jetzt muss diese Faxlösung noch in Asterisk integriert werden.
      Dazu müssen wir Asterisk das IAXmodem bekannt machen. Dies erreichen
      wir, indem wir es als IAX2-Peer definieren. Die dazu erforderliche Datei
      heißt <filename>/etc/asterisk/iax.conf</filename> (siehe auch <xref
      linkend="iax" />):</para>

      <screen>[general]yyy123yyysw
bindport = 4569           yyy123yyysw
bindaddr = 0.0.0.0    yyy123yyysw
disallow=allyyy123yyysw
allow=ulawyyy123yyysw
allow=alawyyy123yyysw
yyy123yyysw
[iaxmodem]yyy123yyysw
type=friendyyy123yyysw
secret=passwordyyy123yyysw
port=4570yyy123yyysw
host=dynamicyyy123yyysw
context=fax-outyyy123yyysw
disallow=allyyy123yyysw
allow=alawyyy123yyysw
</screen>

      <para>Im Abschnitt <code>general</code> sind die globalen IAX2-Daten
      abgelegt. In diesem Beispiel wird der Bindport auf den Standart für IAX2
      4569 gesetzt. Die Bindadresse gibt das Interface an, auf dem IAX2
      lauscht, in diesem Falle auf allen Interfaces.</para>

      <para>In der Konfiguration für das IAXmodem wird der
      <parameter>type</parameter> auf <code>friend</code> gesetzt, d.h. es
      sind eingehende und ausgehende Verbindungen erlaubt.
      <parameter>secret</parameter> und <parameter>port</parameter>
      entsprechen der Konfiguration des IAXmodems, der
      <parameter>context</parameter> ist der, der bei einer ausgehenden
      Verbindung angesprochen wird.</para>

      <para>Mit dem Befehl <command>iax2 show peers</command> können wir jetzt
      in der Asterisk-Console (CLI) unser IAXmodem sehen:</para>

      <screen>*CLI&gt; iax2 show peersyyy123yyysw
Name/Username    Host                 Mask             Port          Statusyyy123yyysw
iaxmodem         127.0.0.1       (D)  255.255.255.255  4570          Unmonitoredyyy123yyysw
1 iax2 peers [0 online, 0 offline, 1 unmonitored]yyy123yyysw
*CLI&gt;yyy123yyysw
</screen>

      <para>Damit Asterisk weiß, was es mit einem ankommenden Fax anstellen
      soll, müssen wir eine entsprechende Extension schreiben. Das Ziel soll
      sein, daß ein ankommendes Fax direkt an das Hylafax weitergeleitet wird.
      In diesem Beispiel gehen wir davon aus, das alle Faxe über einen
      SIP-Provider-Anschluss reinkommen. Eine entsprechende Konfiguration in
      der <filename>sip.conf</filename> kann wie folgt aussehen (die
      entsprechenden Einstellungen müssen natürlich an die jeweilige
      Installation und den SIP-Provider angepasst werden):</para>

      <screen>[...]yyy123yyysw
yyy123yyysw
[123456]yyy123yyysw
type=friendyyy123yyysw
insecure=very;yyy123yyysw
nat=yesyyy123yyysw
username=123456yyy123yyysw
fromuser=12345yyy123yyysw
fromdomain=mein-voip-provider.deyyy123yyysw
secret=secretyyy123yyysw
host=mein-voip-provider.deyyy123yyysw
qualify=yesyyy123yyysw
context=fax-inyyy123yyysw
yyy123yyysw
[...]yyy123yyysw
</screen>

      <para>Der entsprechende Context in der
      <filename>extensions.conf</filename> sieht dann so aus:</para>

      <screen>[fax-in]yyy123yyysw
exten =&gt; _.,1,Answer()yyy123yyysw
exten =&gt; _.,2,Dial(IAX2/iaxmodem)yyy123yyysw
exten =&gt; h,1,Hangup()yyy123yyysw
</screen>

      <para>Jetzt wird das Fax vom Asterisk an Hylafax über IAXmodem übergeben
      und per Mail an den User gesendet, auf den das Mailalias
      <parameter>Faxmaster</parameter> zeigt.</para>
    </section>

    <section id="faxe-versenden">
      <title>Faxe versenden</title>

      <para>Der nächste Schritt ist Fax senden. Auch hierfür brauchen wir
      Context <code>[fax-out]</code> in der
      <filename>extension.conf</filename>. Wenn das virtuelle IAX-Modem ein
      Fax versenden will, kommt es automatisch in diesen Context. Sollen die
      Faxe dann über unsere Beispiel SIP-Verbindung 123456 gefaxt werden, so
      sieht der Eintrag in der <filename>extensions.conf</filename> wie folgt
      aus:</para>

      <screen>[fax-out]yyy123yyysw
exten =&gt; _X.,1,Answer()yyy123yyysw
exten =&gt; _X.,2,Dial(SIP/123456/${EXTEN})yyy123yyysw
exten =&gt; h,1,Hangup()yyy123yyysw
</screen>

      <para>Testen können wir das Senden mit <command>sendfax -n -d
      &lt;Faxnummer&gt; &lt;datei.txt&gt;</command></para>

      <screen>debian:~# sendfax -n -d 06912345678 /etc/issue.netyyy123yyysw</screen>

      <para>Im CLI sollten wir jetzt folgendes sehen:</para>

      <screen> -- Accepting AUTHENTICATED call from 127.0.0.1:yyy123yyysw
       &gt; requested format = alaw,yyy123yyysw
       &gt; requested prefs = (),yyy123yyysw
       &gt; actual format = alaw,yyy123yyysw
       &gt; host prefs = (alaw),yyy123yyysw
       &gt; priority = mineyyy123yyysw
    -- Executing Answer("IAX2/iaxmodem-3", "") in new stackyyy123yyysw
    -- Executing Dial("IAX2/iaxmodem-3", "SIP/123456/06912345678") in new stackyyy123yyysw
    -- Called 123456/06912345678yyy123yyysw
    -- SIP/123456-0818f630 is making progress passing it to IAX2/iaxmodem-3yyy123yyysw
    -- SIP/123456-0818f630 answered IAX2/iaxmodem-3yyy123yyysw
    -- parse_srv: SRV mapped to host mein-voip-provider.de, port 5060yyy123yyysw
  == Spawn extension (fax-out, 06912345678, 2) exited non-zero on 'IAX2/iaxmodem-3'yyy123yyysw
    -- Executing Hangup("IAX2/iaxmodem-3", "") in new stackyyy123yyysw
  == Spawn extension (fax-out, h, 1) exited non-zero on 'IAX2/iaxmodem-3'yyy123yyysw
    -- Hungup 'IAX2/iaxmodem-3'yyy123yyysw
</screen>

      <para>Das Kommando <command>faxstat -s</command> zeigt während des
      Sendens folgendes:</para>

      <screen>debian:~# faxstat -syyy123yyysw
HylaFAX scheduler on w077.example.com: Runningyyy123yyysw
Modem ttyIAX0 (123456): Sending job 7yyy123yyysw
yyy123yyysw
JID  Pri S  Owner Number       Pages Dials     TTS Statusyyy123yyysw
7    127 R   root 06912345678  0:1   0:12yyy123yyysw
debian:~# yyy123yyysw
</screen>

      <para>Fertig! Jetzt können Sie über Asterisk mit Hylafax Faxe versenden
      und empfangen.</para>

      <para>Auf der Hylafax-Webseite <ulink
      url="http://www.hylafax.org"><citetitle>http://www.hylafax.org</citetitle></ulink>
      finden Sie viele Hinweise und Howtos, wie Sie Ihren neuen Faxserver
      möglichst einfach in Ihre bestehende Büroinfrastruktur einbinden
      können.</para>
    </section>

    <section id="faxserver-faq">
      <title>Fax FAQ</title>

      <para></para>

      <qandaset>
        <qandadiv>
          <qandaentry>
            <question>
              <para>Kann man anstatt Hylafax auch andere Faxserversoftware
              einsetzen?</para>
            </question>

            <answer>
              <para>Ja, das ist kein Problem. Allerdings hat sich Hylafax sehr
              bewährt.</para>
            </answer>
          </qandaentry>

          <qandaentry>
            <question>
              <para>Gibt es zu Hylafax ein eigenes FAQ?</para>
            </question>

            <answer>
              <para>Ja, dieses kann unter <ulink
              url="http://www.hylafax.org/content/FAQ"><citetitle>http://www.hylafax.org/content/FAQ</citetitle></ulink>
              eingesehen werden.</para>
            </answer>
          </qandaentry>
        </qandadiv>
      </qandaset>
    </section>
  </section>
</chapter>