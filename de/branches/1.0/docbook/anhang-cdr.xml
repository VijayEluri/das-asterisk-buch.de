<?xml version="1.0" encoding="ISO-8859-1"?>
<appendix id="anhang-cdr">
  <title revision="$Revision$">CDRs<indexterm>
      <primary>CDRs</primary>
    </indexterm><indexterm>
      <primary>Call Detail Records</primary>
    </indexterm><indexterm>
      <primary>Anrufprotokolle</primary>
    </indexterm></title>

  <subtitle>(Call Detail Records, Anrufprotokolle)</subtitle>

  <simpara>Asterisk protokolliert jeden Anruf in einem CDR. Hier sind
  verschiedene Informationen zu diesem Thema gesammelt.</simpara>

  <simpara>Siehe auch <filename>doc/README.cdr</filename> (1.2) bzw.
  <filename>doc/cdrdriver.txt</filename> und
  <filename>doc/billing.txt</filename> (1.4).</simpara>

  <simpara>CDRs werden per Default in
  <filename>/var/log/asterisk/cdr-csv/Master.csv</filename> und
  <filename>/var/log/asterisk/cdr-custom/Master.csv</filename>
  gespeichert.</simpara>

  <section>
    <title>CDR-Felder</title>

    <simpara>Die Felder werden in <xref linkend="funktionen-cdr" /> erklärt.
    Das Format ist normalerweise: Kontonr, Anrufer-Nr, Ziel-Extension,
    Ziel-Context, CallerID, Kanal, Ziel-Kanal, letzte Applikation, Argumente
    der letzten Applikation, Start-Zeit, Antwort-Zeit, End-Zeit, Dauer,
    Abrechnungs-Dauer, Erfolgsstatus, AMA-Flags [,UniqueID]
    [,User-Feld]</simpara>
  </section>

  <section>
    <title>Speicherung von Userfield und UniqueID</title>

    <simpara>Mit der Funktion <code>CDR()</code> (<xref
    linkend="funktionen-cdr" />) können im User-Field (<code>userfield</code>)
    beliebige Informationen zu einem Anruf gespeichert werden. Dies
    funktioniert allerdings nur unter folgenden Bedingungen:</simpara>

    <section>
      <title>Asterisk 1.2</title>

      <para>Die einfachste Möglichkeit ist die Verwendung des
      <code>custom</code>-Backends, das automatisch das <code>userfield</code>
      speichert (siehe <filename>cdr_custom.conf</filename>). Es übernimmt die
      gleiche Funktion wie das <code>csv</code>-Backend.</para>

      <para>In den Backends <filename>cdr_odbc.c</filename> und
      <filename>cdr_pgsql.c</filename> ist <emphasis>keine</emphasis> Änderung
      notwendig.</para>

      <para>Das Backend <filename>cdr_addon_mysql.c</filename> aus den Add-ons
      liest die Einstellung <parameter>userfield</parameter> aus der
      <filename>cdr_mysql.conf</filename>.</para>

      <para>Die Backends <code>csv</code> und <code>sqlite</code> müssen mit
      Unterstützung für das <code>userfield</code> kompiliert worden sein.
      Dafür muss man <emphasis>vor</emphasis> dem Kompilieren im Verzeichnis
      <filename>cdr/</filename> im Quellverzeichnis folgende Dateien
      ändern:</para>

      <formalpara>
        <title><filename>cdr_csv.c</filename></title>

        <para>Die Kommentarzeichen um die folgenden Zeilen entfernen (in der
        Version 1.2.13 die Zeilen 53/54):<informaltable colsep="none"
            frame="none" rowsep="none">
            <tgroup cols="2">
              <tbody>
                <row>
                  <entry>Original:<programlisting>/* #define CSV_LOGUNIQUEID 1 */
/* #define CSV_LOGUSERFIELD 1 */</programlisting></entry>

                  <entry>wird zu:<programlisting>#define CSV_LOGUNIQUEID 1
#define CSV_LOGUSERFIELD 1</programlisting></entry>
                </row>
              </tbody>
            </tgroup>
          </informaltable>Statt des Backends <code>csv</code> können Sie aber
        auch einfach <code>custom</code> verwenden, das das Log-Format aus der
        <filename>cdr_custom.conf</filename> liest!</para>
      </formalpara>

      <formalpara>
        <title><filename>cdr_sqlite.c</filename></title>

        <para>Diese Zeilen ändern (in der Version 1.2.13 die Zeilen
        51/52):<informaltable colsep="none" frame="none" rowsep="none">
            <tgroup cols="2">
              <tbody>
                <row>
                  <entry>Original:<programlisting>#define LOG_UNIQUEID    0
#define LOG_USERFIELD   0</programlisting></entry>

                  <entry>wird zu:<programlisting>#define LOG_UNIQUEID    1
#define LOG_USERFIELD   1</programlisting></entry>
                </row>
              </tbody>
            </tgroup>
          </informaltable></para>
      </formalpara>

      <simpara><filename>cdr_tds.c</filename> müsste ebenfalls angepasst
      werden, aber es dient dazu, auf einem Microsoft-SQL-Server zu speichern,
      und wir konzentrieren uns auf Debian. Daher wird es hier nicht
      beschrieben.</simpara>

      <simpara>In allen Fällen sind die entsprechenden Konfigurationsdateien
      der Backends in <filename>/etc/asterisk/</filename> zu beachten (sofern
      sie eine haben): <filename>cdr_odbc.conf</filename> und
      <filename>cdr_pgsql.conf</filename>, und natürlich die generelle
      <filename>cdr.conf</filename>.</simpara>
    </section>

    <section>
      <title>Asterisk 1.4</title>

      <para>In Asterisk 1.4 wird nur noch die zentrale Datei cdr.conf für alle
      Backends verwendet. Darin kann man pro Backend einen Bereich definieren,
      für CSV z.B. so:<programlisting>[csv]
usegmtime=yes    ; log date/time in GMT
loguniqueid=yes  ; log uniqueid
loguserfield=yes ; User-Field aufzei</programlisting>Dadurch ist auch für das
      <code>csv</code>-Backend keine Änderung mehr am Quellcode
      notwendig.</para>
    </section>
  </section>

  <section>
    <title>Auswertung</title>

    <para>Software zur Normalisierung und Auswertung von CDRs:<itemizedlist>
        <listitem>
          <simpara>CDRTool (<ulink
          url="http://www.ag-projects.com/CDRTool.html">http://www.ag-projects.com/CDRTool.html</ulink>)</simpara>
        </listitem>

        <listitem>
          <simpara>Call Accounting Mate (<ulink
          url="http://www.callaccounting.ws/">http://www.callaccounting.ws/</ulink>)</simpara>
        </listitem>
      </itemizedlist>Weitere Informationen und Links zu Software auf <ulink
    url="http://www.voip-info.org/wiki/view/Asterisk+billing">http://www.voip-info.org/wiki/view/Asterisk+billing</ulink>.</para>
  </section>

  <section>
    <title>h-Extension</title>

    <para>Die Extension <code>h</code> (hangup) kann, wenn sie eine
    nennenswerte Zeit beansprucht, die Abrechnungsdauer der CDRs verfälschen.
    Entweder sollten Sie sie nicht verwenden oder in der
    <code>h</code>-Extension <code>ResetCDR(w)</code> ausführen, um die
    Gesprächsdauer für den CDR zu beenden.</para>
  </section>

  <section>
    <title>Transfers</title>

    <para>Bei der Aufzeichnung von CDRs bei IAX-zu-IAX-Verbindungen ist zu
    beachten, dass normalerweise versucht wird, eine direkte Verbindung
    zwischen den beiden Teilnehmern herzustellen und das Gespräch nicht mehr
    über den zentralen (Asterisk-)Server zu übertragen. Das ist normalerweise
    ein sehr gutes Feature, führt aber dazu, dass im CDR nur eine sehr kurze
    Gesprächsdauer angegeben ist. In der Regel ist das selbst aus
    Abrechnungsaspekten in Ordnung, denn wenn Sie keine Daten mehr übertragen
    müssen, entstehen ja auch keine Kosten. Falls Sie trotzdem die korrekte
    Gesprächsdauer benötigen, müssen Sie IAX-Transfers abschalten.</para>
  </section>
</appendix>