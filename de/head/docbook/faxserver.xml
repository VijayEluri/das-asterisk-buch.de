<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<chapter id="faxserver" lang="de" revision="$Revision$">
  <!--% Copyright (c) 2006 - 2007
% - Stefan Wintermeyer <sw@amooma.de>
% - Mathias Päzolt <mathias@paezolt.de>
% - Michael Kiberu <m.kiberu@kipya.com>
% - Peter Kozak <peter.kozak@amooma.de>
% - Philipp Kempgen <philipp.kempgen@amooma.de>

% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
% Asterisk training and consulting is offered at http://www.amooma.de -->

  <title>Faxserver</title>

  <para>Es gibt eine Reihe von Ansätzen und Projekten, mit Asterisk einen
  Faxserver zu implementieren. Lange Zeit war app_rxfax von <ulink
  url="http://www.soft-switch.org/">http://www.soft-switch.org/</ulink> die
  von vielen angepriesene Lösung. Allerdings gilt diese Variante als
  fehleranfällig. Faxe werden regelmäßig unvollständig übertragen.</para>

  <para>Deshalb beschreiben wir hier das Projekt IAXmodem (siehe <ulink
  url="http://iaxmodem.sourceforge.net/">http://iaxmodem.sourceforge.net/</ulink>).</para>

  <section id="faxserver-mit-iaxmodem-und-hylafax">
    <title>Faxserver mit IAXmodem und Hylafax</title>

    <para>Die Software IAXmodem emuliert ein Modem, das von einer beliebigen
    Faxsoftware angesteuert werden kann. Für die Faxserversoftware nehmen wir
    das populäre <ulink
    url="http://www.hylafax.org/"><citetitle>HylaFax</citetitle></ulink> oder
    <ulink
    url="http://hylafax.sourceforge.net/"><citetitle>HylaFax+</citetitle></ulink>.
    Als Plattform benutzen wir für diese Installationsanleitung das im
    restlichen Buch ebenfalls verwendete Debian Linux mit einem Asterisk 1.4
    (siehe <xref linkend="installation-1.4-debian" />).</para>

    <section id="installation-iaxmodem">
      <title>Installation IAXmodem</title>

      <para>IAXmodem ist eine Software, die ein Modem simuliert, und dieses
      Asterisk mit dem IAX2-Protokoll zur Verfügung stellt. Alle Schritte in
      diesem Kapitel werden als User root ausgeführt.</para>

      <para>Um IAXmodem installieren zu können, benötigen wir noch einige
      Debian-Packete, die mit <command>apt-get -y install g++ libtiff-tools
      libtiff4 libtiff4-dev</command> installiert werden.</para>

      <screen>debian:~# apt-get -y install g++ libtiff-tools libtiff4 libtiff4-dev
Paketlisten werden gelesen... Fertig
Abhängigkeitsbaum wird aufgebaut... Fertig
Die folgenden zusätzlichen Pakete werden installiert:
  g++ libjpeg62 libjpeg62-dev libtiffxx0 zlib1g-dev

[...]

Richte zlib1g-dev ein (1.2.2-4.sarge.2) ...
Richte libtiff4-dev ein (3.7.2-7) ...

debian:~# 
</screen>

      <para>Zum Installieren der Sourcen wechseln wir mit <command>cd
      /usr/src</command> wieder in das entsprechende Verzeichnis:<screen>debian:~# cd /usr/src
debian:/usr/src# </screen></para>

      <para>Die Sourcen zu IAXmodem können mit einem normalen Browser auf der
      Webseite <ulink
      url="http://iaxmodem.sourceforge.net">http://iaxmodem.sourceforge.net</ulink>
      heruntergeladen werden (in diesem Beispiel ist es die Version 0.3.0).
      Nach dem Download muss der TarBall in das Verzeichnis /usr/src kopiert
      und mit <command>tar -xzf iaxmodem-0.3.0.tar.gz</command> enpackt
      werden.<screen>debian:/usr/src# tar -xvzf iaxmodem-0.3.0.tar.gz 
iaxmodem-0.3.0/
iaxmodem-0.3.0/iaxmodem.c
iaxmodem-0.3.0/iaxmodem.init.debian
iaxmodem-0.3.0/Makefile.in
iaxmodem-0.3.0/CHANGES
iaxmodem-0.3.0/lib/
iaxmodem-0.3.0/lib/spandsp/
iaxmodem-0.3.0/lib/spandsp/Makefile.am

[...]

iaxmodem-0.3.0/TODO
iaxmodem-0.3.0/FAQ
iaxmodem-0.3.0/build
iaxmodem-0.3.0/iaxmodem.init.fedora
debian:/usr/src#</screen></para>

      <para>Mit <command>cd iaxmodem-0.3.0</command> in das neue Verzeichnis
      wechseln.<screen>debian:/usr/src# cd iaxmodem-0.3.0
debian:/usr/src/iaxmodem-0.3.0#</screen></para>

      <para>Un danach mit dem Befehl <command>./configure &amp;&amp; make
      </command>kompilieren.<screen>debian:/usr/src/iaxmodem-0.3.0# ./configure &amp;&amp; make
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for gawk... no
checking for mawk... mawk
checking whether make sets $(MAKE)... yes
checking for gcc... gcc

[...]

cc -DMODEMVER=\"0.3.0\" -DDSPVER=\"spandsp-0.0.3-snapshot-20070223+\" -DIAXVER=\"libiax2-0.2.3-CVS-20060222+\" -Wall -g -DSTATICLIBS -DUSE_UNIX98_PTY -std=c99 -Ilib/libiax2/src -Ilib/spandsp/src  -c iaxmodem.c
cc -DMODEMVER=\"0.3.0\" -DDSPVER=\"spandsp-0.0.3-snapshot-20070223+\" -DIAXVER=\"libiax2-0.2.3-CVS-20060222+\" -Wall -g -DSTATICLIBS -DUSE_UNIX98_PTY -std=c99 -Ilib/libiax2/src -Ilib/spandsp/src  iaxmodem.o lib/spandsp/src/.libs/libspandsp.a lib/libiax2/src/.libs/libiax.a -o iaxmodem -lm -lutil -ltiff

[...]

debian:/usr/src/iaxmodem-0.3.0# </screen></para>

      <para>Das dabei entstehende Binary iaxmodem kopieren wir zum Schluss mit
      <command>cp iaxmodem /usr/bin/</command> ins Verzeichnis
      <filename><filename>/usr/bin.</filename></filename></para>

      <para><screen>debian:/usr/src/iaxmodem-0.3.0# cp iaxmodem /usr/bin/
debian:/usr/src/iaxmodem-0.3.0# </screen></para>

      <para>Jetzt kommen wir zur Konfiguration des Modems. IAXmodem sucht
      seine Konfiguration im Verzeichnis <filename>/etc/iaxmodem</filename>.
      Dieses müssen wir jetzt mit <command>mkdir /etc/iaxmodem</command>
      anlegen<screen>debian:/usr/src/iaxmodem-0.3.0# mkdir /etc/iaxmodem
debian:/usr/src/iaxmodem-0.3.0# </screen></para>

      <para>Und mit <command>touch /etc/iaxmodem/ttyIAX0</command> in ihm eine
      Datei erzeugen, in der die Konfiguration steht.<screen>debian:/usr/src/iaxmodem-0.3.0# touch /etc/iaxmodem/ttyIAX0
debian:/usr/src/iaxmodem-0.3.0# </screen></para>

      <para>In dieser Datei müssen folgende Parameter angegeben werden:</para>

      <para><variablelist termlength="9">
          <varlistentry>
            <term><code>device</code></term>

            <listitem>
              <simpara>Das ist das Device, das im <filename>/dev</filename>
              Verzeichnis angelegt wird. Über dieses Device kann später
              Hylafax auf das Modem zugreifen. Der Name des Devices ist frei
              wählbar, wir halten uns aber an die allgemeinen Konventionen und
              nennen es äquivalent zum Device für die serielle Schnittstelle
              ttyIAX0.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>owner</code></term>

            <listitem>
              <simpara>Das ist der Eigentümer des Devices in der Form
              <code><replaceable>user</replaceable>:<replaceable>group</replaceable></code>.
              Es sollte derselbe User und dieselbe Gruppe sein, unter der
              Hylafax laufen soll.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>port</code></term>

            <listitem>
              <simpara>Der Port, auf dem das IAXmodem lauscht. Da Asterisk auf
              Port 4569 auf IAX2-Verbindungen hört, sollte man hier einen
              anderen Port verwenden, z.B. 4570.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>refresh</code></term>

            <listitem>
              <simpara>Das Intervall, nach dem sich das Modem erneut bei
              Asterisk registriert. Wenn dieses auf 0 steht, registriert sich
              das Modem nicht bei Asterisk.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>server</code></term>

            <listitem>
              <simpara>Der Server, auf dem der Asterisk läuft. Wenn der Server
              derselbe ist, auf dem auch das IAXmodem läuft, steht hier die
              lokale Adresse 127.0.0.1.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>peername</code></term>

            <listitem>
              <simpara>Der Name, unter dem sich das IAXmodem bei Asterisk
              registriert.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>secret</code></term>

            <listitem>
              <simpara>Das Passwort zur Registrierung am Asterisk</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>codec</code></term>

            <listitem>
              <simpara>Der Codec, der vom IAXmodem verwendet wird. Erlaubt
              sind hier <code>alaw</code>, <code>ulaw</code> und
              <code>slinear</code>. Andere machen hier auch wenig Sinn, da
              diese komprimieren und die Übertragung dadurch nicht verlustfrei
              ist. Bei reiner Sprachübertragung wirkt sich das für einen
              Menschen nicht negativ aus, bei Faxübertragungen aber hätte es
              störende Fehler zur Folge.</simpara>
            </listitem>
          </varlistentry>
        </variablelist></para>

      <para>Mit einem beliebigen Editor (z.B. vi) schreiben wir die folgende
      Konfiguration in die Datei
      <filename>/etc/iaxmodem/ttyIAX0</filename><programlisting>device          /dev/ttyIAX0
owner           uucp:uucp
mode            660
port            4570
refresh         50
server          127.0.0.1
peername        iaxmodem
secret          password
codec           alaw
</programlisting></para>

      <para>Jetzt ist das IAXmodem fertig konfiguriert und muss gestartet
      werden. Dies geschieht am besten über den init-Prozess. Also fügen wir
      mit <command>echo "IA00:23:respawn:/usr/bin/iaxmodem ttyIAX0" &gt;&gt;
      /etc/inittab</command> den entsprechenden Eintrag der Datei
      <filename>/etc/inittab</filename> hinzu:<screen>debian:/usr/src/iaxmodem-0.3.0# echo "IA00:23:respawn:/usr/bin/iaxmodem ttyIAX0" &gt;&gt; /etc/inittab 
debian:/usr/src/iaxmodem-0.3.0#</screen></para>

      <para>Wobei <parameter>ttyIAX0</parameter> der Name der
      Konfigurationsdatei unter <filename>/etc/iaxmodem</filename> ist.</para>

      <para>Zum Faxempfang benötigen man einen getty, der am IAXmodem auf
      Verbindungen lauscht. Das erreicht man ganz einfach durch einen weiteren
      Eintrag in der Datei <filename>/etc/inittab</filename>. Dieser kann mit
      <command>echo "mo00:23:respawn:/usr/sbin/faxgetty ttyIAX0" &gt;&gt;
      /etc/inittab</command> erstellt werden.<screen>mo00:23:respawn:/usr/local/sbin/faxgetty ttyIAX0</screen></para>

      <para>Damit iaxmodem in die Logdateien schreiben kann, legen wir den
      Ordner mit <command>mkdir /var/log/iaxmodem/ </command>an und erstellen
      die Logdateien ttyIAX0 und iaxmodem mit jeweils dem Befehl
      <command>touch /var/log/iaxmodem/ttyIAX0</command> und <command>touch
      /var/log/iaxmodem/iaxmodem</command>.</para>

      <para><screen>debian:/usr/src/iaxmodem-0.3.0# mkdir /var/log/iaxmodem/
debian:/usr/src/iaxmodem-0.3.0# touch /var/log/iaxmodem/ttyIAX0
debian:/usr/src/iaxmodem-0.3.0# touch /var/log/iaxmodem/iaxmodem 
debian:/usr/src/iaxmodem-0.3.0#</screen></para>

      <para>Um ganz sicher zu gehen rebooten wir jetzt noch einmal mit
      <command>shutdown -r now</command> den Rechner, damit init auch das
      IAXmodem richtig startet.<screen>debian:/usr/src/iaxmodem-0.3.0# shutdown -r now

Broadcast message from root@debian (pts/1) (Sat May  5 00:15:49 2007):

The system is going down for reboot NOW!
debian:/usr/src/iaxmodem-0.3.0# </screen></para>
    </section>

    <section id="installation-hylafax">
      <title>Installation Hylafax</title>

      <para>Um die Installation zu vereinfachen installieren wir den Faxserver
      aus dem Debian Repository mit <command>apt-get -y install hylafax-server
      .</command> Abhängigkeiten werden automatisch aufgelöst:<screen>debian:~# apt-get install -y hylafax-server
Paketlisten werden gelesen... Fertig
Abhängigkeitsbaum wird aufgebaut... Fertig
Die folgenden zusätzlichen Pakete werden installiert:
  enscript gs-common gs-esp hylafax-client libcupsimage2 libcupsys2 mailx metamail psmisc
Vorgeschlagene Pakete:
  gv postscript-viewer lpr gs-pdfencrypt gs-cjk-resource mgetty-viewfax hylafax-doc mgetty cupsys-common
Empfohlene Pakete:
  psfontmgr netpbm transfig
Die folgenden NEUEN Pakete werden installiert:
  enscript gs-common gs-esp hylafax-client hylafax-server libcupsimage2 libcupsys2 mailx metamail psmisc

[...]

Update /var/spool/hylafax/status/any.info.

        HylaFAX configuration parameters are:

        [1] Init script starts faxq:            yes
        [2] Init script starts hfaxd            yes
        [3] Start old protocol:                 no
        [4] Start paging protocol:              no
Are these ok [yes]? 
Modem support functions written to /var/spool/hylafax/etc/setup.modem.
Configuration parameters written to /var/spool/hylafax/etc/setup.cache.

Restarting HylaFAX server processes.

Should I restart the HylaFAX server processes [yes]? 
You do not appear to have any modems configured for use.  Modems are
configured for use with HylaFAX with the faxaddmodem(8) command.
Do you want to run faxaddmodem to configure a modem [yes]? 
Done verifying system setup.
Updating /etc/hylafax/setup.cache from /var/spool/hylafax/etc/setup.cache.
Updating /etc/hylafax/setup.modem from /var/spool/hylafax/etc/setup.modem.apt-get -y install hylafax-server
/var/spool/hylafax
Starting HylaFAX: faxq hfaxd faxgetty.

debian:~#</screen></para>

      <tip>
        <para><footnote>
            <para>Damit ist sichergestellt, dass auch das Kleingedruckte noch
            gut zu lesen ist. ;-)</para>
          </footnote></para>
      </tip>

      <para>Der nächste Schritt ist das Setup des Faxservers. Hierzu rufen wir
      das Programm <command>faxsetup</command> auf:<screen>debian:/usr/src/hylafax-4.3.4# faxsetup

[...]

Update /var/spool/hylafax/status/any.info.

        HylaFAX configuration parameters are:

        [1] Init script starts faxq:            yes
        [2] Init script starts hfaxd            yes
        [3] Start old protocol:                 no
        [4] Start paging protocol:              no

Are these ok [yes]?</screen></para>

      <para>Jetzt bestätigen wir den Restart des Serverprozesses mit zwei male
      mit <userinput>yes</userinput> und werden gefragt, ob wir ein Modem
      installieren wollen. Da unser IAXmodem bereits eingerichtet ist, können
      wir hier direkt weitermachen und bestätigen wieder mit
      <userinput>yes</userinput>.</para>

      <para>Fragen über Fragen, aber nur die wenigsten sind wirklich
      wichtig.<footnote>
          <para>Mögen die Leute verzeihen, die schon einmal ein Hylafax getunt
          haben, aber für den Anfang reichen die Defaults.</para>
        </footnote> Wichtig sind natürlich die Faxnummer und der sogenannte
      LocalIdentifier. Das ist der Text, der auf jedem gesendeten Fax in der
      obersten Zeile steht.</para>

      <para>Bei den folgenden 2-3 Fragen einfach immer Enter drücken.<screen>You have a HylaFAX scheduler process running.  faxq will be
restarted shortly, as soon as some other work has been completed.
Can I terminate this faxq process (4048) [yes]?
Should I restart the HylaFAX server processes [yes]?

/etc/init.d/hylafax start
Not starting HylaFAX daemons since they are already running.

[...]

Modems are configured for use with HylaFAX with the faxaddmodem(8) command.
Do you want to run faxaddmodem to configure a modem [yes]? </screen></para>

      <para>Jetzt bestätigen wir den Restart des Serverprozesses mit zwei
      <userinput>yes</userinput> und werden gefragt, ob wir ein Modem
      installieren wollen. Da unser IAXmodem bereits eingerichtet ist, können
      wir hier direkt weitermachen und bestätigen wieder mit
      <userinput>yes</userinput>.</para>

      <para>Hier geben wir das Modem an und bestätigen es mit Enter.</para>

      <para><screen>Serial port that modem is connected to [ttyS0]? ttyIAX0

Ok, time to setup a configuration file for the modem.  The manual
page config(5) may be useful during this process.  Also be aware
that at any time you can safely interrupt this procedure.

Reading scheduler config file /var/spool/hylafax/etc/config.</screen></para>

      <para>Fragen über Fragen, aber nur die wenigsten sind für uns
      relevant.<footnote>
          <para>Mögen die Leute verzeihen, die schon einmal ein Hylafax getunt
          haben, aber für den Anfang reichen die Defaults.</para>
        </footnote>Bei den folgenden Einstellungen müssen Sie die für Ihre
      Installation geeigneten Werte (also z.B. die Internationale Vorwahl 49
      für Deutschland) eingeben. Wichtig sind natürlich die Faxnummer und der
      sogenannte LocalIdentifier. Das ist der Text, der auf jedem gesendeten
      Fax in der obersten Zeile steht.</para>

      <para>Dabei sind bei den meisten Installationen nur die ersten sechs
      Fragen wichtig. Die erste betrifft die Landesvorwahl als zweistellige
      Zahl, für Deutschland also die <code>49</code>. Dann folgt die
      Ortsnetznummer ohne führende Null, in diesem Beispiel die
      <code>69</code> für Frankfurt am Main. Daraufhin die Faxnummer, mit
      Vorwahl. Dann eine Null für Ferngespräche und zwei Nullen für
      internationale Gespräche. Am Schluss mit <userinput>yes</userinput>
      bestätigen.</para>

      <screen>No existing configuration, let's do this from scratch.

Country code [1]? 49
Area code []? 69
Phone number of fax modem [+1.999.555.1212]? +49 69 12345678
Local identification string (for TSI/CIG) ["NothingSetup"]? 
Long distance dialing prefix [1]? 0
International dialing prefix [011]? 00
Dial string rules file (relative to /var/spool/hylafax) [etc/dialrules]? 
Tracing during normal server operation [1]? 
Tracing during send and receive sessions [11]? 
Protection mode for received facsimile [0600]? 
Protection mode for session logs [0600]? 
Protection mode for ttyIAX0 [0600]? 
Rings to wait before answering [1]? 
Modem speaker volume [off]? 
Command line arguments to getty program ["-h %l dx_%s"]? 
Pathname of TSI access control list file (relative to /var/spool/hylafax) [""]? 
Pathname of Caller-ID access control list file (relative to /var/spool/hylafax) [""]? 
Tag line font file (relative to /var/spool/hylafax) [etc/lutRS18.pcf]? 
Tag line format string ["From %%l|%c|Page %%P of %%T"]? 
Time before purging a stale UUCP lock file (secs) [30]? 
Hold UUCP lockfile during inbound data calls [Yes]? 
Hold UUCP lockfile during inbound voice calls [Yes]? 
Percent good lines to accept during copy quality checking [95]? 
Max consecutive bad lines to accept during copy quality checking [5]? 
Max number of pages to accept in a received facsimile [25]? 
Syslog facility name for ServerTracing messages [daemon]?
Set UID to 0 to manipulate CLOCAL [""]? 
Use available priority job scheduling mechanism [""]?</screen>

      <para>Es folgt eine Übersicht Seiten, wo Sie nochmals mit yes die Daten
      bestätigen können:</para>

      <screen>The non-default server configuration parameters are:

CountryCode:            49
AreaCode:               69
FAXNumber:              +49 69 12345678
LongDistancePrefix:     0
InternationalPrefix:    00
DialStringRules:        etc/dialrules
SessionTracing:         11
RingsBeforeAnswer:      1
SpeakerVolume:          off
GettyArgs:              "-h %l dx_%s"
LocalIdentifier:        "NothingSetup"
TagLineFont:            etc/lutRS18.pcf
TagLineFormat:          "From %%l|%c|Page %%P of %%T"
MaxRecvPages:           25

Are these ok [yes]?</screen>

      <para>Yes bringt uns weiter zur Modemerkennung.</para>

      <screen>Now we are going to probe the tty port to figure out the type
of modem that is attached.  This takes a few seconds, so be patient.
Note that if you do not have the modem cabled to the port, or the
modem is turned off, this may hang (just go and cable up the modem
or turn it on, or whatever).

Probing for best speed to talk to modem: 38400 OK.

About fax classes:

The difference between fax classes has to do with how HylaFAX interacts
with the modem and the fax protocol features that are used when sending
or receiving faxes.  One class isn't inherently better than another;
however, one probably will suit a user's needs better than others.
    
Class 1 relies on HylaFAX to perform the bulk of the fax protocol.
Class 2 relies on the modem to perform the bulk of the fax protocol.
Class 2.0 is similar to Class 2 but may include more features.
Class 1.0 is similar to Class 1 but may add V.34-fax capability.
Class 2.1 is similar to Class 2.0 but adds V.34-fax capability.
      
HylaFAX generally will have more features when using Class 1/1.0 than
when using most modems' Class 2 or Class 2.0 implementations.  Generally
any problems encountered in Class 1/1.0 can be resolved by modifications
to HylaFAX, but usually any problems encountered in Class 2/2.0/2.1 will
require the modem manufacturer to resolve it.

If you're unsure and your modem supports it, use Class 1.

This modem looks to have support for Class 1 and 1.0.
How should it be configured [1]? 

Hmm, this looks like a Class 1 modem.
Product code (ATI0) is "spandsp".
Other information (ATI3) is "www.soft-switch.org".
DTE-DCE flow control scheme [default]? 
Modem manufacturer is "spandsp".
Modem model is "IAXmodem".

Using prototype configuration file iaxmodem...

The modem configuration parameters are:

ModemResetCmds:         "ATH1\nAT+VCID=1"

Are these ok [yes]?</screen>

      <para>Das Modem wurde erkannt und wir werden gefragt, ob es ein Class
      1-Modem ist. Da das genau das ist, was wir wollen, bestätigen wir. Auch
      das Reset-Kommando für das Modem können wir so übernehmen. Wenn alles in
      Ordnung ist, bestätigen wir mit <userinput>yes</userinput>.</para>

      <para>Im folgendem Dialog wird die erste Frage mit no beantwortet, da es
      kein weiteres Modem zu Konfigurieren gibt. Die zweite Frage wird mit
      enter bestätigt, was das neu starten des Fax Servers bewirkt.</para>

      <screen>Creating new configuration file /var/spool/hylafax/etc/config.ttyIAX0...
Creating fifo /var/spool/hylafax/FIFO.ttyIAX0 for faxgetty... done.
Done setting up the modem configuration.

[...]

Do you want to run faxaddmodem to configure another modem [yes]? no

[...]

Should I run faxmodem for each configured modem [yes]? 
/usr/sbin/faxmodem ttyIAX0

Done verifying system setup.
/var/spool/hylafax


debian:~#</screen>

      <para>Jetzt ist Hylafax zum Senden von Faxen eingerichtet.</para>
    </section>

    <section id="faxe-empfangen">
      <title>Faxe empfangen</title>

      <para>Jetzt muss diese Faxlösung noch in Asterisk integriert werden.
      Dazu müssen wir Asterisk das IAXmodem bekannt machen. Dies erreichen
      wir, indem wir es als IAX2-Peer definieren. Die dazu erforderliche Datei
      heißt <filename>/etc/asterisk/iax.conf</filename> (siehe auch <xref
      linkend="iax" />):</para>

      <programlisting>[general]
bindport = 4569           
bindaddr = 0.0.0.0    
disallow=all
allow=ulaw
allow=alaw

[iaxmodem]
type=friend
secret=password
port=4570
host=dynamic
context=fax-out
disallow=all
allow=alaw</programlisting>

      <para>Im Abschnitt <code>general</code> sind die globalen IAX2-Daten
      abgelegt. In diesem Beispiel wird der Bindport auf den Standart für IAX2
      4569 gesetzt. Die Bindadresse gibt das Interface an, auf dem IAX2
      lauscht, in diesem Falle auf allen Interfaces.</para>

      <para>In der Konfiguration für das IAXmodem wird der
      <parameter>type</parameter> auf <code>friend</code> gesetzt, d.h. es
      sind eingehende und ausgehende Verbindungen erlaubt.
      <parameter>secret</parameter> und <parameter>port</parameter>
      entsprechen der Konfiguration des IAXmodems, der
      <parameter>context</parameter> ist der, der bei einer ausgehenden
      Verbindung angesprochen wird.</para>

      <para>Mit dem Befehl <command>iax2 show peers</command> können wir jetzt
      in der Asterisk-Console (CLI) unser IAXmodem sehen:</para>

      <screen>*CLI&gt; iax2 show peers
Name/Username    Host                 Mask             Port          Status
iaxmodem         127.0.0.1       (D)  255.255.255.255  4570          Unmonitored
1 iax2 peers [0 online, 0 offline, 1 unmonitored]
*CLI&gt;
</screen>

      <para>Damit Asterisk weiß, was es mit einem ankommenden Fax anstellen
      soll, müssen wir eine entsprechende Extension schreiben. Das Ziel soll
      sein, dass ein ankommendes Fax direkt an das Hylafax weitergeleitet
      wird. In diesem Beispiel gehen wir davon aus, dass alle Faxe über einen
      SIP-Provider-Anschluss reinkommen. Eine entsprechende Konfiguration in
      der <filename>sip.conf</filename> kann wie folgt aussehen (die
      entsprechenden Einstellungen müssen natürlich an die jeweilige
      Installation und den SIP-Provider angepasst werden):</para>

      <programlisting>[...]

[123456]
type=friend
insecure=port,invite
nat=yes
username=123456
fromuser=12345
fromdomain=mein-voip-provider.de
secret=secret
host=mein-voip-provider.de
qualify=yes
context=fax-in

[...]</programlisting>

      <para>Der entsprechende Context in der
      <filename>extensions.conf</filename> sieht dann so aus:</para>

      <programlisting>[fax-in]
exten =&gt; _X.,1,Dial(IAX2/iaxmodem)</programlisting>

      <para>Jetzt wird das Fax vom Asterisk an Hylafax über IAXmodem übergeben
      und per Mail an den User gesendet, auf den das Mailalias
      <parameter>Faxmaster</parameter> zeigt.</para>
    </section>

    <section id="faxe-versenden">
      <title>Faxe versenden</title>

      <para>Der nächste Schritt ist das Versenden von Faxen. Auch hierfür
      brauchen wir einen Context (diesmal <code>[fax-out]</code>) in der
      <filename>extension.conf</filename>. Wenn das virtuelle IAXmodem ein Fax
      versenden will, kommt es automatisch in diesen Context. Sollen die Faxe
      dann über unsere Beispiel-SIP-Verbindung 123456 gefaxt werden, so sieht
      der Eintrag in der <filename>extensions.conf</filename> wie folgt
      aus:</para>

      <programlisting>[fax-out]
exten =&gt; _X.,1,Dial(SIP/123456/${EXTEN})</programlisting>

      <para>Testen können wir das Senden mit <command>sendfax -n -d
      &lt;Faxnummer&gt; &lt;datei.txt&gt;</command></para>

      <screen>debian:~# sendfax -n -d 06912345678 /etc/issue.net</screen>

      <para>Im CLI sollten wir jetzt Folgendes sehen:</para>

      <screen> -- Accepting AUTHENTICATED call from 127.0.0.1:
       &gt; requested format = alaw,
       &gt; requested prefs = (),
       &gt; actual format = alaw,
       &gt; host prefs = (alaw),
       &gt; priority = mine
    -- Executing Answer("IAX2/iaxmodem-3", "") in new stack
    -- Executing Dial("IAX2/iaxmodem-3", "SIP/123456/06912345678") in new stack
    -- Called 123456/06912345678
    -- SIP/123456-0818f630 is making progress passing it to IAX2/iaxmodem-3
    -- SIP/123456-0818f630 answered IAX2/iaxmodem-3
    -- parse_srv: SRV mapped to host mein-voip-provider.de, port 5060
  == Spawn extension (fax-out, 06912345678, 2) exited non-zero on 'IAX2/iaxmodem-3'
    -- Executing Hangup("IAX2/iaxmodem-3", "") in new stack
  == Spawn extension (fax-out, h, 1) exited non-zero on 'IAX2/iaxmodem-3'
    -- Hungup 'IAX2/iaxmodem-3'</screen>

      <para>Das Kommando <command>faxstat -s</command> gibt während des
      Sendens folgende Zeilen aus:</para>

      <screen>debian:~# faxstat -s
HylaFAX scheduler on w077.example.com: Running
Modem ttyIAX0 (123456): Sending job 7

JID  Pri S  Owner Number       Pages Dials     TTS Status
7    127 R   root 06912345678  0:1   0:12
debian:~# </screen>

      <para>Fertig! Jetzt können Sie über Asterisk mit Hylafax Faxe versenden
      und empfangen.</para>

      <para>Auf der Hylafax-Webseite <ulink
      url="http://www.hylafax.org">http://www.hylafax.org</ulink> finden Sie
      viele Hinweise und Howtos, wie Sie Ihren neuen Faxserver möglichst
      einfach in Ihre bestehende Büroinfrastruktur einbinden.</para>
    </section>

    <section id="fax-email-versand">
      <title>Empfangene Faxe als E-Mail versenden</title>

      <para>Im folgenden wird die die Hylafax Konfiguration so angepast, das
      der Faxserver eingehende Faxe an eine vorgegebene E-Mail Adresse
      versendet.<footnote>
          <para>Wir setzen einen richtig konfigurierten MTA (z.B. Sendmail
          oder Postfix) voraus.</para>
        </footnote> Der Empfänger soll das Fax als E-Mail Anhang
      erhalten.</para>

      <para>Dazu müssen in der Datei
      <filename>/var/spool/hylafax/etc/FaxDispatch</filename> die folgende
      Parameter angegeben werden:</para>

      <para><variablelist termlength="9">
          <varlistentry>
            <term><code>SENDTO</code></term>

            <listitem>
              <simpara>Empfänger der Eingehende Faxe.</simpara>
            </listitem>
          </varlistentry>

          <varlistentry>
            <term><code>FILETYPE</code></term>

            <listitem>
              <simpara>Format der Anhänge. Neben dem Format pdf, kann auch
              tiff oder ps gewählt werden.</simpara>
            </listitem>
          </varlistentry>
        </variablelist></para>

      <para><programlisting>SENDTO=fax-incoming@company.com
FILETYPE=pdf</programlisting></para>

      <para>Nachdem die Datei abgespeichert ist, muss der Faxserver mit
      <command>/etc/init.d/hylafax restart</command> neu gestartet
      werden.</para>

      <para><screen>debian:~# /etc/ini.d/hylafax restart
Starting HylaFAX: faxq hfaxd.
debian:~# </screen>Testen können wir es, in wir uns z.B selbst ein Fax senden
      mit <command>sendfax -n -d &lt;Faxnummer&gt;
      &lt;datei.txt&gt;</command></para>

      <screen>debian:~# sendfax -n -d 06912345678 /etc/issue.net</screen>

      <para>Nach kurze Zeit sollten Sie eine E-Mail in der folgende Form
      empfangen:</para>

      <programlisting> recvq/fax000000016.tif (ftp://debian:4559/recvq/fax000000016.tif):                                  
          Sender: IAXmodem
           Pages: 4
         Quality: Normal
            Size: North American Letter
        Received: 2007:06:02 02:49:45
 Time To Receive: 1:58
     Signal Rate: 9600 bit/s
     Data Format: 2-D MMR
   Error Correct: Yes
         CallID1: 2007
         CallID2: IAXmodem 1
     Received On: ttyIAX0
          CommID: 000000033 (ftp://debian:4559/log/c000000033)

[...]


Jun 02 02:51:46.99: [ 3320]: RECV FAX: bin/faxrcvd "recvq/fax000000016.tif" "ttyIAX0" "000000033" "COMREC received DCN" "2007" "IAXmodem 1" "&lt;NONE&gt;" "s"
Jun 02 02:51:47.00: [ 3320]: RECV FAX: end
Jun 02 02:51:47.00: [ 3320]: SESSION END
Jun 02 02:51:47.01: [ 3320]: RECV FAX (000000033): recvq/fax000000016.tif from IAXmodem, route to &lt;unspecified&gt;, 4 pages in 2:08</programlisting>

      <para>Im Anhang finden Sie dann eine pdf Datei vor die in diesem
      Beispiel <filename>fax000000016.pdf</filename> heißen würde.</para>

      <para>Fertig! Jetzt können Sie über Asterisk mit Hylafax Faxe versenden
      und empfangene Faxe nun auch als E-Mail Anhang erhalten.</para>
    </section>

    <section id="faxserver-faq">
      <title>IAXmodem und Hylafax FAQ</title>

      <qandaset>
        <qandadiv>
          <qandaentry>
            <question>
              <para>Wo legt Hylafax die Empfangene Faxe ab?</para>
            </question>

            <answer>
              <para>Diese liegen im Ordner /var/spool/hylafax/recvq .</para>
            </answer>
          </qandaentry>

          <qandaentry>
            <question>
              <para>Kann man anstatt Hylafax auch andere Faxserversoftware
              einsetzen?</para>
            </question>

            <answer>
              <para>Ja, selbstverständlich. Allerdings hat sich Hylafax sehr
              bewährt.</para>
            </answer>
          </qandaentry>

          <qandaentry>
            <question>
              <para>Gibt es einen einfachen Faxclient für Windows?</para>
            </question>

            <answer>
              <para>Ja, bitte schauen Sie für eine Liste aller Clients (auch
              für andere Betriebssysteme) auf <ulink
              url="http://www.hylafax.org/content/Client_Software">http://www.hylafax.org/content/Client_Software</ulink>.</para>
            </answer>
          </qandaentry>

          <qandaentry>
            <question>
              <para>Gibt es zu Hylafax ein eigenes FAQ?</para>
            </question>

            <answer>
              <para>Ja, dieses finden Sie unter <ulink
              url="http://www.hylafax.org/content/FAQ">http://www.hylafax.org/content/FAQ</ulink>.</para>
            </answer>
          </qandaentry>
        </qandadiv>
      </qandaset>
    </section>
  </section>
</chapter>
