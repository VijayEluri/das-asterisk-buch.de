<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<section id="beronet-berofix" lang="de" revision="$Revision:473 $">
  <!--% Copyright (c) 2009 - 2010 by 
% Stefan Wintermeyer <sw@amooma.de>
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
% Asterisk training and consulting is offered at http://www.amooma.de-->

  <?dbhtml stop-chunking?>

  <sectioninfo>
    <indexterm>
      <primary>BeroFix</primary>

      <secondary>BeroNet</secondary>
    </indexterm>

    <indexterm>
      <primary>BeroNet</primary>

      <secondary>BeroFix</secondary>
    </indexterm>

    <date>$Revision$</date>

    <author>
      <firstname>Stefan</firstname>

      <surname>Wintermeyer</surname>
    </author>

    <keywordset>
      <keyword>BeroNet</keyword>

      <keyword>BeroFix</keyword>

      <keyword>Installation</keyword>
    </keywordset>
  </sectioninfo>

  <title>Installation einer BeroFix-Karte</title>

  <indexterm>
    <primary>Installation</primary>

    <secondary>BeroNet BeroFix</secondary>
  </indexterm>

  <indexterm>
    <primary>BeroNet</primary>

    <secondary>BeroFix</secondary>
  </indexterm>

  <warning>
    <para>Dieses Kapitel ist noch nicht fertiggestellt (<emphasis>work in
    progress</emphasis>). Bitte melden Sie eventuelle Fehler oder
    Verbesserungswünsche an stefan.wintermeyer@amooma.de</para>
  </warning>

  <para>Die 2009 von <ulink url="http://www.beronet.com">beroNet</ulink>
  vorgestellte BeroFix-ISDN-Karten-Serie geht einen anderen Weg als klassische
  ISDN-Karten. Die beroFix agiert als eigenständiges Media-Gateway und wird
  vom System aus nicht wie eine ISDN- sondern wie eine Netzwerk-Karte
  angesprochen. Die Kommunikation mit Asterisk erfolgt dann normal per
  SIP-Protokoll. Die Vorteile liegen auf der Hand: Man ist bei Asterisk- oder
  Kernel-Updates nicht darauf angewiesen, dass man auch einen passenden
  ISDN-Treiber bekommt.</para>

  <para>Diese Installationsanleitung dient zur Installation eines
  Asterisk-Systems mit einer beroNet beroFix ISDN-Karte. Die Karte muss dafür
  bereits in dem System eingebaut sein.</para>

  <note>
    <para>Die hier aufgeführte Installationsanleitung gilt für ein
    Asterisk-System mit allen in diesem Buch beschriebenen Features (bei
    Ausnahmen wird dies gesondert besprochen). Deshalb ist die Installation
    etwas umfangreicher. Das hat aber auch den Vorteil, dass Sie in der
    Zukunft nicht noch einmal etwas nachinstallieren müssen.</para>
  </note>

  <para>Es wird ein frisch installiertes Debian GNU/Linux 4
  (<quote>Etch</quote>) vorausgesetzt.</para>

  <sidebar>
    <para>Ein ISO-Image für die Installation finden Sie auf <ulink
    url="http://www.debian.org/releases/etch/debian-installer/">http://www.debian.org/releases/etch/debian-installer/</ulink>.
    Ich empfehle das etwa 140 MB große Netzinstallations-CD-Image. Eine Debian
    GNU/Linux-Installationsanleitung befindet sich unter <ulink
    url="http://www.debian.org/releases/etch/i386/">http://www.debian.org/releases/etch/i386/</ulink>.
    Ein allgemeines Anwenderhandbuch steht unter <ulink
    url="http://debiananwenderhandbuch.de/">http://debiananwenderhandbuch.de</ulink>.</para>
  </sidebar>

  <para><emphasis>Bitte loggen Sie sich nach der Installation als Benutzer
  <literal>root</literal> am System ein, und führen Sie alle hier angegebenen
  Befehle mit diesem Benutzer aus.</emphasis></para>

  <para>Als Erstes stellen Sie sicher, dass <code>apt</code> alle aktuellen
  Paketlisten zur Verfügung hat:<screen>debian:~# <emphasis role="bold"><command>apt-get update</command></emphasis>
Hole:1 http://ftp.de.debian.org etch Release.gpg [378B]
Hole:2 http://security.debian.org etch/updates Release.gpg [189B]
OK   http://ftp.de.debian.org etch Release                      
<replaceable>[...]</replaceable>
Es wurden 2B in 0s geholt (3B/s)   
Paketlisten werden gelesen... Fertig
debian:~# </screen></para>

  <para>Um sicherzugehen, dass alle Pakete auf dem neuesten Stand sind, führen
  Sie noch ein Upgrade aus:<screen>debian:~# <emphasis role="bold"><command>apt-get -y upgrade</command></emphasis>
Paketlisten werden gelesen... Fertig
Abhängigkeitsbaum wird aufgebaut... Fertig
0 aktualisiert, 0 neu installiert, 0 zu entfernen und 0 nicht aktualisiert.
debian:~# </screen></para>

  <para>Für den Fall, dass beim Upgrade der Pakete auch ein neuer Kernel
  installiert wurde, müssen Sie jetzt das System rebooten:<screen>debian:~# <emphasis
        role="bold"><command>shutdown -r now</command></emphasis>
<replaceable>[...]</replaceable>
The system is going down for reboot NOW!</screen></para>

  <para>Loggen Sie sich nach dem Booten bitte wieder als <code>root</code>
  ein.</para>

  <para>Jetzt müssen Sie noch ein paar Pakete nachinstallieren, damit das
  Kompilieren von Asterisk erfolgreich durchgeführt werden kann:</para>

  <screen>debian:~# <emphasis role="bold"><command>apt-get -y install build-essential \
    libncurses5-dev libcurl3-dev libnewt-dev libusb-dev \
    libvorbis-dev libspeex-dev unixodbc unixodbc-dev \
    libiksemel-dev linux-headers-`uname -r` flex bc pciutils bridge-utils</command></emphasis>
<replaceable>[...]</replaceable>
Die folgenden NEUEN Pakete werden installiert:
  bc binutils build-essential ca-certificates 
  comerr-dev cpp cpp-4.1 defoma dpkg-dev file flex 
  fontconfig fontconfig-config g++ g++-4.1 gcc gcc-4.1 bridge-utils
<replaceable>[...]</replaceable>
debian:~# </screen>

  <para>Als Nächstes wechseln Sie in das Verzeichnis
  <filename>/usr/src:</filename><screen>debian:~# <emphasis role="bold"><command>cd /usr/src</command></emphasis>
debian:/usr/src# </screen></para>

  <para>Auf der Asterisk-Homepage <ulink
  url="http://www.asterisk.org/">http://www.asterisk.org/</ulink> finden Sie
  die notwendigen Quellen, um Asterisk mit allen sinnvollen Extras zu
  installieren. Nehmen Sie bitte eine <emphasis role="bold">stabile</emphasis>
  und keine Entwickler-Version, und laden Sie diese in das Verzeichnis
  <filename>/usr/src/</filename> herunter:</para>

  <screen>debian:/usr/src# <emphasis role="bold"><command>wget http://downloads.digium.com/pub/asterisk/releases/asterisk-1.4.19.2.tar.gz</command></emphasis>
<replaceable>[...]</replaceable>
18:53:47 (227.00 KB/s) - »asterisk-1.4.19.2.tar.gz« gespeichert
debian:/usr/src# </screen>

  <para>Die komprimierten Dateien werden jetzt entpackt:<screen>debian:/usr/src# <emphasis
        role="bold"><command>tar xvzf asterisk-1.4.19.2.tar.gz</command></emphasis>
asterisk-1.4.19.2/
asterisk-1.4.19.2/build_tools/
asterisk-1.4.19.2/build_tools/menuselect-deps.in
<replaceable>[...]</replaceable>
debian:/usr/src# </screen></para>

  <para>Als erstes gehen Sie in das Asterisk-Verzeichnis und kompilieren und
  installieren Asterisk:<screen>debian:/usr/src# <emphasis role="bold"><command>cd /usr/src/asterisk-1.4.19.2</command></emphasis>
debian:/usr/src/asterisk-1.4.19.2# <emphasis role="bold"><command>./configure &amp;&amp; make &amp;&amp; make install</command></emphasis>
checking build system type... i686-pc-linux-gnu
checking host system type... i686-pc-linux-gnu
checking for gcc... gcc
checking for C compiler default output file name... a.out
checking whether the C compiler works... yes
<replaceable>[...]</replaceable>
make[1]: Leaving directory `/usr/src/asterisk-1.4.19.2/main'
 +---- Asterisk Installation Complete -------+
 +                                           +
 +    YOU MUST READ THE SECURITY DOCUMENT    +
 +                                           +
 + Asterisk has successfully been installed. +
 + If you would like to install the sample   +
 + configuration files (overwriting any      +
 + existing config files), run:              +
 +                                           +
 +               make samples                +
 +                                           +
 +-----------------  or ---------------------+
 +                                           +
 + You can go ahead and install the asterisk +
 + program documentation now or later run:   +
 +                                           +
 +              make progdocs                +
 +                                           +
 + **Note** This requires that you have      +
 + doxygen installed on your local system    +
 +-------------------------------------------+
debian:/usr/src/asterisk-1.4.19.2# </screen></para>

  <para>Die eben kompilierten Programmdateien sind jetzt auf dem System
  installiert. Allerdings finden Sie im Asterisk-Konfigurationsverzeichnis
  <filename>/etc/asterisk/</filename> noch gähnende Leere vor. In diesem
  Verzeichnis liegen die Konfigurationsdateien von Asterisk. Da Sie sicher
  nicht bei null beginnen möchten, lassen Sie sich die Standarddateien
  erstellen:</para>

  <screen>debian:/usr/src/asterisk-1.4.19.2# <emphasis role="bold"><command>make samples</command></emphasis>
<replaceable>[...]</replaceable>
debian:/usr/src/asterisk-1.4.19.2# </screen>

  <para>Damit Asterisk beim Booten des Rechners auch automatisch gestartet und
  bei einem Shutdown auch ordentlich heruntergefahren wird, benötigen wir noch
  entsprechende Init-Skripte. Diese können mit dem von den Entwicklern etwas
  unglücklich benannten Befehl <literal><command>make
  config</command></literal> erstellt werden:<screen>debian:/usr/src/asterisk-1.4.19.2# <emphasis
        role="bold"><command>make config</command></emphasis>
 Adding system startup for /etc/init.d/asterisk ...
   /etc/rc2.d/K91asterisk -&gt; ../init.d/asterisk
   /etc/rc3.d/K91asterisk -&gt; ../init.d/asterisk
   /etc/rc4.d/K91asterisk -&gt; ../init.d/asterisk
   /etc/rc5.d/K91asterisk -&gt; ../init.d/asterisk
   /etc/rc2.d/S50asterisk -&gt; ../init.d/asterisk
   /etc/rc3.d/S50asterisk -&gt; ../init.d/asterisk
   /etc/rc4.d/S50asterisk -&gt; ../init.d/asterisk
   /etc/rc5.d/S50asterisk -&gt; ../init.d/asterisk
debian:/usr/src/asterisk-1.4.19.2# </screen></para>

  <para>Fertig! Asterisk ist auf Ihrem System installiert. Mit dem Befehl
  <command>asterisk -V</command> können Sie die installierte Version
  herausfinden (bitte achten Sie auf das großgeschriebene V):<screen>debian:/usr/src/asterisk-1.4.19.2# <emphasis
        role="bold"><command>asterisk -V</command></emphasis>
Asterisk 1.4.19.2
debian:/usr/src/asterisk-1.4.19.2# cd
debian:~# </screen></para>

  <section id="beronet-berofix-konfiguration">
    <title>Konfiguration der ISDN-Karte</title>

    <para>Die beroFix-Karte benutzt einen <ulink
    url="http://en.wikipedia.org/wiki/Realtek">Realtek</ulink>-8139-Netzwerkchip
    um mit dem Asterisk-<quote>Wirtssystem</quote> (<emphasis>host
    system</emphasis>) zu kommunizieren. Deshalb ist es nicht notwendig
    spezielle Treiber zu kompilieren; der Netzwerkkartentreiber wird vom
    Betriebsystem mitgeliefert. Das Schema für eine beroFix-Karte sieht etwa
    so aus:</para>

    <literallayout> LAN &lt;———&gt; Netzwerkkarte (eth0) &lt;—&gt; PC &lt;—&gt; BeroFix-Netzwerkkarte (eth1) &lt;———&gt; BeroFix-CPU</literallayout>

    <para>Das bedeutet der Host erhält durch die BeroFix eine weitere
    Netzwerkkarte, die einer IP-Konfiguration bedarf. In solch einem Scenario
    bietet sich die Konfiguration durch eine Ethernet Bridge an, die die
    beiden Netzwerk-Interfaces <literal>eth0</literal> und
    <literal>eth1</literal> zu einem <emphasis>bridge device</emphasis>
    <literal>br0</literal> zusammenfasst.</para>

    <para>Folgenden Schritte sind nötig um eine beroFix richtig zu
    installieren:</para>

    <para><orderedlist>
        <listitem>
          <para>Netzwerk-Brücke einrichten</para>
        </listitem>

        <listitem>
          <para>SIP, ISDN und Routing einrichten</para>
        </listitem>

        <listitem>
          <para>SIP-Peer in Asterisk einrichten</para>
        </listitem>
      </orderedlist></para>

    <section id="beroNet-beroFix-netzwerkbruecke">
      <title>Netwerkbrücke einrichten</title>

      <para>Zunächst sollten sie mit <literal><command>ifconfig
      -a</command></literal> prüfen ob die Karte vom System als zweite
      Netzwerkkarte erkannt wurde:</para>

      <para><screen>debian:~# <emphasis role="bold"><command>ifconfig -a</command></emphasis>
eth0      Link encap:Ethernet  HWaddr 00:0C:6E:D3:86:C6  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:797562 errors:0 dropped:0 overruns:0 frame:0
          TX packets:35206 errors:20 dropped:0 overruns:0 carrier:20
          collisions:7447 txqueuelen:1000 
          RX bytes:141351732 (134.8 MiB)  TX bytes:19431622 (18.5 MiB)
          Interrupt:11 Base address:0xc000 

eth1      Link encap:Ethernet  HWaddr 00:50:C2:83:D0:01
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:35124 errors:0 dropped:0 overruns:0 frame:0
          TX packets:276362 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:20636164 (19.6 MiB)  TX bytes:28931756 (27.5 MiB)
          Interrupt:11 Base address:0xa000 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:9 errors:0 dropped:0 overruns:0 frame:0
          TX packets:9 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:720 (720.0 b)  TX bytes:720 (720.0 b)
</screen></para>

      <para>Sie erkennen die beroFix an der MAC-Adresse, diese sollte mit
      <code>00:50:C2</code> beginnen. In diesem Beispiel ist beroFix
      eth1.</para>

      <para>Um die Netzwerkbrücke manuell einzurichten können sie die
      bridge-utils verwenden und müssen ein paar Kommandozeilen
      eingeben:</para>

      <para><screen>debian:~# ifconfig eth0 0.0.0.0 up
debian:~# ifconfig eth1 0.0.0.0 up
debian:~# brctl addbr br0
debian:~# brctl addif br0 eth0
debian:~# brctl addif br0 eth1
debian:~# ifconfig br0 10.0.0.3 up 
</screen></para>

      <para>Diese Kommandos entfernen die IP Addressen der Netzwerkkarten,
      erzeugen eine Brücke <emphasis role="bold">br0</emphasis>, fügen der
      Brücke die beiden Netzwerkkarten hinzu und geben der Brücke die IP
      Addresse <emphasis role="bold">10.0.0.3</emphasis></para>

      <para>Um die Netzwerk Konfiguration für die Brücke persistent
      einzurichten, erweitern sie die Konfigurationsdatei
      <filename>/etc/network/interfaces</filename> mit einem Texteditor wie
      folgt:</para>

      <para><programlisting>auto lo
iface lo inet loopback
  
auto br0
iface br0 inet static
  address 10.0.0.3
  netmask 255.0.0.0
  gateway 10.0.0.1
  bridge_ports eth0 eth1
</programlisting></para>

      <para>Nun können sie mit <command>/etc/init.d/networking
      restart</command> die Netzwerk Konfiguration aktivieren.</para>

      <para><screen>debian:~# /etc/init.d/networking restart
     * Reconfiguring network interfaces...                       [ OK ]
</screen></para>

      <para>Die default IP Addresse von beroFix ist <emphasis
      role="bold">10.0.0.2</emphasis>. Es sollte nun möglich sein die
      Weboberfläche von berofix zu erreichen, tippen sie dazu einfach in einem
      browser: <command>http://10.0.0.2</command> ein. Der standard Username
      ist "admin" und das standard Passwort ebenfalls "admin".</para>
    </section>

    <section id="beroNet-beroFix-sip-isdn-routing">
      <title>SIP ISDN und Routing einrichten</title>

      <para>beroFix wird vollständig über die Web-Benutzeroberfläche
      konfiguriert, loggen sie sich dazu bitte mit einem browser auf
      <command>http://10.0.0.2</command> mit den Benutzerdaten "admin:admin"
      ein. Sie werden nun eine Weboberfläche mit den folgenden Menupunkten
      sehen:<itemizedlist>
          <listitem>
            <para><emphasis role="bold">Hardware</emphasis> - zum Einrichten
            von ISDN Parametern wie TE/NT, PTP und PMP</para>
          </listitem>

          <listitem>
            <para><emphasis role="bold">ISDN</emphasis> - zum Gruppieren von
            ISDN Ports</para>
          </listitem>

          <listitem>
            <para><emphasis role="bold">SIP</emphasis> - zum Verwalten von SIP
            Servern</para>
          </listitem>

          <listitem>
            <para><emphasis role="bold">Dialplan</emphasis> - zum Verwalten
            des Routings</para>
          </listitem>
        </itemizedlist></para>

      <para>Zunächst sollten sie die ISDN Hardware prüfen und entsprechend
      ihrem Anschluss konfigurieren. TE und NT wird auf der Karte automatisch
      umgeschaltet, so dass keine Jumperung oder gekreuzte Kabel nötig sind.
      Als nächstes sollten sie eine ISDN Gruppe anlegen, vergeben sie einfach
      als Namen "BRI".</para>

      <para>Nun können sie einen SIP Server einrichten, erstellen sie einen
      neuen Eintrag unter dem Menupunkt "SIP" mit den Werten: Name="berofix",
      User="berofix", Secret="berofix".</para>
    </section>

    <section id="beroNet-beroFix-asterisk-sip-peer">
      <title>Asterisk SIP Peer einrichten</title>

      <para>Unter Asterisk wird beroFix wie ein SIP Gateway angesprochen,
      deshalb muss dort in der <filename>/etc/asterisk/sip.conf</filename> ein
      sip peer eingerichtet werden, fügen sie dazu in die
      <filename>sip.conf</filename> die folgenden Zeilen ein:<programlisting>[berofix]
type=friend
secret=berofix
host=10.0.0.2
allow=all
context=from-sip</programlisting></para>

      <para>Um nun mit einer führenden Null einen Ruf in Richtung ISDN zu
      senden müssen sie nun chan_sip verwenden, benutzen sie in der
      <filename>extensions.conf</filename> dazu folgenden
      Zeilen:<programlisting>exten =&gt; _0X.,1,Dial(SIP/${EXTEN:1}@berofix)</programlisting></para>

      <para></para>
    </section>
  </section>
</section>
