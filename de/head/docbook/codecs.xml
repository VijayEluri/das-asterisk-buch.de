<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<chapter id="codecs" lang="de" revision="$Revision$">
  <!--% Copyright (c) 2007 - 2008 by Stefan Wintermeyer <sw@amooma.de>
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
% Asterisk training and consulting is offered at http://www.amooma.de-->

  <title>Codecs</title>

  <indexterm>
    <primary>Codecs</primary>
  </indexterm>

  <section id="codecs-einleitung">
    <title>Einleitung</title>

    <para>Das Thema Codecs hat bei deutschen Asterisk-Installationen keine so
    große Bedeutung wie bei Installationen in anderen Ländern. Der Grund
    besteht darin, dass wir jahrelang ISDN-verwöhnt sind und die Qualität
    natürlich nicht mehr missen wollen. Entsprechend entscheidet man sich in
    Deutschland fast immer für den ISDN-Codec G.711 (alaw oder ulaw<footnote>
        <simpara>Eigentlich µ-law (Das ist der griechische Buchstabe
        <emphasis>my</emphasis>, im physikalischen Einheitensystem als Präfix
        für <emphasis>micro</emphasis>.)</simpara>
      </footnote>). ulaw ist die in den USA und Japan übliche Form, alaw die
    in Europa übliche. Bei einer mit dem ISDN-Netz verbundenen Asterisk-Anlage
    sollte man immer nur alaw benutzen und ulaw direkt deaktivieren. Dadurch
    spart man sich eine unnötige Umcodierung.</para>

    <para>In Amerika sieht die Codec-Diskussion anders aus. Dort hat man
    traditionell eher eine schlechte Sprachübertragungsqualität über das oft
    veraltete Netz und entsprechend niedrigere Ansprüche. Für die meisten
    Amerikaner ist ein Umstieg auf den G.711-Codec immer ein Sprung zu einer
    viel besseren Qualität (einer der Gründe, warum VoIP in Amerika schneller
    populär wurde als in Deutschland).</para>
  </section>

  <section id="codecs-beschreibung">
    <title>Was macht ein Codec?</title>

    <para>Ein Codec wandelt analoge Audiosignale in ein digitales Format um.
    Dies kann nahezu verlustfrei (z. B. G.711)<footnote>
        <simpara>Aber auch <quote>nahezu verlustfrei</quote> ist immer
        relativ.</simpara>
      </footnote> oder auch mit einem gewissen Verlust (z. B. GSM) geschehen.
    Ohne einen Codec kann man keine Sprache übertragen. Welchen Codec man
    nimmt, hängt von der zur Verfügung stehenden Bandbreite und von der
    verfügbaren Rechenleistung ab. Die Benutzung von Codecs ist immer ein
    Kompromiss zwischen den beiden Werten Bandbreite und
    Rechenleistung.</para>

    <para>Wir gehen in diesem Kapitel nicht allzu ausführlich auf die
    Funktionsweisen der verschiedenen Codecs ein. Dem interessierten Leser sei
    hier ein Blick in die Wikipedia empfohlen. Für uns reicht ein genereller
    Überblick. 99 % aller deutschen Asterisk-Installationen benutzen als
    Standard alaw. Da sollte man sich nicht ohne Not mit irgendwelchen Exoten
    abmühen.</para>
  </section>

  <section id="codecs-performance">
    <title>Performance</title>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Performance</secondary>
    </indexterm>

    <para>Das größte Problem beim Einsatz von hochkomprimierenden Codecs ist
    die dadurch verbrauchte Rechenleistung. Bei Ihrer aktuellen Installation
    können Sie im CLI mit dem Befehl <command>core show translation</command>
    eine Tabelle mit den Umcodierungszeiten für die verschiedenen Codecs
    erhalten:<screen>big-island*CLI&gt; core show translation
         Translation times between formats (in milliseconds) for one second of data
          Source Format (Rows) Destination Format (Columns)

          g723 gsm ulaw alaw g726aal2 adpcm slin lpc10 g729 speex ilbc g726 g722
     g723    -   -    -    -        -     -    -     -    -     -    -    -    -
      gsm    -   -    2    2        2     2    1     2    -    10   14    2    -
     ulaw    -   2    -    1        2     2    1     2    -    10   14    2    -
     alaw    -   2    1    -        2     2    1     2    -    10   14    2    -
 g726aal2    -   2    2    2        -     2    1     2    -    10   14    1    -
    adpcm    -   2    2    2        2     -    1     2    -    10   14    2    -
     slin    -   1    1    1        1     1    -     1    -     9   13    1    -
    lpc10    -   2    2    2        2     2    1     -    -    10   14    2    -
     g729    -   -    -    -        -     -    -     -    -     -    -    -    -
    speex    -  11   11   11       11    11   10    11    -     -   23   11    -
     ilbc    -   3    3    3        3     3    2     3    -    11    -    3    -
     g726    -   2    2    2        1     2    1     2    -    10   14    -    -
     g722    -   -    -    -        -     -    -     -    -     -    -    -    -
big-island*CLI&gt; </screen></para>

    <para>In Ihrem System nicht verfügbare Codecs werden mit einem "-"
    gekennzeichnet. Man kann in dieser Tabelle sehr leicht sehen, welche
    Kodierung auf diesem System die meiste CPU-Leistung erfordert: Es sind
    ilbc und speex.</para>

    <para>Um Rechenzeit einzusparen, sollten Sie in Ihrem System so wenig
    verschiedene Codecs wie möglich einsetzen. Wenn ein Gespräch von Telefon A
    zu Telefon B mit dem gleichen Codec erfolgt, dann kann Asterisk die
    einzelnen Sprachpakete einfach durchreichen. Sollte A aber einen anderen
    Codec als B verwenden, dann muss Asterisk jedes Sprachpaket erst de- und
    dann wieder encodieren.</para>
  </section>

  <section id="codecs-konfiguration">
    <title>Konfiguration des Codecs</title>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Konfiguration</secondary>
    </indexterm>

    <para>Die Konfiguration des Codecs erfolgt immer technologieabhängig.
    IAX-Telefone werden in der <filename>iax.conf</filename> und SIP-Telefone
    in der <filename>sip.conf</filename> konfiguriert.</para>

    <section id="codecs-allow-1">
      <title>Beispiel mit einem festen Codec</title>

      <para>Will man alle SIP-Telefone auf den Codec G.711 (also alaw)
      einstellen, dann geschieht das mit folgendem Code in der
      <filename>sip.conf</filename>:<programlisting>[general]
disallow=all
allow=alaw</programlisting></para>

      <para>Wollen Sie im gleichen System das Telefon mit dem SIP-User 2000 so
      einstellen, dass es nur GSM sprechen kann, so geschieht dies
      folgendermaßen:<programlisting>[general]
disallow=all
allow=alaw

[2000]
disallow=all
allow=gsm</programlisting></para>
    </section>

    <section id="codecs-allow-n">
      <title>Beispiel mit mehreren Codecs zur Auswahl</title>

      <para>Wenn Sie in einer SIP-Umgebung Telefone mit unterschiedlichen
      Codecs betreiben, so können Sie in der <filename>sip.conf</filename>
      auch eine gewünschte Reihenfolge eintragen:<programlisting>[general]
disallow=all
allow=alaw
allow=gsm
allow=ilbc</programlisting></para>

      <para>Jetzt wird Asterisk mit jedem SIP-Telefon den optimalen Codec
      aushandeln. Dabei hat alaw die höchste und ilbc die niedrigste
      Chance.</para>
    </section>
  </section>

  <section id="die-wichtigsten-codecs">
    <title>Die wichtigsten Codecs</title>

    <para>Mit dem Befehl <command>core show translation</command> bekommen Sie
    eine Auflistung der in Ihrem System verfügbaren Codecs (das sind alle mit
    einer Zahl). Die in Asterisk-Installationen gebräuchlichsten Codecs werden
    in der folgenden Liste kurz besprochen:</para>

    <itemizedlist>
      <listitem>
        <para>GSM<indexterm>
            <primary>Codecs</primary>

            <secondary>GSM</secondary>
          </indexterm></para>

        <para>GSM ist ein Asterisk-Klassiker und uns allen von Handygesprächen
        bekannt. Die Bandbreite beträgt 13,3 Kbit/s, und die Qualität ist in
        Ordnung, wenn auch nicht überragend.</para>
      </listitem>

      <listitem>
        <para>iLBC<indexterm>
            <primary>Codecs</primary>

            <secondary>iLBC</secondary>
          </indexterm></para>

        <para>iLBC ist eine Art Geheimwaffe bei schmalen Bandbreiten. Die
        Sprachqualität ist vergleichsweise gut, und die Bandbreite beschränkt
        sich auf 13,3 bis 15 Kbps (je nach Framegröße). Skype benutzt eine
        Abwandlung dieses Codecs. Das Problem mit iLBC ist aber seine
        Rechenintensität. Deshalb wird er auch kaum von VoIP-Telefonen
        unterstützt.</para>
      </listitem>

      <listitem>
        <para>G.711<indexterm>
            <primary>Codecs</primary>

            <secondary>G.711</secondary>
          </indexterm></para>

        <para>G.711 ist ein weiterer Klassiker. G.711 (auch als al/alaw oder
        ul/ulaw bezeichnet) ist allen deutschen Lesern von ISDN bekannt. Der
        Codec bietet eine sehr gute Sprachqualität und benötigt 64 Kbps. Er
        ist der Standard für alle Gespräche im Intranet und wird von den
        meisten Firmen auch im Internet benutzt.</para>
      </listitem>

      <listitem>
        <para>G.722<indexterm>
            <primary>Codecs</primary>

            <secondary>G.722</secondary>
          </indexterm></para>

        <para>Vielleicht löst G.722 irgendwann einmal G.711 ab. In seiner
        höchsten Auflösung bietet er eine viel bessere Sprachqualität als
        G.711 (also noch mal besser als ISDN) und benötigt dafür auch nur 64
        Kbps. Leider wird er zurzeit noch nicht von vielen Telefonen
        unterstützt.</para>
      </listitem>

      <listitem>
        <para>G.726<indexterm>
            <primary>Codecs</primary>

            <secondary>G.726</secondary>
          </indexterm></para>

        <para>Bietet die gleiche Sprachqualität wie G.711, benötigt aber nur
        die halbe Bandbreite (32 Kbps). Im Gegensatz zu G.711 wird nicht immer
        die aktuelle Information, sondern nur die Differenz zum vorherigen
        Sprachpaket übertragen. So kann mit halber Bandbreite die gleiche
        Sprachqualität erreicht werden. G.726 ist nicht allzu rechenintensiv,
        aber natürlich benötigt er etwas mehr Rechenleistung als G.711.</para>
      </listitem>

      <listitem>
        <para>G.729a<indexterm>
            <primary>Codecs</primary>

            <secondary>G.729a</secondary>
          </indexterm></para>

        <para>G.729a ist ein lizenzpflichtiger Codec, der mit 8 Kbps auskommt
        und eine ähnlich gute Sprachqualität wie GSM bietet. Lizenzen für
        Asterisk können bei <ulink
        url="http://www.digium.com"><citetitle>Digium</citetitle></ulink>
        gekauft werden. Er sticht weder durch Sprachqualität noch durch
        Performance hervor.</para>

        <para>G.729a ist in vielen VoIP-Telefonen verbaut und bietet damit
        eine gute Möglichkeit, Bandbreite zu sparen. Ob dies heutzutage
        sinnvoll ist, müssen Sie selbst entscheiden.</para>
      </listitem>
    </itemizedlist>
  </section>

  <section id="codecs-trunking">
    <title>Bandbreite und Trunking</title>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Bandbreite</secondary>
    </indexterm>

    <indexterm>
      <primary>Codecs</primary>

      <secondary>Trunking</secondary>
    </indexterm>

    <para>Wer viele Gespräche gleichzeitig über eine Netzwerkverbindung führen
    will (z. B., wenn zwei Asterisk-Anlagen miteinander verbunden werden), der
    bekommt sehr schnell ein Bandbreitenproblem. Je nach Codec und Länge des
    Frames kann es sein, dass der IP-Overhead genauso oder sogar größer ist
    als die Nutzlast (also die übertragene Sprache). So bekommen Sie mit dem
    SIP-Protokoll und der Verwendung des GSM-Codecs auf einer
    2-MBit/s-Datenleitung nur ungefähr 35 gleichzeitige Gespräche (wobei beide
    Gesprächspartner gleichzeitig reden können). 35 Gespräche über eine
    2-MBit/s-Leitung ist aber nicht gerade viel. Da wären Sie mit einem
    normalen Mulitplex-Anschluss besser bedient, da dort die Sprachqualität
    wesentlich besser ist.</para>

    <para>Die geniale Idee am Trunking-Verfahren ist, nicht pro Nutzlastpaket
    auch einen Overhead zu erzeugen, sondern mehrere Nutzlastpakete
    zusammenzufassen und diese als ein Paket mit entsprechend nur einem
    Overhead zu versenden. Dadurch lässt sich die Bandbreite sehr stark
    reduzieren. So können Sie auf der gleichen 2-MBit/s-Datenleitung 77
    simultane Gespräche führen (mit dem GSM-Codec). Möchten wir auf der
    gleichen Verbindung eine ISDN-Sprachqualität bekommen, können wir unter
    Einsatz von Trunking und dem G.726-Codec immer noch 44 simultane Gespräche
    führen.</para>

    <para>Trunking wird nur im IAX2-Protokoll (siehe <xref linkend="iax" />)
    angeboten und sollte nur bei Verbindungen mit mindestens 2 simultanen
    Verbindungen benutzt werden, da der Overhead bei einer Verbindung
    geringfügig höher ist als ohne Trunking.</para>

    <para>Wer sich intensiv mit der Bandbreitenproblematik auseinandersetzen
    will, der kann auf <ulink
    url="http://www.asteriskguru.com/tools/bandwidth_calculator.php"><citetitle>http://www.asteriskguru.com/tools/bandwidth_calculator.php</citetitle></ulink>
    online verschiedene Szenarien durchrechnen.</para>
  </section>
</chapter>
