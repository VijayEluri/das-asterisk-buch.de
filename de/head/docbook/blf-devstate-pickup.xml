<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd">
<section id="blf-pickup" lang="de" revision="$Revision$">
  <!--% Copyright (c) 2006 - 2008
% - Stefan Wintermeyer <stefan.wintermeyer@amooma.de>
% - Philipp Kempgen <philipp.kempgen@amooma.de>
% - Norbert A. Richartz <norbert.richartz@secunet.com>
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
% Asterisk training and consulting is offered at http://www.amooma.de-->

  <sectioninfo>
    <author>
      <firstname>Philipp</firstname>

      <surname>Kempgen</surname>

      <email>philipp.kempgen@amooma.de</email>
    </author>
  </sectioninfo>

  <title>BLF<footnote>
      <para>Busy Lamp Field, Besetztlampenfeld</para>
    </footnote>, Pickup<footnote>
      <para>Heranholen, Rufübernahme</para>
    </footnote><indexterm>
      <primary>BLF</primary>
    </indexterm><indexterm>
      <primary>Besetztlampenfeld</primary>
    </indexterm><indexterm>
      <primary>Pickup</primary>
    </indexterm><indexterm>
      <primary>Hints</primary>
    </indexterm><indexterm>
      <primary>LEDs</primary>
    </indexterm><indexterm>
      <primary>Heranholen</primary>
    </indexterm><indexterm>
      <primary>Rufübernahme</primary>
    </indexterm></title>

  <warning>
    <para>########################################################</para>

    <bridgehead>IST NOCH IN ARBEIT. AUSLAGERUNG VON
    <filename>telefone-snom.xml</filename></bridgehead>

    <para>########################################################</para>
  </warning>

  <formalpara id="blf-beschreibung">
    <title>Beschreibung des Leistungsmerkmals BLF</title>

    <para>Besetztlampenfelder (BLF) sind ein weit verbreitetes Feature
    traditioneller Telefonanlagen. Dabei handelt es sich um LEDs oder
    LCD-Anzeigen und zugehörige Tasten am Telefon, mit denen die Nebenstellen
    von einzelnen Kollegen oder ganzen Gruppen überwacht (im Sinne von
    beobachtet) werden. Klingelt ein überwachtes Telefon, dann blinkt am
    eigenen Apparat die entsprechende LED<footnote>
        <para>Bei einigen Anlagen sieht man sogar die Rufnummer des Anrufers.
        Dies ist jedoch - soviel sei vorab gesagt - bei Asterisk nicht
        möglich, bzw. nur mit einem Patch (siehe u.a. <ulink
        url="http://bugs.digium.com/view.php?id=5014"><citetitle>Asterisk Bug
        5014</citetitle></ulink>).</para>
      </footnote>. Ist der überwachte Teilnehmer im Gespräch so leuchtet die
    LED am überwachenden Gerät dauerhaft. Ansonsten ist die LED aus.<footnote>
        <para>Daneben gibt es je nach Anlage noch weitere "Blink-Kadenzen",
        z.B. ein langsameres Blinken wenn der andere Teilnehmer sein Gespräch
        auf "Halten" gestellt hat.</para>
      </footnote>Was das Drücken der Taste bewirkt ist abhängig vom Status des
    anderen Teilnehmers. Ist der Kollege frei so wird ein normaler Anruf
    aufgebaut. Wenn aber sein Telefon klingelt (eigene LED blinkt), so kann
    man durch Drücken der Taste<footnote>
        <para>Je nach Telefonanlage geht das nicht durch Tastendruck sondern
        durch (umständliche) Eingabe eines Feature-Codes
        (<literal>*</literal><replaceable>sonstwas</replaceable>).</para>
      </footnote> das eingehende Gespräch zum eigenen Apparat
    heranholen.</para>
  </formalpara>

  <para>Wir wollen uns im folgenden damit beschäftigen wie man diese
  Funktionen mit Asterisk für SIP-Telefone nachbauen kann.</para>

  <section id="blf-leds">
    <title>Ansteuerung der LEDs</title>

    <section id="blf-sip.conf">
      <title>sip.conf</title>

      <para>Zuerst sind bestimmte Einstellungen im Abschnitt
      <literal>[general]</literal> der <filename>sip.conf</filename>
      erforderlich:</para>

      <programlisting>[general]
allowsubscribe = yes
notifyringing = yes
notifyhold = yes
limitonpeers = yes</programlisting>

      <para>Auch in den Abschnitten der einzelnen SIP-Benutzer sind
      Einstellungen hinzuzufügen, nämlich <literal>subscribecontext</literal>
      und <literal>call-limit</literal>. <literal>subscribecontext</literal>
      besagt in welchem Context Asterisk suchen soll wenn dieser Benutzer den
      Status anderer Benutzer "abonnieren" will. I.d.R. ist das der Context in
      dem sich auch die internen Benutzer befinden.
      <literal>call-limit</literal> hat eigentlich eine andere Aufgabe,
      nämlich die Anzahl der gleichzeitigen Gespräche dieses Benutzers zu
      beschränken (wenn es auf einen Wert &gt; 0 gesetzt wird). Es dient hier
      aber auch dazu, dass Asterisk überhaupt die Anzahl der gleichzeitigen
      Gespräche dieses Benutzers mitzählt, was wichtig ist für den Status
      (frei/besetzt). Es muß also auf einen beliebigen Wert &gt; 0 gesetzt
      werden, am besten mindestens 2, sonst hat man Probleme bei
      Transfers.</para>

      <para>Zudem sind (für das spätere Heranholen von Gesprächen) noch die
      zwei Parameter <literal>callgroup</literal><footnote>
          <para>siehe <xref linkend="sip-channel-callgroup" /></para>
        </footnote> und <literal>pickupgroup</literal><footnote>
          <para>siehe <xref linkend="sip-channel-pickupgroup" /></para>
        </footnote> von Bedeutung. Z.B. darf ein Benutzer mit
      <literal>pickupgroup=2</literal> Gespräche von anderen Benutzern mit
      <literal>callgroup=2</literal> heranholen. Dies dient also der
      Rechteverwaltung. Da es allerdings nur 64 mögliche Gruppen gibt (0 bis
      63) ist diese Methode nur für kleine bis mittelgroße Installationen
      brauchbar. Bei großen Installationen setzt man für alle User die gleiche
      Gruppe und muß sich dann um die Rechteverwaltung selber kümmern (dazu
      später noch ein Hinweis).</para>

      <programlisting>[21]
type = friend
context = interne-benutzer
secret = 9847825134
host = dynamic
mailbox = 2000
<emphasis role="bold">subscribecontext = interne-benutzer</emphasis>
<emphasis role="bold">call-limit = 10</emphasis>
<emphasis role="bold">callgroup = 2</emphasis>
<emphasis role="bold">pickupgroup = 2</emphasis></programlisting>
    </section>

    <section id="blf-hints">
      <title>Hints<indexterm>
          <primary>Hints</primary>
        </indexterm></title>

      <para>Als nächstes muß man Asterisk die Zuordnung zwischen Extensions
      und Benutzern (oder Geräten) mitteilen. Dies macht man im Dialplan mit
      sogenannten <quote><foreignphrase
      lang="en">Hints</foreignphrase></quote>. Wenn man in
      Dialplan-Prioritäten denkt, dann ist ein <literal>hint</literal> eine
      spezielle Priorität die noch vor der Priorität <literal>1</literal>
      steht. Wichtig ist dass sich die Hints in dem Context befinden den man
      in der <filename>sip.conf</filename> (s.o.) mit
      <filename>subscribecontext</filename> angegeben hat, ansonsten werden
      die Status-Informationen nicht weitergeleitet. Das ist durchaus Absicht,
      damit man nicht per se von allen Telefonen alle weiteren überwachen
      kann. Durch unterschiedliche Contexte lässt sich also auch eine Art
      Berechtigungssystem bauen.<footnote>
          <para>Diese Methode eigent sich allerdings nicht so gut für
          Datenbank-gestützte <quote>Realtime</quote>-Installationen.</para>
        </footnote> Wir beschreiben hier anhand von Beispielen wie ein Hint
      definiert wird. Je nachdem ob Ihr Dialplan im
      <filename>extensions.conf</filename>-Format oder in AEL geschrieben ist
      verwenden Sie die eine oder die andere Variante.</para>

      <table colsep="0" frame="none" pgwide="1" rowsep="0" tocentry="0">
        <title>Hints &ndash; Einfaches Beispiel</title>

        <tgroup cols="2">
          <colspec align="left" colnum="1" colwidth="5*" />

          <colspec align="left" colnum="2" colwidth="4*" />

          <thead valign="middle">
            <row>
              <entry
              align="center"><filename>extensions.conf</filename></entry>

              <entry
              align="center"><filename>extensions.ael</filename></entry>
            </row>
          </thead>

          <tbody valign="top">
            <row>
              <entry><programlisting>[interne-benutzer]

exten =&gt; 21,<emphasis role="bold">hint,SIP/21</emphasis>
exten =&gt; 21,1,Dial(SIP/${EXTEN},40)
exten =&gt; 21,n,VoiceMail(${EXTEN},u)

exten =&gt; 22,<emphasis role="bold">hint,SIP/22</emphasis>
exten =&gt; 22,1,Dial(SIP/${EXTEN},40)
exten =&gt; 22,n,VoiceMail(${EXTEN},u)</programlisting></entry>

              <entry><programlisting>context interne-benutzer {
  
  <emphasis role="bold">hint(SIP/21)</emphasis> 21 =&gt; {
    Dial(SIP/${EXTEN},40);
    VoiceMail(${EXTEN},u);
  }
  <emphasis role="bold">hint(SIP/22)</emphasis> 22 =&gt; {
    Dial(SIP/${EXTEN},40);
    VoiceMail(${EXTEN},u);
  }
}</programlisting></entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <table colsep="0" frame="none" pgwide="1" rowsep="0" tocentry="0">
        <title>Hints &ndash; Beispiel mit Pattern (Asterisk 1.4)</title>

        <tgroup cols="2">
          <colspec align="left" colnum="1" colwidth="5*" />

          <colspec align="left" colnum="2" colwidth="4*" />

          <thead valign="middle">
            <row>
              <entry
              align="center"><filename>extensions.conf</filename></entry>

              <entry
              align="center"><filename>extensions.ael</filename></entry>
            </row>
          </thead>

          <tbody valign="top">
            <row>
              <entry><programlisting>[interne-benutzer]

exten =&gt; 21,<emphasis role="bold">hint,SIP/21</emphasis>
exten =&gt; 22,<emphasis role="bold">hint,SIP/22</emphasis>

exten =&gt; _2X,1,Dial(SIP/${EXTEN},40)
exten =&gt; _2X,n,VoiceMail(${EXTEN},u)</programlisting></entry>

              <entry><programlisting>context interne-benutzer {
  
  <emphasis role="bold">hint(SIP/21)</emphasis> 21 =&gt; {}
  <emphasis role="bold">hint(SIP/22)</emphasis> 22 =&gt; {}
  
  _2X =&gt; {
    Dial(SIP/${EXTEN},40);
    VoiceMail(${EXTEN},u);
  }
}</programlisting></entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <important>
        <para>Hierbei ist zu beachten daß ein <literal>hint</literal> in
        Asterisk 1.4 nicht mit Pattern<footnote>
            <para><xref linkend="einleitung-regex" /></para>
          </footnote> geschrieben werden kann.<literallayout>exten =&gt; _2X,hint,SIP/${EXTEN}</literallayout>bzw.<literallayout>hint(SIP/${EXTEN}) _2X =&gt; {<replaceable>...</replaceable>}</literallayout>wäre
        also unzulässig.</para>

        <para>Ab Asterisk 1.6 ist diese Schreibweise möglich, auch wenn es
        anfänglich noch zu Problemen kam. Bitte beachten Sie aber, dass
        während der Interpretierung eines Hints noch kein Channel besteht, was
        bedeutet dass auch keine Channel-Variablen in der Hint-Definition zur
        Verfügung stehen &ndash; mit Ausnahme von
        <literal>${EXTEN}</literal>.</para>
      </important>

      <table colsep="0" frame="none" pgwide="1" rowsep="0" tocentry="0">
        <title>Hints &ndash; Beispiel mit Pattern (Asterisk 1.6)</title>

        <tgroup cols="2">
          <colspec align="left" colnum="1" colwidth="5*" />

          <colspec align="left" colnum="2" colwidth="4*" />

          <thead valign="middle">
            <row>
              <entry
              align="center"><filename>extensions.conf</filename></entry>

              <entry
              align="center"><filename>extensions.ael</filename></entry>
            </row>
          </thead>

          <tbody valign="top">
            <row>
              <entry><programlisting>[interne-benutzer]

exten =&gt; _2X,<emphasis role="bold">hint,SIP/${EXTEN}</emphasis>
exten =&gt; _2X,1,Dial(SIP/${EXTEN},40)
exten =&gt; _2X,n,VoiceMail(${EXTEN},u)</programlisting></entry>

              <entry><programlisting>context interne-benutzer {
  
  <emphasis role="bold">hint(SIP/${EXTEN})</emphasis> _2X =&gt; {
    Dial(SIP/${EXTEN},40);
    VoiceMail(${EXTEN},u);
  }
}</programlisting></entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <table colsep="0" frame="none" pgwide="1" rowsep="0" tocentry="0">
        <title>Hints &ndash; Beispiel mit mehreren Benutzern in einem
        <literal>hint</literal></title>

        <tgroup cols="2">
          <colspec align="left" colnum="1" colwidth="5*" />

          <colspec align="left" colnum="2" colwidth="4*" />

          <thead valign="middle">
            <row>
              <entry
              align="center"><filename>extensions.conf</filename></entry>

              <entry
              align="center"><filename>extensions.ael</filename></entry>
            </row>
          </thead>

          <tbody valign="top">
            <row>
              <entry><programlisting>[interne-benutzer]

exten =&gt; 20,<emphasis role="bold">hint,SIP/21&amp;SIP/22</emphasis>

exten =&gt; 20,1,Dial(SIP/21&amp;SIP/22,40)</programlisting></entry>

              <entry><programlisting>context interne-benutzer {
  
  <emphasis role="bold">hint(SIP/21&amp;SIP/22)</emphasis> 20 =&gt; {}
  
  20 =&gt; {
    Dial(SIP/21&amp;SIP/22,40);
  }
}</programlisting></entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <tip>
        <para>Der Übersichtlichkeit halber kann man alle Hints auch in einen
        eigenen Context legen und diesen überall dort mit <code>include =&gt;
        meine-hints</code> einbinden, wo er benötigt wird. Dies ist v.a. in
        Asterisk-Versionen vor 1.6 interessant.</para>
      </tip>

      <para>Danach Asterisk neu starten
      (<literal><command>/etc/init.d/asterisk reload</command></literal> oder
      <literal><command>asterisk -rx 'module
      reload'</command></literal>).</para>
    </section>
  </section>

  <section id="blf-subscribe">
    <title>Konfiguration der Telefone für BLF</title>

    <para>Nun müssen noch die überwachenden Telefone konfiguriert werden. Wie
    das genau geht ist natürlich abhängig vom jeweiligen Modell und kann im
    Handbuch<footnote>
        <para>z.B. <ulink
        url="http://wiki.snom.com/"><citetitle>Snom-Wiki</citetitle></ulink></para>
      </footnote> nachgelesen werden. Wir zeigen es hier exemplarisch für ein
    Snom 360.</para>

    <para>Melden Sie sich wie gewohnt mit einem Webbrowser am Telefon an und
    gehen in das Untermenü <quote>Funktionstasten</quote>. Dort belegen Sie
    die Funktionstaste Ihrer Wahl (im Beispiel die P6) mit der Funktion
    <quote>Ziel</quote>/<quote>Nebenstelle</quote><footnote>
        <para>Die Bezeichnung <quote>Ziel</quote> wurde in einer der neueren
        Firmware-Versionen in <quote>Nebenstelle</quote> umbenannt. Ansonsten
        ist die weitere hier beschriebene Funktionalität gleich.</para>
      </footnote> und tragen die zu überwachende Extension ein, also z.B. am
    Telefon des Benutzers <literal>21</literal> die <literal>22</literal> und
    <literal>23</literal> und umgekehrt.</para>

    <para>Die Bezeichnung <quote>Kontext</quote> werden Sie vom Snom schon
    kennen, damit ist einer der 12 möglichen SIP-Accounts gemeint. Im
    Normalfall hat man seinen Account als den ersten konfiguriert und wählt
    diesen hier aus.</para>

    <screenshot>
      <screeninfo>Snom &ndash; Konfiguration Leitungsüberwachung</screeninfo>

      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="bilder/snom-hint1.png" />
        </imageobject>

        <imageobject role="html">
          <imagedata fileref="bilder/snom-hint1.html.jpg" />
        </imageobject>
      </mediaobject>
    </screenshot>

    <para>Nachdem die Einstellungen gespeichert wurden, ändert das Telefon den
    Eintrag automatisch in eine passende SIP-URI der Form
    <literal>&lt;sip:21@<replaceable>x.x.x.x</replaceable>;user=phone&gt;</literal>
    ab. <replaceable>x.x.x.x</replaceable> ist die IP-Adresse der
    Telefonanlage. (Der Zusatz <literal>;user=phone</literal> ist nicht von
    Bedeutung.)</para>

    <screenshot>
      <screeninfo>Snom &ndash; Konfiguration Leitungsüberwachung
      Ziel/Nebenstelle</screeninfo>

      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="bilder/snom-hint2.png" />
        </imageobject>

        <imageobject role="html">
          <imagedata fileref="bilder/snom-hint2.html.jpg" />
        </imageobject>
      </mediaobject>
    </screenshot>

    <para>Je nach Firmware-Version muß jetzt noch das Telefon neugestartet
    werden.<footnote>
        <para>Der Telefon-Neustart nach einem Asterisk-Neustart ist für die
        saubere Anmeldung der Subscription des Telefons notwendig. Jedenfalls
        solange Asterisk noch keine <quote>persistent subscriptions</quote>,
        also das Fortbestehen von Status-Abonnements über einen Reload hinweg,
        unterstützt.</para>
      </footnote></para>
  </section>

  <section id="blf-test">
    <title>Test der Hints</title>

    <para>Jetzt können wir überprüfen ob alle richtig konfiguriert wurde. Dazu
    geben Sie im Asterisk-CLI den Befehl <literal><command>core show
    hints</command></literal> ein:<footnote>
        <para>Ausgabe hier aus Platzgründen etwas verkürzt.</para>
      </footnote></para>

    <screen><prompt>*CLI&gt; </prompt><command>core show hints</command>
    -= Registered Asterisk Dial Plan Hints =-
   21         : SIP/21        State:Unavailable     Watchers  0
   22         : SIP/22        State:Unavailable     Watchers  0
----------------
- 2 hints registered</screen>

    <para>Im obigen Beispiel wird deutlich, dass die zu überwachenden Telefone
    noch nicht am Asterisk-Server angemeldet sind
    (<literal>Unavailable</literal>). Ebenso hat auch noch kein überwachendes
    Telefon den Status dieser Extensions abonniert (0
    <literal>Watchers</literal>). Letzteres wird auch durch die Auflistung der
    aktiven <foreignphrase lang="en">Subscriptions</foreignphrase> bestätigt,
    die durch das Kommando <literal><command>sip show
    subscriptions</command></literal> ausgegeben wird:<footnote>
        <para>Ausgabe hier aus Platzgründen etwas verkürzt.</para>
      </footnote></para>

    <screen><prompt>*CLI&gt; </prompt><command>sip show subscriptions</command>
Peer          User   Call ID      Extension   Last state    Type
0 active SIP subscriptions</screen>

    <para>Nachdem sich das überwachende Telefon angemeldet hat setzen wir den
    Befehl erneut ab:</para>

    <screen><prompt>*CLI&gt; </prompt><command>sip show subscriptions</command>
Peer          User   Call ID      Extension   Last state    Type
192.168.0.2   21     815d944554e  22          Unavailable   dialog-info+xml
1 active SIP subscription</screen>

    <para>Hier wird deutlich, dass der User <literal>21</literal> die
    Extension <literal>22</literal> überwacht. Wenn sich das überwachte
    Telefon bei Asterisk anmeldet, dann erscheint im CLI die Zeile<screen>Extension Changed 22 new state Idle for Notify User 21</screen></para>

    <para>Setzen Sie den Befehl <literal><command>core show
    hints</command></literal> erneut ab:</para>

    <screen><prompt>*CLI&gt; </prompt><command>core show hints</command>
    -= Registered Asterisk Dial Plan Hints =-
   21         : SIP/21        State:Idle            Watchers  0
   22         : SIP/22        State:Idle            Watchers  1
----------------
- 2 hints registered</screen>

    <para>Im Gegensatz zu vorher sieht man, dass das Telefon einen definierten
    Zustand hat (<literal>Idle</literal>) und zudem ein weiteres Telefon den
    Zustand überwacht (<literal>Watchers 1</literal>). Die Konfiguration ist
    nun komplett, Asterisk meldet Statuswechsel der überwachten Extension
    sofort an das überwachende Telefon. Befindet sich das überwachte Telefon
    im Gespräch, leuchtet die LED dauerhaft. Wird das überwachte Telefon
    angerufen, blinkt die LED. Ohne Aktivität ist auch die LED aus. Die
    Status-Wechsel werden ebenfalls auf der Konsole gemeldet:</para>

    <screen>Extension Changed 22 new state Ringing for Notify User 21
Extension Changed 22 new state InUse for Notify User 21
Extension Changed 22 new state Idle for Notify User 21</screen>
  </section>

  <section id="blf-pickup">
    <title>Heranholen eines Anrufs (<quote><foreignphrase
    lang="en">Pickup</foreignphrase></quote>)<indexterm>
        <primary>Pickup</primary>
      </indexterm></title>

    <para>In der bisherigen Konfiguration werden Gespräche des überwachten
    Teilnehmers nur angezeigt. Wir wollen aber auch die Möglichkeit schaffen,
    ein an einem anderen Apparat eingehendes Gespräch heranholen zu
    können.</para>

    <para>Man unterscheidet dabei zwischen dem gezielten Heranholen eines
    Anrufs von einem einzelnen Benutzer (<foreignphrase lang="en">directed
    pickup</foreignphrase>) und dem Heranholen eines Anrufs von einer
    Benutzergruppe (<foreignphrase lang="en">group pickup</foreignphrase>).
    Hier betrachten wir zunächst den ersten, einfacheren Fall.</para>

    <section id="blf-pickup-extensions.conf">
      <title>extensions.conf für Pickup</title>

      <para>Für das Pickup ist es notwendig noch einen weiteren Eintrag in der
      <filename>extensions.conf</filename> hinzuzufügen:</para>

      <programlisting>[interne-benutzer]

; ...

; Gespraechsuebernahme (PickUp)
<emphasis role="bold">exten =&gt; _*8X.,1,Set(nst=${EXTEN:2})
exten =&gt; _*8X.,n,Verbose(1,${CALLERID(num)} will Anruf von ${nst} holen)
exten =&gt; _*8X.,n,Pickup(${nst}@interne-benutzer)</emphasis></programlisting>

      <para>bzw. <filename>extensions.ael</filename>:</para>

      <programlisting>context interne-benutzer {
  
  // ...
  
  // Gespraechsuebernahme (PickUp)
  <emphasis role="bold">_*8X. =&gt; {
    Set(nst=${EXTEN:2});
    Verbose(1,${CALLERID(num)} will Anruf von ${nst} holen);</emphasis>
    // hier koennte eine Berechtigungspruefung eingebaut werden
    <emphasis role="bold">Pickup(${nst}@interne-benutzer);
  }</emphasis>
}</programlisting>

      <para>Damit haben wir in Asterisk eine Extension definiert die besagt,
      daß beim Wählen von
      <literal>*8</literal><replaceable>&lt;Nebenstelle&gt;</replaceable>
      (also z.B. <literal>*821</literal>) der Anruf herangeholt wird der
      gerade auf dieser <replaceable>&lt;Nebenstelle&gt;</replaceable> (z.B.
      <literal>21</literal>) im Context <literal>interne-benutzer</literal>
      klingelt.<footnote>
          <para>zur Beschreibung der Applikation <literal>Pickup()</literal>
          siehe auch <xref linkend="applikationen-pickup" /></para>
        </footnote></para>
    </section>

    <section id="blf-pickup-telefon">
      <title>Konfiguration des Telefons für Pickup<indexterm>
          <primary>Snom</primary>

          <secondary>Pickup</secondary>
        </indexterm></title>

      <para>Dem Snom-Telefon muss jetzt noch mitgeteilt werden, welche Nummer
      zur Gesprächsübernahme gewählt werden muss. Statt wie oben beschrieben
      (<xref linkend="blf-subscribe" />) bei
      <quote>Ziel</quote>/<quote>Nebenstelle</quote> nur die zu überwachende
      Nummer einzutragen, tragen sie nun die Nummer gefolgt von einem
      <quote><literal>|</literal></quote> (Pipe-Symbol) und der oben
      definierten Zeichekette <quote><literal>*8</literal></quote> für das
      Pickup ein. Also für obiges Beispiel
      <quote><literal>21|*8</literal></quote>. Das Telefon wandelt dies wieder
      in die passende SIP-URI um. Das Snom wird durch diesen Zusatz, der
      strenggenommen nicht zur SIP-URI gehört, angewiesen zum Heranholen
      <literal>*8</literal> vor der Nebenstellennummer zu wählen obwohl es ihm
      von Asterisk in der Status-Benachrichtigung nicht so mitgeteilt
      wird.<footnote>
          <para>Das wird vermutlich in neueren Versionen von Asterisk behoben,
          siehe <ulink
          url="http://bugs.digium.com/view.php?id=5014"><citetitle>Asterisk
          Bug 5014</citetitle></ulink>.</para>
        </footnote> Jetzt können am überwachenden Telefon einfach am
      überwachten Telefon eingehende Anrufe angenommen werden, indem die zur
      blinkenden LED passende Taste gedrückt wird.</para>

      <note>
        <para>Um die Anzeige- und Übernahme-Funktionalität korrekt zu nutzen,
        müssen in den <quote>Erweiterten Einstellungen</quote> des Snoms zwei
        Einstellungen angepasst werden. Das Setting <quote>Dialog-Info Call
        Pickup</quote> muss aktiviert sein, <quote>Pakete vom Registrar
        filtern</quote> muss deaktiviert werden. Die erweiterten Einstellungen
        sind nur im Admin-Modus des Telefons verfügbar.</para>
      </note>

      <note>
        <para>Es wäre natürlich auch schön, wenn man sehen könnte, wer gerade
        auf der überwachten Leitung anruft, bevor man den Ruf entgegennimmt.
        Dies bietet Asterisk von sich aus leider nicht an. Im Internet gibt es
        aber diverse Patches, die auch das ermöglichen.</para>
      </note>

      <para>Sollen die erläuterten Einstellungen in Form einer automatischen
      Konfiguration ins Snom geladen werden, müssen beispielsweise folgende
      Parameter in der Geräte-spezifischen Konfiguration
      stehen:<programlisting>filter_registrar: off
callpickup_dialoginfo: on
fkey5: dest 22|*8
fkey6: dest 23|*8</programlisting><note>
          <para>Die Funktionstasten sind 0-indiziert. Um wie im Beispiel die
          Funktionstaste 6 zu belegen, muss der Parameter
          <literal>fkey5</literal> gesetzt werden usw. Die Funktionstaste 1
          wird mit <literal>fkey0</literal> angesprochen.</para>
        </note></para>
    </section>

    <section id="blf-group-pickup">
      <title>Heranholen von einer Gruppe</title>

      <para>Das Heranholen eines Anrufs von einer Gruppe von Teilnehmern
      (<foreignphrase lang="en">group pickup</foreignphrase>) ist sehr ähnlich
      und schnell beschrieben. Entweder baut man sich Pickup-Extensions wie
      z.B. die folgende:</para>

      <programlisting>context interne-benutzer {
  
  // Verkaufsabteilung
  hint(SIP/21&amp;SIP/22&amp;SIP/23) 20 =&gt; {
    Dial(SIP/21&amp;SIP/22&amp;SIP/23,40);
  }
  
  // Gespraechsuebernahme (PickUp) von der Gruppe Verkauf
  <emphasis role="bold">_*820 =&gt; {
    Verbose(1,${CALLERID(num)} will Anruf von Gruppe Verkauf holen);
    Pickup(21@interne-benutzer&amp;22@interne-benutzer&amp;23@interne-benutzer);
  }</emphasis>
}</programlisting>

      <para>Als zu überwachende Nebenstelle würde man dann am Telefon die
      <literal>20</literal> eintragen (Snom: <literal>20|*8</literal>).</para>

      <para>Als gute Alternative bietet sich die
      <literal>PICKUPMARK</literal>-Funktionalität der
      <literal>Pickup()</literal>-Applikation (<xref
      linkend="applikationen-pickup" />) an, mit der man flexibler ist.
      Beispiel:</para>

      <programlisting>context interne-benutzer {
  
  // Verkaufsmitarbeiter
  _2X =&gt; {
    <emphasis role="bold">Set(__PICKUPMARK=verkauf);</emphasis>
    Dial(SIP/${EXTEN},40);
  }
  hint(SIP/21) 21 =&gt; {}
  hint(SIP/22) 22 =&gt; {}
  hint(SIP/23) 23 =&gt; {}
  
  // Verkaufsabteilung
  hint(SIP/21&amp;SIP/22&amp;SIP/23) 20 =&gt; {
    <emphasis role="bold">Set(__PICKUPMARK=verkauf);</emphasis>
    Dial(SIP/21&amp;SIP/22&amp;SIP/23,40);
  }
  
  // Gespraechsuebernahme von der Gruppe Verkauf
  _*820 =&gt; {
    Verbose(1,${CALLERID(num)} will Anruf von Gruppe Verkauf holen);
    <emphasis role="bold">Pickup(verkauf@PICKUPMARK);</emphasis>
  }
}</programlisting>

      <para>Will man keine Extra-Nebenstelle (im obigen Beispiel die
      <literal>20</literal>) für die Pickup-Gruppe verbrauchen, so bietet sich
      für fortgeschrittene Anwender z.B. folgende Konfiguration an:</para>

      <programlisting>context interne-benutzer {
  
  // Verkaufsmitarbeiter
  _2X =&gt; {
    <emphasis role="bold">Set(__PICKUPMARK=200);</emphasis>
    // welcher Mitarbeiter zu welcher Pickup-Gruppe gehoert liesse sich
    // z.B. ueber ein ausgefeiltes AGI-Skript setzen
    Dial(SIP/${EXTEN}<emphasis role="bold">&amp;Local/**${PICKUPMARK}</emphasis>,40);
  }
  hint(SIP/21) 21 =&gt; {}
  hint(SIP/22) 22 =&gt; {}
  hint(SIP/23) 23 =&gt; {}
  
  // Pickup-Gruppen
  _**X. =&gt; {
    Verbose(1,Es klingelt in Pickup-Gruppe ${EXTEN:2});
  }
  <emphasis role="bold">hint(SIP/21&amp;SIP/22&amp;SIP/23) **200 =&gt; {}</emphasis>
  
  // Gespraechsuebernahme direkt
  _*8X. =&gt; {
    Set(nst=${EXTEN:2});
    Verbose(1,${CALLERID(num)} will Anruf von ${nst} holen);
    // hier koennte eine Berechtigungspruefung eingebaut werden
    Pickup(${nst}@interne-benutzer);
  }
  
  // Gespraechsuebernahme von einer Gruppe
  <emphasis role="bold">_*8**X.</emphasis> =&gt; {
    Set(pmark=${EXTEN:4});
    Verbose(1,${CALLERID(num)} will Anruf von Pickup-Gruppe ${pmark} holen);
    // hier koennte eine Berechtigungspruefung eingebaut werden
    <emphasis role="bold">Pickup(${pmark}@PICKUPMARK);</emphasis>
  }
}</programlisting>

      <para>Als zu überwachende Nebenstelle würde man dann am Telefon die
      <literal>**200</literal> eintragen (Snom:
      <literal>**200|*8</literal>).</para>
    </section>
  </section>

  <section id="blf-devstate">
    <title>Gezielte Ansteuerung der LEDs: DevState<indexterm>
        <primary>DEVSTATE()</primary>
      </indexterm></title>

    <para></para>
  </section>

  <section>
    <title></title>

    <para></para>
  </section>

  <section>
    <title></title>

    <para></para>
  </section>

  <section>
    <title>#####################################</title>

    <para></para>
  </section>

  <section>
    <title></title>

    <para></para>
  </section>

  <section>
    <title></title>

    <para></para>
  </section>

  <section id="snom-leds">
    <title>Ansteuerung der Leitungstasten und -LEDs</title>

    <section id="snom-leds-custom">
      <title>Gezielte Ansteuerung der LEDs</title>

      <section id="snom-leds-custom-bristuff">
        <title>Applikation Devstate()</title>

        <indexterm>
          <primary>Devstate()</primary>
        </indexterm>

        <para>In Asterisk ist es ebenfalls möglich, die LEDs z.B. auch gezielt
        aus dem Wählplan anzusteuern. Dazu dient die Applikation
        "DevState":</para>

        <screen>*CLI&gt; core show application Devstate 
-= Info about application 'Devstate' =-
[Synopsis] 
Generate a device state change event given the input parameters 

[Description] 
Devstate(device|state): 
Generate a device state change event given the input parameters. Returns 0. State values match the asterisk device states. They are 0 = unknown, 1 = not inuse, 2 = inuse, 3 = busy, 4 = invalid, 5 = unavailable, 6 = ringing
*CLI&gt;</screen>

        <para>Der Parameter "device" stellt nichts weiter dar, als eine
        spezielle Extension vom Typ Device-State, die aber im Prinzip exakt so
        angesprochen wird wie z.B. eine SIP-Extension. Die Device-States
        sollten im Wählplan gut von regulären Extensions unterscheidbar sein,
        damit man bei der Wartung und Fehlersuche nicht durcheinander
        kommt.</para>

        <para>Genau wie oben bereits beschrieben, muss in der
        snom-Konfiguration die anzusteuernde Leitungsanzeige mit der passenden
        Extension eingestellt werden. Auch hier muss als Typ der Parameter
        "Ziel" gewählt werden. Im nachfolgenden Beispiel wird die "9912" zur
        Ansteuerung der Anzeige P12 genutzt. P6 ist nach wie vor aus dem
        obigen Beispiel gesetzt und bleibt auch in bekannter Weise
        funktionsfähig.</para>

        <screenshot>
          <screeninfo>Gezielte LED-Ansteuerung</screeninfo>

          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="bilder/snom-hint3.png" />
            </imageobject>

            <imageobject role="html">
              <imagedata fileref="bilder/snom-hint3.html.jpg" />
            </imageobject>
          </mediaobject>
        </screenshot>

        <para>In der Datei <filename>extensions.conf</filename> muss nun ein
        weiterer Hint gesetzt werden, diesmal vom Typ DS statt SIP:</para>

        <programlisting>[meine-telefone]
exten =&gt; 2001,hint,SIP/2001
exten =&gt; 9912,hint,DS/9912

; Gespraechsuebernahme (PickUp)
exten =&gt; _*8.,1,PickUpChan(SIP/${EXTEN:2})</programlisting>

        <para>Das ist bereits alles. Wie gehabt nun das Telefon neu anmelden,
        damit die Subscriptions registriert werden. Mittels <command>core show
        hints</command> sieht man nun einen weiteren Hint aufgeführt:</para>

        <screen>*CLI&gt; core show hints
    -= Registered Asterisk Dial Plan Hints =-
   9912                : DS/9912               State:Unavailable     Watchers  1
   2001                : SIP/2001              State:Idle            Watchers  1
----------------
- 2 hints registered
*CLI&gt;</screen>

        <para>Auch ein <command>sip show subscriptions</command> sollte einen
        weiteren Wert anzeigen:</para>

        <screen>*CLI&gt; sip show subscriptions
Peer             User        Call ID      Extension        Last state     Type
192.168.0.2      2000        866a9545a90  9912             Idle           dialog-info+xml
192.168.0.2      2000        866a9545a90  2001             Idle           dialog-info+xml
2 active SIP subscriptions
*CLI&gt;</screen>

        <para>Um die Funktionsweise zu testen, kann der Wählplan z.B. um
        folgenden Code erweitert werden:</para>

        <programlisting>exten =&gt; _*9X,1,Answer()
exten =&gt; _*9X,n,Devstate(9912,${EXTEN:2})
exten =&gt; _*9X,n,Wait(1)
exten =&gt; _*9X,n,Hangup()</programlisting>

        <para>Nun können die verschiedene Device-States über *9&lt;state&gt;
        überprüft werden, z.B. kann man die LED mit *96 blinken oder mit *92
        dauerhaft leuchten lassen sowie mit *91 wieder deaktivieren. Ist die
        Funktionsweise einmal sichergestellt, sind der sinnvollen Anwendung
        dieses Features natürlich keine Grenzen gesetzt.</para>
      </section>

      <section id="snom-leds-custom-devstate">
        <title>Funktion DEVSTATE() ab Asterisk 1.6</title>

        <indexterm>
          <primary>DEVSTATE()</primary>
        </indexterm>

        <indexterm>
          <primary>Funktionen</primary>

          <secondary>DEVSTATE()</secondary>
        </indexterm>

        <para>Ab Asterisk 1.6 ist die oben beschriebene Funktionalität nicht
        als Applikation DevState() sondern als Funktion DEVSTATE()
        eingebaut.</para>

        <para>Siehe dazu auch: Blog-Artikel "Custom Device State" von Russel
        Bryant (Leiter der Open-Source-Entwicklung bei Digium) unter <ulink
        url="http://www.asterisk.org/node/48325">http://www.asterisk.org/node/48325</ulink></para>

        <para>Für diejenigen die vor einem Patch nicht zurückschrecken gibt es
        die Funktion auch als Backport für Asterisk 1.4, siehe <ulink
        url="http://www.asterisk.org/node/48360">http://www.asterisk.org/node/48360</ulink></para>
      </section>
    </section>
  </section>
</section>