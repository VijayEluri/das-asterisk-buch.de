<?xml version="1.0" encoding="ISO-8859-1"?>
<section id="telefone-snom" lang="de" revision="$Revision$">
  <!--% Copyright (c) 2006 
% - Stefan Wintermeyer <sw@amooma.de>
% - Norbert A. Richartz <richartz@networkers.de>
% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts. A copy of the license is included in the section entitled "GNU
% Free Documentation License".
% Asterisk training and consulting is offered at http://www.amooma.de-->

  <title>Snom VoIP-Telefone<indexterm>
      <primary>snom</primary>

      <secondary>SIP-Telefone</secondary>
    </indexterm></title>

  <para>VoIP-Telefone der Firma <ulink
  url="http://www.snom.de/"><citetitle>snom</citetitle></ulink> sind in
  Deutschland sehr beliebt und werden deshalb an dieser Stelle im Detail
  beschrieben. Es gibt eine Reihe von verschiedenen snom-Telefonen. Das snom
  360 sticht allerdings mit einigen Features für den Einsatz in großen Firmen
  hervor. Alle snom-Telefone bieten durch die umfangreiche SIP-Unterstützung
  in Kombination mit Asterisk Eigenschaften, die man sonst nur von
  herstellerspezifischen Anlagen mit Systemtelefonen kennt.</para>

  <section id="snom-asterisk-sip.conf">
    <title>Konfiguration von Asterisk</title>

    <para>Standard-Snom-Telefone können mit dem SIP-Protokoll an eine
    Asterisk-Anlage angeschlossen werden. Um die Komformerkmale zu
    beschreiben, nehmen wir als Standardkonfiguration diejenige aus <xref
    linkend="kapitel-installation" /> und erweitern sie wie folgt:</para>

    <para>Der Eintrag in der <filename>sip.conf</filename> Datei von
    Asterisk:</para>

    <programlisting>[general]
port = 5060
bindaddr = 0.0.0.0
context = sonstige

[2000]
type=friend
context=meine-telefone
secret=1234
host=dynamic
mailbox=2000

[2001]
type=friend
context=meine-telefone
secret=1234
host=dynamic
mailbox=2001</programlisting>

    <para>Der Eintrag <code>mailbox=...</code> sorgt dafür, dass die
    "Message"-Anzeige des snom-Endgerätes angesprochen wird. Sobald eine
    Nachricht auf der entsprechenden Mailbox des Teilnehmers eingegangen ist,
    wird dies standardmäßig durch ein blinkendes "Message"-Lämpchen angezeigt.
    Dieser Mechanismus wird MWI genannt, "Message Waiting Indicator". Je nach
    Einstellung des Telefons kann ein Nachrichteneingang zusätzlich auch
    akustisch signalisiert werden. Stellen sie bitte vorher sicher, dass eine
    passende Mailbox innerhalb der <filename>voicemail.conf</filename>-Datei
    angelegt wurde:</para>

    <programlisting>[general]
format = wav

[default]
2000 =&gt; 4711,Hans Mustermann,hansi@company.de
2001 =&gt; 0815,Ute Beispiel,ute.beispiel@company.de</programlisting>

    <para>Jedes snom-Telefon verfügt über eine "Retrieve"-Taste, um neue
    Sprachnachrichten im Voicemailsystem abzurufen. Wird diese Taste gedrückt,
    wählt das snom-Telefon in der Werkseinstellung die Extension
    <parameter>asterisk</parameter> an. Der Dialplan muss entsprechend um eine
    solche Extension erweitert werden:</para>

    <programlisting>[sonstige]

[meine-telefone]
exten =&gt; _2XXX,1,Dial(SIP/${EXTEN},20,j)
exten =&gt; _2XXX,n,VoiceMail(u${EXTEN})

exten =&gt; 2999,1,VoiceMailMain(s${CALLERID(num)})

exten =&gt; asterisk,1,VoicemailMain(s${CALLERID(num)})</programlisting>

    <tip>
      <para>Um die für die Voicemail anzuwählende Extension zu ändern, muss in
      der Datei <filename>sip.conf</filename> der Parameter
      <code>vmexten=...</code> hinzugefügt werden.</para>

      <programlisting>[2001]
type=friend
context=meine-telefone
secret=1234
host=dynamic
mailbox=2001
vmexten=obelisk</programlisting>
    </tip>

    <para>Snom-Telefone zeigen eingegangene Nachrichten auch im Display im
    Klartext an, daher sollten für diesen Fall durchaus "sprechende" Namen
    genutzt werden.</para>

    <warning>
      <para>Die "Retrieve"-Taste funktioniert nur, wenn die "Message"-Anzeige
      blinkt, d.h. nur nach dem Eingang einer neuen Nachricht. Um alte
      Nachrichten abzuhören oder die Mailbox zu konfigurieren, muss im
      Wählplan eine eigene Extension zum Abhören der Mailbox eingerichtet
      werden (im Beispiel ist dies die <parameter>2999</parameter>). Diese
      kann man dann entweder manuell anwählen, eine der Funktionstasten des
      Telefons belegen oder bei den snom 360-Modellen über die XML-Steuerung
      einen Menüpunkt zur Verfügung stellen.</para>
    </warning>

    <para>Nun sind alle grundlegenden Schritte für die Integration der
    snom-Telefone in Asterisk durchgeführt.</para>
  </section>

  <section id="snom-konfiguration">
    <title>Konfiguration der Telefone</title>

    <para>Konfiguriert man ein einzelnes Gerät, so kann dies durchaus manuell
    erfolgen. In diesem Fall sollte man dem Gerät dennoch per DHCP eine
    IP-Adresse zuweisen lassen und den Rest der Konfiguration dann bequem über
    einen Webbrowser durchführen, denn die snom-Telefone verfügen alle über
    einen eingebauten Webserver, so dass alle komfortabel von außen editiert
    werden können, ohne dass man sich über die zehn Ziffern- und Menütasten
    quälen muss.</para>

    <important>
      <para>Achten Sie darauf, dass sich das Telefon im Admin-Modus befindet,
      nur so können Sie wirklich alle Einstellungen des Telefons verändern.
      Normalerweise befindet sich das Telefon in diesem Modus, falls nicht,
      kann dieser über die "Settings"-Taste aktiviert werden. Das
      Default-Admin-Passwort ist "0000".</para>
    </important>

    <section id="snom-konfiguration-manuell">
      <title>Manuelle Konfiguration</title>

      <para>Alle Details zur Einstellung am Gerät selbst finden sich auf der
      snom-Homepage <ulink
      url="http://www.snom.com/">http://www.snom.com/</ulink> und im Wiki
      <ulink url="http://wiki.snom.com/">http://wiki.snom.com/</ulink>. Dort
      sind für alle Endgeräte-Anleitungen im PDF-Format frei erhältlich. Die
      Konfiguration zur Anbindung eines Telefons an eine Anlage mit obiger
      Beispiel-Konfiguration ist sehr einfach:</para>

      <figure id="snom-konfiguration-screenshot">
        <title>snom Konfiguration</title>

        <screenshot>
          <screeninfo>Konfiguration einer Leitung im snom
          Soft-Phone</screeninfo>

          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="bilder/snom-setting.png" />
            </imageobject>

            <imageobject role="html">
              <imagedata fileref="bilder/snom-setting.html.jpg" />
            </imageobject>
          </mediaobject>
        </screenshot>
      </figure>

      <para>Bereits nach diesen Einstellungen sollte sich das Telefon
      erfolgreich mit der Anlage verbinden können.</para>

      <para>Für ein Massen-Rollout ist ein solches Verfahren natürlich denkbar
      ungeeignet. Daher sind nachfolgend die Schritte beschrieben, die ein
      Rollout auch in großen Stückzahlen ermöglichen.</para>
    </section>

    <section id="snom-konfiguration-automatisch">
      <title>Automatische Konfiguration</title>

      <para>Zunächst sollten Sie Ihren DHCP-Server mit ein paar zusätzlichen
      Einstellungen konfigurieren. Es wird davon ausgegangen, dass der
      Telefonserver und die Telefone in einem eigens dafür eingerichteten
      Netzwerk, bzw. Netzwerk-Segment agieren. Sollte eine Integration in ein
      bestehendes Netzwerk durchgeführt werden, ist im Einzelfall zu
      überprüfen, ob sich die notwendigen Einstellungen mit bereits im Netz
      befindlichen Geräten vertragen.</para>

      <para>Damit die Telefone in der Lage sind, sich selbständig zu
      konfigurieren, muss ein spezieller DHCP-Parameter beim DHCP-Request mit
      übergeben werden. Dies kann bei den meisten Linux-Systemen über die
      Datei <filename>/etc/dhcp.conf</filename> festgelegt werden:</para>

      <programlisting>option tftp-server-name "http://pbx.apfelmus-gmbh.de/snom/settings/snom.php?mac={mac}";</programlisting>

      <para>Nachdem die Geräte ihre IP-Adresse erhalten haben, setzen sie
      automatisch eine Abfrage an die oben angegebene URL ab, um ihre
      Konfiguration zu erhalten. Dabei wird der Parameter <code>{mac}</code>
      automatisch mit der MAC-Adresse des Telefons belegt. Man sollte sich
      nicht verwirren lassen, dass ein HTTP- statt eines TFTP-Servers über
      diesen Parameter konfiguriert wird. Die Telefone erkennen automatisch,
      dass sie einen HTTP-Request durchführen müssen. Es muss kein
      zusätzlicher TFTP-Server konfiguriert werden. Nachfolgend ein Beispiel
      für ein PHP-Skript, das als Rückgabe die Settings für ein bestimmtes
      Telefon liefert:</para>

      <programlisting>&lt;html&gt;
&lt;pre&gt;

&lt;?php
 // Die MAC-Adresse aus der URL (GET) lesen und in $mac abspeichern.
 $mac = $_GET['mac'];

 // Allgemeine Konfiguration 
 readfile("snom-base.htm");

 // Spezielle Konfiguration fuer diese MAC-Adresse
 readfile("snom-".$mac.".htm");
?&gt;

&lt;/pre&gt;
&lt;/html&gt;</programlisting>

      <para>Über das Skript wird der Inhalt mehrerer Dateien übermittelt.
      Neben dem Header, dem Footer und den Einstellungen, die bei allen
      Endgeräten konstant sein sollen, wird des Weiteren eine Datei speziell
      für das Telefon mit der übergebenen MAC-Nummer übermittelt.</para>

      <para>In der Datei <filename>snom-base.htm</filename> befinden sich die
      Settings, die für alle Telefone identisch sein sollen. In der Regel kann
      man hier Sprach- und Datumseinstellungen, feste Tastaturbelegungen etc.
      konfigurieren.</para>

      <programlisting># After each setting (before the colon) you can set a flag, which means respectively:
# ! means writeable by the user, but will not overwrite existing
# $ means writeable by the user, but will overwrite existing (available since version 4.2)
# &amp; (or no flag) means read only, but will overwrite existing

# more settings can be found at the settings (dump) page of the phone's build in webinterface

# Language and Time settings

language$: Deutsch
web_language$: Deutsch
timezone$: GER+1
date_us_format&amp;: off
time_24_format&amp;: on
tone_scheme&amp;: GER

# define the firmware update policy here
# valid values are &lt;auto_update&gt;, &lt;ask_for_update&gt;, &lt;never_update_firm&gt;,
# &lt;never_update_boot&gt;, &lt;settings_only&gt;
update_policy: auto_update

#define the firmware update interval here, amount in minutes, default is 1440 = 1 day
firmware_interval: 2880

setting_server!: http://pbx.apfelmus-gmbh.de/snom/settings/snom.php?mac={mac}
subscribe_config!: off
update_server!: http://pbx.apfelmus-gmbh.de/snom/settings/snom.php?mac={mac}
contrast!: 14

dtmf_speaker_phone!: on
web_language!: Deutsch
dkey_snom&amp;: url http://pbx.apfelmus-gmbh.de/snom/webapps/mainmenu.xml

admin_mode: off
admin_mode_password$:4321
admin_mode_password_confirm$:4321

alert_internal_ring_text: alert-internal
alert_external_ring_text: alert-external
alert_group_ring_text: alert-group</programlisting>

      <para>Alle oben aufgeführten Einstellungen sind im Grunde
      Standard-Einstellungen. Besonderes Augenmerk gilt den Parametern
      <code>dkey_snom</code>, <code>alert_internal_ring_text</code>,
      <code>alert_external_ring_text</code> und
      <code>alert_group_ring_text</code>. Deren Bedeutung wird später noch
      genauer erläutert.</para>

      <para>Passend zur allgemeinen Konfiguration bekommt jedes Telefon auch
      eine spezifische Konfiguration. Jeder Teilnehmer sollte in der Lage
      sein, bei einem Bürowechsel oder einem Reset des Telefons genau die
      Konfiguration an seinem Telefon wiederzufinden, die ihm vom
      Administrator zugewiesen wurde. Telefonspezifische Einstellungen werden
      daher in einer Datei <filename>snom-{mac}.htm</filename> abgespeichert,
      also bei einem Telefon mit MAC-Adresse
      <parameter>00:04:13:23:8B:60</parameter> in der Datei
      <filename>snom-000413238B60.htm</filename>. Der Aufbau des Dateinamens
      ist prinzipiell beliebig, wichtig dabei ist die Einhaltung der gedachten
      Kette zwischen den Einstellungen innerhalb der DHCP-Konfiguration, der
      dazugehörigen Skriptdatei und letztendlich der Settings-Datei des
      Telefons. Hier die spezielle Konfiguration eines solchen
      Telefons:</para>

      <programlisting># After each setting (before the colon) you can set a flag, which means respectively:
# ! means writeable by the user, but will not overwrite existing
# $ means writeable by the user, but will overwrite existing (available since version 4.2)
# &amp; (or no flag) means read only, but will overwrite existing

# First account
user_active1!: on
user_realname1$: Hans Mustermann &lt;2000&gt;
user_name1$: 2000
user_host1&amp;: pbx.apfelmus-gmbh.de
user_pass1$: 1234

# You may add up to 12 accounts

# set second account to active outgoing identity
active_line$: 1

# in order to perform automated updates, define the firmware setting file URL
# where you specify the final firmware image URL
firmware_status: http://pbx.apfelmus-gmbh.de/snom/firmware360.htm</programlisting>

      <para>Man erkennt in der Konfiguration exakt die Einstellungen wieder,
      die auch oben in der manuellen Einstellung konfiguriert wurden. Wichtig
      sind die Flags, die man pro Parameter angeben kann:</para>

      <informaltable>
        <tgroup cols="2">
          <colspec colnum="1" colwidth="5cm" />

          <tbody>
            <row>
              <entry>!</entry>

              <entry>Der Parameter kann vom Anwender über das Telefon geändert
              werden. Bestehende Einstellungen werden beim Laden des
              Settings-Files nicht geändert.</entry>
            </row>

            <row>
              <entry>$</entry>

              <entry>Der Parameter kann vom Anwender über das Telefon geändert
              werden. Bestehende Einstellungen werden beim Laden des
              Settings-Files überschrieben.</entry>
            </row>

            <row>
              <entry>&amp; oder kein Flag</entry>

              <entry>Der Parameter kann vom Anwender nicht über das Telefon
              geändert werden. Bestehende Einstellungen werden beim Laden des
              Settings-Files überschrieben.</entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>

      <para>Man sollte sehr genau abwägen, welche Parameter man für die
      Anwender freigibt und welche man festzurrt. Allein die Reduktion auf den
      User-Mode statt dem Admin-Mode des Telefons erleichtert Administratoren
      später den Alltag.</para>

      <tip>
        <para>Es ist sehr leicht möglich, ein Template für die snom-Telefone
        zu erstellen, ohne zunächst mühsam die komplette Dokumentation zu
        lesen. Am einfachsten konfiguriert man zunächst ein Telefon manuell
        über einen Webbrowser. In der Navigationsleiste des Web-Interface des
        Telefons befindet sich ganz unten ein Punkt "Einstellungen" (der
        Admin-Modus muss aktiv sein!). Dort werden dann im Browser alle
        aktuellen Einstellungen mit den passenden Parametern ausgegeben. Man
        braucht also nur noch die gewünschten Parameter in eine entsprechende
        Datei zu kopieren. Bitte übernehmen Sie auf keinen Fall alle Parameter
        aus der Liste, sondern ausschließlich die, die für Ihre spezielle
        Konfiguration wichtig sind. Danach entscheiden Sie über die oben
        angegebenen Flags, welche der Parameter vom Anwender geändert werden
        dürfen und welche nicht.</para>
      </tip>

      <important>
        <para>Sollte die automatische Konfiguration aus irgendeinem Grund
        nicht funktionieren, so lohnt sich ein Blick in die Datei
        <filename>/var/log/messages</filename>, um herauszufinden, welche
        DHCP-Anfragen gestellt wurden, sowie in das Access-Log des Webservers,
        um zu überprüfen, ob überhaupt die richtigen Dateien angefordert
        wurden. Bei einem Apache 2.0 auf einem Debian Linux wäre dies z.B. die
        Datei <filename>/var/log/apache2/access_log</filename>. Mittels dieser
        beiden Logs lassen sich die Fehler bei der Konfiguration in der Regel
        sehr schnell finden und beheben. Zur Fehlersuche kann man zunächst
        auch mit statischen Konfigurationsdateien statt mit einem PHP-Skript
        arbeiten. So wird die Komplexität verringert und es können Fehler in
        der Skiptdatei ausgeschlossen werden.</para>
      </important>

      <warning>
        <para>Die snom-Telefone brauchen zum Laden und Aktivieren der Settings
        einige Sekunden. Auch wenn das Telefon sich zunächst in den
        Standard-Konfigurations-Modus versetzt, warten Sie erst einige
        Sekunden, bevor Sie einen vermeintlich fehlerhaften Versuch
        abbrechen.</para>
      </warning>
    </section>
  </section>

  <section id="snom-klingeltoene">
    <title>Unterschiedliche Klingeltöne</title>

    <para>Nachfolgend ist ein kleines Beispiel aufgeführt, wie man eine
    unterschiedliche Signalisierung für interne, externe und Gruppenanrufe
    realisieren kann. Dabei spielen die Parameter
    <code>alert_internal_ring_text</code>,
    <code>alert_external_ring_text</code> und
    <code>alert_group_ring_text</code> eine Rolle. Über den SIP-Header ist es
    möglich, eine Signalisierungsinformation mit zu übergeben, auch Alert-Info
    genannt. Die Telefone erkennen dann über diese Info, ob sie ggfs. eine
    andere Ruf-Signalisierung nutzen sollen, soweit dies vom Anwender
    konfiguriert wurde. Dazu muss vor der eigentlichen Anwahl über das
    <command>Dial()</command>-Kommando der
    <command>SIPAddHeader()</command>-Befehl abgesetzt werden. Anbei ein
    entsprechender Auszug aus der <filename>extensions.conf</filename>
    Datei.</para>

    <programlisting>exten =&gt; _2XXX,1,SIPAddHeader("Alert-Info: &lt;http://pbx.apfelmus-gmbh.de&gt;\;info=alert-internal\;x-line-id=0")
exten =&gt; _2XXX,2,Dial(SIP/${EXTEN})</programlisting>

    <para>Das Format des SIP-Headers ist vorgegeben, wichtig ist in diesem
    Fall eigentlich nur der zweite Parameter <code>info=alert-internal</code>
    . Hier muss einer der drei konfigurierten Texte stehen, an denen das
    Telefon die Art des Rufes erkennen soll. Welcher Text dort steht, ist
    eigentlich egal, aber er muss jeweils mit den Werten übereinstimmen, die
    bei den Telefon-Parametern <code>alert_internal_ring_text</code>,
    <code>alert_external_ring_text</code> oder
    <code>alert_group_ring_text</code> übergeben wurden. Es empfiehlt sich,
    die jeweiligen Default-Werte zu übernehmen.</para>

    <important>
      <para>Bitte beachten Sie, dass die Semikolons im Alert-Info mittels
      "\"-Zeichen maskiert ("gequotet") werden müssen. Ansonsten interpretiert
      Asterisk alles ab dem ersten Semikolon als Kommentar und der Befehl wird
      nur unvollständig oder gar nicht ausgeführt.</para>
    </important>

    <para>In der oberen Variante wird davon ausgegangen, dass das Telefon
    anhand des Info-Parameters selbst entscheidet, welchen Rufton es auswählen
    muss. Man kann diesen Befehl aber auch dazu nutzen, einen Rufton
    vorzugeben, indem man eine entsprechende URL angibt, die auf eine
    Sounddatei verweist.</para>

    <programlisting>exten =&gt; _2XXX,1,SIPAddHeader(Alert-Info: &lt;http://pbx.apfelmus-gmbh.de/snom/sounds/snom_trumpet.wav&gt;)
exten =&gt; _2XXX,n,Dial(SIP/${EXTEN})</programlisting>

    <para>Es bietet sich an, einfach mit den verschiedenen Möglichkeiten zu
    experimentieren. Eine Unterscheidung zwischen internen, externen und
    Gruppenanrufen macht in den meisten Fällen durchaus Sinn.</para>
  </section>

  <section id="snom-360-menu">
    <title>Benutzerdefinierte Menüführung (nur snom 360)</title>

    <para>Die Geräte der 360er Baureihe verfügen über von außen
    programmierbare Menüs. Die zugrundeliegenden XML-Strukturen sind unter
    <ulink url="???">http://www.snom.info/wiki/index.php/Xmlobjects</ulink>
    ausführlich erläutert. In der oben angegebenen automatischen Konfiguration
    wurde bereits auf die Zeile <code>dkey_snom&amp;: url
    http://pbx.apfelmus-gmbh.de/snom/webapps/mainmenu.xml</code> hingewiesen.
    Hier wurde die auf dem Telefon befindliche snom-Taste umbelegt, so dass
    der interne XML-Browser die dort verlinkte XML-Datei aufruft und
    interpretiert. Wie schon bei der automatischen Konfiguration der Telefone
    ist die Installation eines Webservers auf dem Telefonanlagenrechner zu
    empfehlen, zumal die meisten Linux-Distributionen diese Option bereits von
    Hause aus anbieten.</para>

    <para>Die Datei <filename>mainmenu.xml</filename> hat folgenden
    Aufbau:</para>

    <programlisting>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;SnomIPPhoneMenu&gt;
&lt;Title&gt;Menu&lt;/Title&gt;
&lt;MenuItem&gt;
&lt;Name&gt;Globales Adressbuch&lt;/Name&gt;
&lt;URL&gt;http://pbx.apfelmus-gmbh.de/snom/webapps/phonebook/phonebook.php&lt;/URL&gt;
&lt;/MenuItem&gt;
&lt;MenuItem&gt;
&lt;Name&gt;Sondernummern&lt;/Name&gt;
&lt;URL&gt;http://pbx.apfelmus-gmbh.de/snom/webapps/specialnums.xml&lt;/URL&gt;
&lt;/MenuItem&gt;
&lt;/SnomIPPhoneMenu&gt;</programlisting>

    <para>Ein Druck auf die snom-Taste führt zu einem Menü mit den beiden
    Einträgen "Globales Adressbuch" und "Sondernummern". Wie von der
    Benutzerführung gewohnt, kann man innerhalb dieser Menüs mit den
    Telefon-Cursor-Tasten navigieren und Einträge mit der Häkchentaste
    auswählen. Eine Ebene zurück gelangt man mit der X-Taste.</para>

    <tip>
      <para>Den "xml version"-Header kann man auch weglassen, der eingebaute
      Browser ist in der Lage, das XML-Menü auch ohne diese Header korrekt zu
      interpretieren.</para>
    </tip>

    <para>Diese Menüform führt noch keine Wahlvorgänge durch, sondern dient
    nur der Anzeige von Menüeinträgen, mit denen man wiederum neue URLs
    aufrufen kann.</para>

    <para>Weiter oben wurde erläutert, dass man mittels der "Retrieve"-Taste
    ausschließlich dann die Voicemail anrufen kann, wenn neue Nachrichten
    eingegangen sind. Es wurde daher eine Extension "2999" definiert, welche
    die Abfrage der Mailbox zu jeder Zeit ermöglicht. Diese kann man durch ein
    spezielles XML-Menü anwählen lassen. Das Beispiel
    <filename>specialnums.xml</filename> zeigt genau dies:</para>

    <programlisting>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;SnomIPPhoneDirectory&gt;
&lt;Title&gt;Sondernummern&lt;/Title&gt;
&lt;Prompt&gt;Prompt&lt;/Prompt&gt;
&lt;DirectoryEntry&gt;
&lt;Name&gt;Mailbox&lt;/Name&gt;
&lt;Telephone&gt;2999&lt;/Telephone&gt;
&lt;/DirectoryEntry&gt;
&lt;/SnomIPPhoneDirectory&gt;</programlisting>

    <para>Der Anwender bekommt nach Auswahl des Menüs "Sondernummern" nun
    einen Eintrag "Mailbox" angezeigt, den er wie gehabt auswählen kann. Durch
    das XML-Objekt <code>SnomIPPhoneDirectory</code> weiß das Telefon, dass
    nachfolgend Rufnummern gelistet sind, die es nach der Auswahl durch den
    Anwender anrufen soll. Nachdem der Anwender also den Eintrag "Mailbox"
    gewählt hat, ruft das Telefon die <parameter>2999</parameter> an, nach dem
    oben angegebenen Wählplan also die Abfrage der eigenen Voicemail.</para>

    <warning>
      <para>snom-Telefone, die mit der Firmware 6.5.2 oder früher ausgestattet
      sind, zeigen kurz vor der Anwahl einen <errortext>xml response
      error</errortext> im Display an. Dies ist ein Fehler der Firmware und
      hat nichts mit den XML-Konfigurationsdateien zu tun. Einfluss auf die
      Funktionalität hat dieser Fehler nicht.</para>
    </warning>
  </section>

  <section id="snom-leds">
    <title>Ansteuerung der Leitungstasten und -LEDs</title>

    <para>snom-Telefone bieten die Möglichkeit, die Leitungstasten nicht nur
    mit speziellen URLs oder Kurzwahlen zu belegen, man kann diese auch zur
    Überwachung und Übernahme (PickUp) anderer Leitungen nutzen, was z.B. bei
    Gruppenanrufen eine sehr nützliche Angelegenheit ist.</para>

    <section id="snom-leds-anzeige">
      <title>Konfiguration der Rufanzeige</title>

      <para>Zunächst muss in der Datei <filename>sip.conf</filename> die
      <code>[general]</code>-Sektion erweitert werden:</para>

      <programlisting>[general]
allowsubscribe = yes
notifyringing = yes
notifyhold = yes
useclientcode = yes
limitonpeers = yes</programlisting>

      <para>Des Weiteren muss in der Sektion des Telefons, das die
      überwachende Rolle übernimmt, eine sogenannte "Subscription" eingetragen
      werden. Damit meldet das Telefon bei Asterisk an, dass es über
      Status-Änderungen anderer Telefone informiert werden will. Der Context,
      für den sich das Telefon anmeldet, muss identisch sein mit dem Context,
      in dem die sogenannten "Hints" der Telefone gesetzt werden, die
      überwacht werden sollen. In der Regel ist dieser identisch mit dem
      Context, in dem sich die eigentlichen Telefone bewegen.</para>

      <para>Außerdem muß ein "call-limit" auf einen Wert größer als 0 gesetzt
      sein (am besten mindestens 2, sonst hat man Probleme bei Transfers
      etc.).</para>

      <programlisting>[2000]
type = friend
context = meine-telefone
subscribecontext = meine-telefone
call-limit = 20
secret = 1234
host = dynamic
mailbox = 2000</programlisting>

      <para>Für die zu überwachenden Telefone muss innerhalb der
      <filename>sip.conf</filename> kein Eintrag hinzugefügt werden, dies
      geschieht ausschließlich in der <filename>extensions.conf</filename>. Im
      Wählplan müssen die oben bereits erwähnten "Hints" gesetzt werden. Über
      diese Hints wird Asterisk quasi erlaubt, Informationen über den Zustand
      der dort definierten Extensions weiterzugeben, nämlich genau an die oben
      konfigurierten Subscriber. Es ist wichtig, dass die Hints genau in dem
      Context gesetzt werden, in dem sich das überwachende Telefon über die
      Zeile <code>subscribecontext=...</code> angemeldet hat, ansonsten werden
      die Status-Informationen nicht weitergeleitet. Dies ist durchaus
      Absicht, damit man nicht per se von allen Telefonen alle weiteren
      überwachen, sondern durch die Wahl des Contextes eine Auswahl treffen
      kann.</para>

      <programlisting>[sonstige]

[meine-telefone]
exten =&gt; 2001,hint,SIP/2001
exten =&gt; 2002,hint,SIP/2002
exten =&gt; 2003,hint,SIP/2003

exten =&gt; _2XXX,1,Dial(SIP/${EXTEN})
exten =&gt; _2XXX,n,VoiceMail(u${EXTEN})
</programlisting>

      <important>
        <para>Die hint-Priorität war in der Vergangenheit immer für einige
        Tücken und Probleme bekannt. In einigen älteren Asterisk-Versionen ist
        die Priorität case-sensitive, muss also auf alle Fälle
        kleingeschrieben werden. Und es muß für jedes Telefon ein Hint
        definiert werden. Der Übersichtlichkeit halber kann man alle
        gesammelten Hints auch in einen eigenen Context legen und diesen
        überall dort mit <code>include =&gt;...</code> einbinden, wo er
        benötigt wird.</para>
      </important>

      <para>Nun muss noch das überwachende Telefon konfiguriert werden. Dazu
      melden Sie sich wie gewohnt mit einem Webbrowser am Telefon an und gehen
      in das Untermenü "Funktionstasten". Dort belegen Sie die Funktionstaste
      Ihrer Wahl (im Beispiel die P6) mit dem Typ "Ziel"/"Nebenstelle" und
      tragen die zu überwachende Extension ein, hier also die 2001.</para>

      <screenshot>
        <screeninfo>snom Konfiguration Leitungsüberwachung</screeninfo>

        <mediaobject>
          <imageobject role="fo">
            <imagedata fileref="bilder/snom-hint1.png" />
          </imageobject>

          <imageobject role="html">
            <imagedata fileref="bilder/snom-hint1.html.jpg" />
          </imageobject>
        </mediaobject>
      </screenshot>

      <para>Nachdem die Einstellungen gespeichert wurden, ändert das Telefon
      den Eintrag automatisch in eine passende URI der Form
      &lt;sip:2001@xxx.xxx.xxx.xxx;user=phone&gt; (xxx.xxx.xxx.xxx ist die
      IP-Adresse der Telefonanlage) ab:</para>

      <screenshot>
        <screeninfo>snom Konfiguration Leitungsüberwachung Ziel</screeninfo>

        <mediaobject>
          <imageobject role="fo">
            <imagedata fileref="bilder/snom-hint2.png" />
          </imageobject>

          <imageobject role="html">
            <imagedata fileref="bilder/snom-hint2.html.jpg" />
          </imageobject>
        </mediaobject>
      </screenshot>

      <important>
        <para>Die Bezeichnung "Ziel" wurde in den snom-Hardphones in einem der
        neueren Releases in "Nebenstelle" umbenannt und gilt daher nur noch
        für die Softphones und ältere Firmware-Stände in den Hardphones. Es
        ist nur eine Umbenennung, die weitere hier beschriebene Funktionalität
        bleibt unverändert erhalten.</para>
      </important>

      <para>Nun sind alle Einstellungen getätigt. Zunächst muss Asterisk neu
      gestartet werden und anschließend die Telefone. Der Telefon-Neustart
      nach dem Asterisk-Neustart ist für die saubere Anmeldung der
      Subscription des Telefons notwendig. Zunächst sollte überprüft werden,
      ob alles richtig konfiguriert wurde. Dazu geben Sie im Asterisk-CLI die
      Zeile <command>show hints</command> (<command>core show hints</command>
      in Version 1.4) ein:</para>

      <screen>*CLI&gt; show hints

    -= Registered Asterisk Dial Plan Hints =-
   2001                : SIP/2001              State:Unavailable     Watchers  0
----------------
- 1 hints registered
*CLI&gt;</screen>

      <para>In obigem Beispiel wird deutlich, dass das zu überwachende Telefon
      noch nicht am Asterisk-Server angemeldet ist
      (<parameter>unavailable</parameter>). Ebenso ist auch noch kein
      überwachendes Telefon an den Status dieser Extension angeklinkt
      (Watchers-Wert ist 0). Letzteres wird auch durch die Auflistung der
      aktiven Subscriptions bestätigt, die durch das Kommando <command>sip
      show subscriptions</command> initiiert wird.</para>

      <screen>*CLI&gt; sip show subscriptions
Peer             User        Call ID      Extension        Last state     Type
0 active SIP subscriptions
*CLI&gt;</screen>

      <para>Nun melden Sie zunächst das überwachende Telefon an und setzen den
      Befehl erneut ab:</para>

      <screen>*CLI&gt; sip show subscriptions
Peer             User        Call ID      Extension        Last state     Type
192.168.0.2      2000        815d944554e  2001             Unavailable    dialog-info+xml
1 active SIP subscription
*CLI&gt;</screen>

      <para>Hier wird deutlich, dass der User 2000 die Extension 2001
      überwacht. Bereits jetzt leuchtet die Lampe am Telefon, die zur
      Überwachung konfiguriert wurde. Es ist eine Eigenschaft des
      bristuff-Patches, dass überwachte, aber noch nicht angemeldete Endgeräte
      über eine dauerhaft leuchtende LED angezeigt werden.</para>

      <para>Nun melden Sie das zu überwachende Telefon erneut an. Bereits mit
      der Anmeldung sollte folgende Zeile auf dem Asterisk-CLI
      erscheinen:</para>

      <screen>Extension Changed 2001 new state Idle for Notify User 2000</screen>

      <para>Die LED am überwachenden Telefon erlischt zeitgleich. Setzen Sie
      den Befehl <command>show hints</command> (<command>core show
      hints</command> in Version 1.4) erneut ab:</para>

      <screen>*CLI&gt; show hints

    -= Registered Asterisk Dial Plan Hints =-
   2001                : SIP/2001              State:Idle            Watchers  1
----------------
- 1 hints registered
*CLI&gt;</screen>

      <para>Im Gegensatz zu vorher sieht man, dass das Telefon einen
      definierten Zustand hat ("Idle") und zudem ein weiteres Telefon den
      Zustand überwacht (Watchers-Wert ist 1). Die Konfiguration ist nun
      komplett, Asterisk meldet Statuswechsel der überwachten Extension sofort
      an das überwachende Telefon. Befindet sich das überwachte Telefon im
      Gespräch, leuchtet die LED dauerhaft. Wird das überwachte Telefon
      angerufen, blinkt die LED. Ohne Aktivität ist auch die LED gelöscht. Die
      unterschiedlichen Status sind ebenfalls auf der Konsole sichtbar:</para>

      <screen>Extension Changed 2001 new state InUse for Notify User 2000
Extension Changed 2001 new state Ringing for Notify User 2000
Extension Changed 2001 new state Idle for Notify User 2000</screen>
    </section>

    <section id="snom-leds-pickup">
      <title>Rufannahme (PickUp) eines angezeigten Gesprächs</title>

      <para>In der bisherigen Konfiguration werden Gespräche des überwachten
      Teilnehmers nur angezeigt. Gerade bei Gruppenanrufen ist es nützlich,
      dass ein anderer Teilnehmer diese Anrufe auch übernehmen kann. Um dies
      zu ermöglichen, muss noch ein weiterer Eintrag in der extensions.conf
      hinzugefügt werden.</para>

      <programlisting>[meine-telefone]
exten =&gt; 2001,hint,SIP/2001

; Gespraechsuebernahme (PickUp) fuer bristuff
exten =&gt; _*8.,1,PickUpChan(SIP/${EXTEN:2})</programlisting>

      <para><note>
          <para>Die Gesprächsübernahme durch die Zeichenfolge
          "<parameter>*8</parameter>" kann bei Bedarf in der
          Konfigurationsdatei <filename>features.conf</filename>
          umkonfiguriert werden.</para>
        </note>Jetzt können am überwachten Telefon eingehende Anrufe einfach
      am überwachenden Telefon angenommen werden, indem die zur blinkenden LED
      passende Taste gedrückt wird. Das Gespräch wird dann sofort übernommen,
      die Nummer des Anrufers im Display angezeigt.</para>

      <tip>
        <para>Um bereits zur Anrufzeit und nicht erst nach der Übernahme die
        Nummer des Anrufers im überwachenden Telefon angezeigt zu bekommen,
        müssen in den "Erweiterten Einstellungen" des snom-Telefons zwei
        weitere Einstellungen geändert werden. Das Setting "Dialog-Info Call
        Pickup" muss aktiviert sein, "Pakete vom Registrar filtern" muss
        deaktiviert werden. Die erweiterten Einstellungen sind nur im
        Admin-Modus des Telefons verfügbar.</para>
      </tip>

      <para>Sollen die in diesem Kapitel erläuterten Änderungen in Form einer
      automatischen Konfiguration ins Telefon geladen werden, müssen folgende
      Einstellungen Teil der speziellen Konfiguration des Telefons
      werden:</para>

      <programlisting>fkey5: dest &lt;sip:2001@pbx.apfelmus-gmbh.de;user=phone&gt;
filter_registrar: off
callpickup_dialoginfo: on</programlisting>

      <important>
        <para>Die Funktionstasten sind 0-indiziert. Um wie im Beispiel die
        Funktionstaste 6 zu belegen, muss der Parameter fkey5 gesetzt werden.
        Die Funktionstaste 1 wird mit fkey0 angesprochen.</para>
      </important>
    </section>

    <section id="snom-leds-custom">
      <title>Gezielte Ansteuerung der LEDs</title>

      <section id="snom-leds-custom-bristuff">
        <title>Applikation Devstate() in BRIstuff</title>

        <indexterm>
          <primary>Devstate()</primary>
        </indexterm>

        <para>In der bristuffed-Version von Asterisk ist es ebenfalls möglich,
        die LEDs z.B. auch gezielt aus dem Wählplan anzusteuern. Dazu wurde
        Asterisk die Applikation "Devstate" hinzugefügt. Bitte prüfen Sie auf
        der Asterisk-Konsole über den Befehl <command>show application
        Devstate</command>, ob Ihre Asterisk-Version diesen Patch
        enthält:</para>

        <screen>*CLI&gt; show application Devstate

  -= Info about application 'Devstate' =-

[Synopsis]
Generate a device state change event given the input parameters

[Description]
 Devstate(device|state):  Generate a device state change event given the input parameters. Returns 0. 
 State values match the asterisk device states. They are 0 = unknown, 1 = not inuse, 2 = inuse, 3 = busy, 
 4 = invalid, 5 = unavailable, 6 = ringing

*CLI&gt;</screen>

        <para>Der Parameter "device" stellt nichts weiter dar, als eine
        spezielle Extension vom Typ Device-State, die aber im Prinzip exakt so
        angesprochen wird wie z.B. eine SIP-Extension. Die Device-States
        sollten im Wählplan gut von regulären Extensions unterscheidbar sein,
        damit man bei der Wartung und Fehlersuche nicht durcheinander
        kommt.</para>

        <para>Genau wie oben bereits beschrieben, muss in der
        snom-Konfiguration die anzusteuernde Leitungsanzeige mit der passenden
        Extension eingestellt werden. Auch hier muss als Typ der Parameter
        "Ziel" gewählt werden. Im nachfolgenden Beispiel wird die "9912" zur
        Ansteuerung der Anzeige P12 genutzt. P6 ist nach wie vor aus dem
        obigen Beispiel gesetzt und bleibt auch in bekannter Weise
        funktionsfähig.</para>

        <screenshot>
          <screeninfo>Gezielte LED-Ansteuerung</screeninfo>

          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="bilder/snom-hint3.png" />
            </imageobject>

            <imageobject role="html">
              <imagedata fileref="bilder/snom-hint3.html.jpg" />
            </imageobject>
          </mediaobject>
        </screenshot>

        <para>In der Datei <filename>extensions.conf</filename> muss nun ein
        weiterer Hint gesetzt werden, diesmal vom Typ DS statt SIP:</para>

        <programlisting>[meine-telefone]
exten =&gt; 2001,hint,SIP/2001
exten =&gt; 9912,hint,DS/9912

; Gespraechsuebernahme (PickUp) fuer bristuff
exten =&gt; _*8.,1,PickUpChan(SIP/${EXTEN:2})</programlisting>

        <para>Das ist bereits alles. Wie gehabt nun das Telefon neu anmelden,
        damit die Subscriptions registriert werden. Mittels <command>show
        hints</command> (<command>core show hints</command> in Version 1.4)
        sieht man nun einen weiteren Hint aufgeführt:</para>

        <screen>*CLI&gt; show hints

    -= Registered Asterisk Dial Plan Hints =-
   9912                : DS/9912               State:Unavailable     Watchers  1
   2001                : SIP/2001              State:Idle            Watchers  1
----------------
- 2 hints registered
*CLI&gt;</screen>

        <para>Auch ein <command>show subscriptions</command> sollte einen
        weiteren Wert anzeigen:</para>

        <screen>*CLI&gt; sip show subscriptions
Peer             User        Call ID      Extension        Last state     Type
192.168.0.2      2000        866a9545a90  9912             Idle           dialog-info+xml
192.168.0.2      2000        866a9545a90  2001             Idle           dialog-info+xml
2 active SIP subscriptions
*CLI&gt;</screen>

        <para>Um die Funktionsweise zu testen, kann der Wählplan z.B. um
        folgenden Code erweitert werden:</para>

        <programlisting>exten =&gt; _*9X,1,Answer()
exten =&gt; _*9X,n,Devstate(9912,${EXTEN:2})
exten =&gt; _*9X,n,Wait(1)
exten =&gt; _*9X,n,Hangup()</programlisting>

        <para>Nun können die verschiedene Device-States über *9&lt;state&gt;
        überprüft werden, z.B. kann man die LED mit *96 blinken oder mit *92
        dauerhaft leuchten lassen sowie mit *91 wieder deaktivieren. Ist die
        Funktionsweise einmal sichergestellt, sind der sinnvollen Anwendung
        dieses Features natürlich keine Grenzen gesetzt.</para>
      </section>

      <section id="snom-leds-custom-devstate">
        <title>Funktion DEVSTATE() ab Asterisk 1.6</title>

        <indexterm>
          <primary>DEVSTATE()</primary>
        </indexterm>

        <indexterm>
          <primary>Funktionen</primary>

          <secondary>DEVSTATE()</secondary>
        </indexterm>

        <para>Ab Asterisk 1.6 ist die oben beschriebene Funktionalität
        prinzipiell schon eingebaut, allerdings nicht als Applikation
        Devstate() sondern als Funktion DEVSTATE(), siehe <xref
        linkend="funktionen-devstate" />.</para>

        <para>Siehe dazu auch: Blog-Artikel "Custom Device State" von Russel
        Bryant (Leiter der Open-Source-Entwicklung bei Digium) unter <ulink
        url="http://www.asterisk.org/node/48325">http://www.asterisk.org/node/48325</ulink></para>

        <para>Für diejenigen die vor einem Patch nicht zurückschrecken gibt es
        die Funktion auch als Backport für Asterisk 1.4, siehe <ulink
        url="http://www.asterisk.org/node/48360">http://www.asterisk.org/node/48360</ulink></para>
      </section>
    </section>

    <section id="snom-per-fernwartung-booten">
      <title>Telefone per Fernwartung neu starten</title>

      <para>Um zu gewährleisten, dass die oben beschriebenen Features auch
      wirklich funktionieren, müssen die Telefone nach jedem Neustart von
      Asterisk ebenfalls neu gestartet werden, damit sie die Subscriptions
      sauber im System platzieren können. Für eine zentrale Wartung ist es
      natürlich nicht akzeptabel, die Anwender nach jedem Update der
      Telefonanlage darüber zu informieren, dass sie ihre Telefone neu starten
      sollen. Für die snom-Telefone gibt es daher einen einfachen Mechanismus,
      diese auch aus der Ferne zurückzusetzen. Dazu fügen Sie folgende Zeilen
      in die Datei <filename>/etc/asterisk/sip_notify.conf</filename>
      ein:</para>

      <programlisting>[reboot-snom]
Event=&gt;reboot
Content-Length=&gt;0</programlisting>

      <para>Werden die Konfigurationsdaten in Asterisk neu geladen, können Sie
      ein beliebiges snom-Endgerät über das Kommando <command>sip notify
      reboot-snom <replaceable>extension</replaceable></command> neu starten,
      also zum Beispiel:</para>

      <screen>*CLI&gt; sip notify reboot-snom 2001
Sending NOTIFY of type 'reboot-snom' to '2001'
    -- Unregistered SIP '2001'
*CLI&gt;</screen>

      <para>Das Ganze kann man natürlich auch mit Hilfe eines Skripts von
      außen initiieren, vor allem um mehrere Telefone gleichzeitig
      zurückzusetzen, und wer es wagen möchte, auch über eine spezielle
      Extension eines Administrator-Telefons. Ein notwendiges Skript könnte
      wie folgt ausehen:</para>

      <programlisting>#!/bin/bash
ASTERISK=/usr/sbin/asterisk
$ASTERISK -r -x "sip notify reboot-snom 1000 2000 2001"</programlisting>

      <para>Den Aufruf aus dem Wählplan könnte man wie folgt
      realisieren:</para>

      <programlisting>[globals]
; Kommando zum Zurücksetzen der snom-Telefone
CMD_RESET_SNOM=/usr/local/sbin/resetAllSnoms.sh

[admin]
exten =&gt; 666,1,NoOp(Bastard Operator from Hell Snom Reset)
exten =&gt; 666,n,System(${CMD_RESET_SNOM}) ; Externes Kommando ausfuehren</programlisting>

      <important>
        <para>Bitte geben Sie so eine Funktion auf gar keinen Fall für
        unberechtigte Nutzer frei. Setzen Sie die entsprechenden berechtigten
        Telefone in einen eigenen Context und bauen Sie vielleicht auch noch
        eine PIN-Abfrage in den Wählplan.</para>
      </important>

      <para>Die Telefone sind einer solchen "Attacke" natürlich nicht ganz
      ungeschützt ausgesetzt. Wird in den erweiterten Einstellungen des
      Telefons "Authentifikation für SIP Reboot" auf "An" geschaltet, lässt
      sich ein Telefon auf diese einfache Art und Weise nicht mehr
      zurücksetzen. Der dazugehörige Parameter für eine automatische
      Konfiguration lautet "<code>challenge_reboot: on</code>".</para>
    </section>
  </section>

  <section id="snom-weitere-applikationen">
    <title>Weitere verfügbare Applikationen</title>

    <para>Es gibt bereits einige frei verfügbare Applikationen, vor allem im
    Bereich der Telefonbücher. Zwei empfehlenswerte Implementationen finden
    sich hier:</para>

    <itemizedlist>
      <listitem>
        <para>Phonebook for snom phones: Ein Telefonbuch-Browser mit
        Suchfunkton und LDAP-, Datei- oder SQL-Anbindung für die Telefondaten
        (<ulink url="???">http://www.bevuta.com/phoneapps/</ulink>)</para>
      </listitem>

      <listitem>
        <para>IPPhone XML library for PHP: Sehr empfehlenswert, eigentlich
        eine Bibliothek zur Entwicklung von PHP-basierten Telefonbüchern auch
        für andere Telefontypen wie Cisco, aber mit einem Beispiel für einen
        T-9 geführten Telefonbuch-Browser mit Datei- oder SQL-Anbindung für
        die Telefondaten (<ulink
        url="???">http://swt.uni-stuttgart.de/~langausd/asterisk/</ulink>).</para>
      </listitem>
    </itemizedlist>

    <para>Vor allem letzteres Beispiel ist eine sehr gute Grundlage für
    zentrale Telefonbücher. Die T-9-Führung passt ideal auf das Snom-Telefon,
    das über keine echte alphanummerische Tastatur verfügt, wie viele
    Systemtelefone. Wer seine Benutzerdaten bereits in einem zentralen
    LDAP-Server verwaltet, sollte sich dagegen die erste Lösung genauer
    ansehen.</para>
  </section>
</section>